<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Workouts | Gymcyclopedia</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js for Progress Tracking -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Fonts: Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JavaScript Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Base styles matching the main app */
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Poppins', 'Inter', sans-serif;
      font-weight: 400;
      letter-spacing: 0.3px;
      background-color: #000;
      color: #fff;
    }

    /* Navbar styling */
    .navbar-brand {
      font-size: 1.4rem;
      letter-spacing: 2px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .navbar-dark .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }
    .navbar-dark .navbar-nav .nav-link:hover,
    .navbar-dark .navbar-nav .nav-link.active {
      color: #fff;
    }

    /* Card styling */
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.1);
    }

    /* Button styling */
    .btn-primary {
      background: linear-gradient(45deg, #007bff, #00d4ff);
      border: none;
      font-weight: 600;
      letter-spacing: 0.5px;
      padding: 0.75rem 1.5rem;
    }

    .btn-outline-light {
      border: 2px solid rgba(255, 255, 255, 0.3);
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-light:hover {
      background-color: #fff;
      color: #000;
      transform: translateY(-2px);
    }

    /* Exercise cards */
    .exercise-card {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .exercise-card:hover {
      border-color: #007bff;
      box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
    }

    .exercise-card.selected {
      border-color: #007bff;
      background: rgba(0, 123, 255, 0.1);
    }

    /* Modal styling */
    .modal-content {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .form-control, .form-select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      border-radius: 8px;
    }

    .form-control:focus, .form-select:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      color: #fff;
    }

    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Tab styling */
    .nav-tabs {
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .nav-tabs .nav-link {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 600;
      padding: 1rem 1.5rem;
    }

    .nav-tabs .nav-link.active {
      background: rgba(0, 123, 255, 0.2);
      color: #fff;
      border-bottom: 3px solid #007bff;
    }

    /* Workout session styling */
    .workout-session {
      background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 212, 255, 0.1));
      border-left: 4px solid #007bff;
    }

    /* Exercise category badges */
    .category-badge {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .category-badge:hover,
    .category-badge.active {
      background: #007bff;
      border-color: #007bff;
      color: #fff;
    }

    /* Achievement System Styling */
    .achievement-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .achievement-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
    }

    .achievement-card.unlocked {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
      border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .achievement-card.locked {
      background: rgba(108, 117, 125, 0.1);
      border: 1px solid rgba(108, 117, 125, 0.3);
    }

    .achievement-celebration {
      background: linear-gradient(135deg, #007bff, #00d4ff);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 123, 255, 0.3);
    }

    .achievement-glow {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Timer styling */
    .timer-circle {
      filter: drop-shadow(0 0 10px rgba(0, 123, 255, 0.3));
    }

    /* Workout session enhanced styling */
    .workout-session-card {
      background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 212, 255, 0.1));
      border: 1px solid rgba(0, 123, 255, 0.2);
      border-radius: 15px;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .workout-session-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
    }

    /* Analytics Chart Container */
    .chart-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .achievement-icon {
      animation: pulse 2s infinite;
    }

    /* Loading state */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Enhanced Typography & Colors */
    .text-light-enhanced {
      color: rgba(255, 255, 255, 0.95) !important;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .text-soft-white {
      color: rgba(255, 255, 255, 0.98) !important;
      font-weight: 500;
    }

    .text-premium-gray {
      color: rgba(255, 255, 255, 0.92) !important;
      font-weight: 500;
    }

    .text-elegant {
      color: rgba(255, 255, 255, 0.98) !important;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    
    /* Enhanced text readability */
    .text-muted {
      color: #e0e0e0 !important;
    }
    
    small, .small {
      color: #d0d0d0 !important;
    }
    
    p, span, li, div {
      color: rgba(255, 255, 255, 0.95) !important;
    }

    /* Enhanced Card Styling */
    .card {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      backdrop-filter: blur(15px);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 40px rgba(255, 255, 255, 0.15);
      border-color: rgba(0, 123, 255, 0.3);
    }

    /* Premium Button Styling */
    .btn-primary {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 50%, #004085 100%);
      border: none;
      font-weight: 600;
      letter-spacing: 0.8px;
      padding: 0.85rem 2rem;
      border-radius: 12px;
      text-transform: uppercase;
      font-size: 0.9rem;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0056b3 0%, #004085 50%, #002752 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
    }

    .btn-outline-light {
      border: 2px solid rgba(255, 255, 255, 0.4);
      font-weight: 600;
      letter-spacing: 0.5px;
      padding: 0.75rem 1.8rem;
      border-radius: 12px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
    }

    .btn-outline-light:hover {
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      color: #000;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
    }

    /* Enhanced Hero Section */
    .hero-section {
      background: linear-gradient(135deg, rgba(0, 123, 255, 0.12) 0%, rgba(0, 212, 255, 0.08) 50%, rgba(108, 117, 125, 0.05) 100%);
      border-radius: 20px;
      padding: 4rem 2rem;
      text-align: center;
      margin-bottom: 3rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    /* Progress Tracking Styles */
    .achievement-badge {
      background: linear-gradient(135deg, #ffd700, #ffed4a);
      color: #000;
      padding: 0.5rem;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
      min-width: 80px;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
      transition: transform 0.3s ease;
    }

    .achievement-badge:hover {
      transform: translateY(-3px);
    }

    .achievement-badge.locked {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.5);
      box-shadow: none;
    }

    .progress-photo {
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      aspect-ratio: 1;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      background: #2a2a2a;
    }

    .progress-photo:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .photo-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .progress-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .progress-photo:hover img {
      transform: scale(1.05);
    }

    .photo-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.9));
      color: white;
      padding: 20px 10px 10px;
      transition: opacity 0.3s ease;
    }

    .photo-info {
      text-align: center;
    }

    .photo-date {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .photo-category {
      display: block;
      font-size: 0.75rem;
      color: #ccc;
      text-transform: capitalize;
    }

    .empty-state {
      padding: 2rem;
      border: 2px dashed #444;
      border-radius: 15px;
      background: rgba(255,255,255,0.02);
    }

    .empty-state i {
      opacity: 0.6;
    }

    .photo-viewer {
      background: #000;
      border-radius: 8px;
      padding: 10px;
      display: inline-block;
    }

    .photo-details {
      text-align: left;
    }

    /* Chart container styling */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Modal styling for progress features */
    .progress-modal .modal-content {
      border-radius: 20px;
    }

    .file-upload-area {
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-upload-area:hover {
      border-color: #007bff;
      background: rgba(0, 123, 255, 0.1);
    }

    .file-upload-area.drag-over {
      border-color: #28a745;
      background: rgba(40, 167, 69, 0.1);
      transform: scale(1.02);
    }

    /* Stats styling */
    .stat-card {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
      border-left: 4px solid #28a745;
    }

    .progress {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      height: 8px;
    }

    .progress-bar {
      background: linear-gradient(45deg, #28a745, #20c997);
      border-radius: 10px;
    }

    /* Workout Template Styling */
    .template-card {
      cursor: pointer;
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
    }

    .template-card:hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 15px 50px rgba(0, 123, 255, 0.2);
    }

    .template-card .template-header {
      background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 212, 255, 0.1));
      padding: 1.5rem;
      border-radius: 16px 16px 0 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .template-card.beginner .template-header {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
    }

    .template-card.intermediate .template-header {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 143, 0, 0.1));
    }

    .template-card.advanced .template-header {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(255, 0, 123, 0.1));
    }

    .template-level-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .template-level-badge.beginner {
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .template-level-badge.intermediate {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .template-level-badge.advanced {
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .template-stats {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .template-stat {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .exercise-preview {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .template-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .btn-template-start {
      background: linear-gradient(135deg, #28a745, #20c997);
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .btn-template-start:hover {
      background: linear-gradient(135deg, #20c997, #17a2b8);
      transform: translateY(-2px);
      color: white;
    }

    .btn-template-copy {
      background: rgba(0, 123, 255, 0.1);
      border: 1px solid rgba(0, 123, 255, 0.3);
      color: #007bff;
      font-weight: 600;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .btn-template-copy:hover {
      background: rgba(0, 123, 255, 0.2);
      color: #007bff;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-transparent py-3 border-bottom border-secondary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">GYMCYCLOPEDIA</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
        <ul class="navbar-nav mb-2 mb-lg-0">
                      <li class="nav-item"><a class="nav-link active" href="/workouts.html">Workouts</a></li>
          <li class="nav-item"><a class="nav-link" href="/ai-coaching.html">AI Coaching</a></li>
          <li class="nav-item"><a class="nav-link" href="/nutrition-recovery.html">Nutrition & Recovery</a></li>
          <li class="nav-item"><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a class="nav-link" href="/support.html">Support & Contact</a></li>
        </ul>
      </div>

      <div class="d-none d-lg-flex">
        <span class="navbar-text me-3">Welcome, <span id="user-name">User</span></span>
        <button id="logoutBtn" class="btn btn-outline-light">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-lg-8">
        <h1 class="display-5 fw-bold mb-2">üí™ Workout Central</h1>
        <p class="lead text-light-enhanced">Create, track, and conquer your fitness goals</p>
      </div>
      <div class="col-lg-4 text-lg-end">
        <button class="btn btn-primary btn-lg me-2" data-bs-toggle="modal" data-bs-target="#createWorkoutModal">
          ‚ûï Create Workout
        </button>
        <button class="btn btn-outline-light" onclick="showStats()">
          üìä Stats
        </button>
      </div>
    </div>

    <!-- Workout Tabs -->
    <ul class="nav nav-tabs mb-4" id="workoutTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button">
          üéØ Workout Templates
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="library-tab" data-bs-toggle="tab" data-bs-target="#library" type="button">
          üèãÔ∏è Exercise Library
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="workouts-tab" data-bs-toggle="tab" data-bs-target="#workouts" type="button">
          üìù My Workouts
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress" type="button">
          üìä Progress Tracking
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">
          üìà Workout History
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="smart-notifications-tab" data-bs-toggle="tab" data-bs-target="#smart-notifications" type="button">
          üîî Smart Alerts
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="workoutTabContent">
      <!-- Workout Templates Tab -->
      <div class="tab-pane fade show active" id="templates" role="tabpanel">
        <!-- Template Level Filter -->
        <div class="row mb-4">
          <div class="col-12">
            <h5 class="mb-3">Choose Your Level:</h5>
            <div class="d-flex flex-wrap gap-3" id="templateLevelFilter">
              <span class="category-badge active" data-level="all">All Levels</span>
              <span class="category-badge" data-level="beginner">üü¢ Beginner</span>
              <span class="category-badge" data-level="intermediate">üü° Intermediate</span>
              <span class="category-badge" data-level="advanced">üî¥ Advanced</span>
            </div>
          </div>
        </div>

        <!-- Template Cards -->
        <div class="row" id="workoutTemplates">
          <!-- Placeholder content until JavaScript loads -->
          <div class="col-12 text-center mb-4">
            <p class="text-soft-white">Loading workout templates...</p>
          </div>
        </div>
      </div>

      <!-- Exercise Library Tab -->
      <div class="tab-pane fade" id="library" role="tabpanel">
        <!-- Category Filter -->
        <div class="row mb-4">
          <div class="col-12">
            <h5 class="mb-3">Filter by Category:</h5>
            <div class="d-flex flex-wrap gap-2" id="categoryFilter">
              <span class="category-badge active" data-category="all">All</span>
              <span class="category-badge" data-category="chest">Chest</span>
              <span class="category-badge" data-category="back">Back</span>
              <span class="category-badge" data-category="shoulders">Shoulders</span>
              <span class="category-badge" data-category="arms">Arms</span>
              <span class="category-badge" data-category="legs">Legs</span>
              <span class="category-badge" data-category="core">Core</span>
              <span class="category-badge" data-category="cardio">Cardio</span>
            </div>
          </div>
        </div>

        <!-- Exercise Cards -->
        <div class="row" id="exerciseLibrary">
          <!-- Placeholder content until JavaScript loads -->
          <div class="col-12 text-center mb-4">
            <p class="text-soft-white">Loading exercise library...</p>
          </div>
        </div>
      </div>

      <!-- My Workouts Tab -->
      <div class="tab-pane fade" id="workouts" role="tabpanel">
        <div class="row" id="myWorkouts">
          <div class="col-12 text-center">
            <p class="text-soft-white">No workouts created yet. Click "Create Workout" to get started!</p>
          </div>
        </div>
      </div>

      <!-- Progress Tracking Tab -->
      <div class="tab-pane fade" id="progress" role="tabpanel">
        <!-- Progress Overview Cards -->
        <div class="row mb-4">
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
              <div class="card-body">
                <h6 class="card-title mb-1">üí™ Total Workouts</h6>
                <h2 class="mb-0 text-light-enhanced" id="totalWorkoutsCount">0</h2>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
              <div class="card-body">
                <h6 class="card-title mb-1">‚è±Ô∏è Total Time</h6>
                <h2 class="mb-0 text-light-enhanced" id="totalTimeSpent">0h</h2>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
              <div class="card-body">
                <h6 class="card-title mb-1">üî• Current Streak</h6>
                <h2 class="mb-0 text-light-enhanced" id="currentStreak">0</h2>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
              <div class="card-body">
                <h6 class="card-title mb-1">üìà Personal Records</h6>
                <h2 class="mb-0 text-light-enhanced" id="personalRecords">0</h2>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress Charts Row -->
        <div class="row mb-4">
          <!-- Workout Frequency Chart -->
          <div class="col-lg-6 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">üìä Weekly Workout Frequency</h5>
              </div>
              <div class="card-body">
                <canvas id="workoutFrequencyChart" height="200"></canvas>
              </div>
            </div>
          </div>
          
          <!-- Body Measurements Chart -->
          <div class="col-lg-6 mb-4">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìè Body Measurements</h5>
                <button class="btn btn-sm btn-outline-light" onclick="addBodyMeasurement()">+ Add Data</button>
              </div>
              <div class="card-body">
                <canvas id="bodyMeasurementsChart" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Strength Progress Row -->
        <!-- Analytics Charts Row -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìä Workout Analytics</h5>
                <button class="btn btn-sm btn-outline-light" onclick="refreshAnalyticsCharts()">üîÑ Refresh</button>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-lg-6 mb-4">
                    <h6 class="text-light-enhanced mb-3">üìà Workout Frequency (Last 30 Days)</h6>
                    <div style="position: relative; height: 250px;">
                      <canvas id="workoutFrequencyChart"></canvas>
                    </div>
                  </div>
                  <div class="col-lg-6 mb-4">
                    <h6 class="text-light-enhanced mb-3">üéØ Exercise Categories</h6>
                    <div style="position: relative; height: 250px;">
                      <canvas id="exerciseCategoryChart"></canvas>
                    </div>
                  </div>
                  <div class="col-12">
                    <h6 class="text-light-enhanced mb-3">üöÄ Progress Over Time (12 Weeks)</h6>
                    <div style="position: relative; height: 300px;">
                      <canvas id="progressChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Achievement & Strength Row -->
        <div class="row mb-4">
          <!-- Achievement Badges -->
          <div class="col-lg-6 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">üèÜ Achievement Badges</h5>
              </div>
              <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="achievementBadges">
                  <!-- Badges will be populated here -->
                  <div class="text-center text-muted">
                    <p>Loading achievements...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Strength Progress Chart -->
          <div class="col-lg-6 mb-4">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üí™ Strength Progression</h5>
                <button class="btn btn-sm btn-outline-light" onclick="addPersonalRecord()">+ Add PR</button>
              </div>
              <div class="card-body">
                <canvas id="strengthProgressChart" height="150"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress Photos Row -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üì∏ Progress Photos</h5>
                <button class="btn btn-sm btn-outline-light" onclick="addProgressPhoto()">+ Add Photo</button>
              </div>
              <div class="card-body">
                <div id="progressPhotos" class="row">
                  <!-- Progress photos will be displayed here -->
                  <div class="col-12 text-center">
                    <p class="text-soft-white">No progress photos yet. Add your first photo to track visual progress!</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Workout History Tab -->
      <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="row" id="workoutHistory">
          <div class="col-12 text-center">
            <p class="text-soft-white">No workout history yet. Complete some workouts to see your progress!</p>
          </div>
        </div>
      </div>



      <!-- Smart Notifications Tab -->
      <div class="tab-pane fade" id="smart-notifications" role="tabpanel">
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">üîî Smart Notification Settings</h5>
              </div>
              <div class="card-body">
                <!-- Workout Reminders -->
                <div class="mb-4">
                  <h6 class="text-light-enhanced mb-3">üí™ Workout Reminders</h6>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="dailyWorkoutReminder">
                    <label class="form-check-label" for="dailyWorkoutReminder">
                      Daily workout reminders
                    </label>
                  </div>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="restDayReminder">
                    <label class="form-check-label" for="restDayReminder">
                      Rest day suggestions
                    </label>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Preferred workout time</label>
                      <input type="time" class="form-control" id="workoutTime" value="18:00">
                    </div>
                  </div>
                </div>

                <!-- Motivation Messages -->
                <div class="mb-4">
                  <h6 class="text-light-enhanced mb-3">üéØ Motivation & Goals</h6>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="motivationMessages">
                    <label class="form-check-label" for="motivationMessages">
                      Daily motivation messages
                    </label>
                  </div>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="streakReminders">
                    <label class="form-check-label" for="streakReminders">
                      Streak milestone celebrations
                    </label>
                  </div>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="prCelebrations">
                    <label class="form-check-label" for="prCelebrations">
                      Personal record celebrations
                    </label>
                  </div>
                </div>

                <!-- Progress Reminders -->
                <div class="mb-4">
                  <h6 class="text-light-enhanced mb-3">üìä Progress Tracking</h6>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="progressPhotoReminder">
                    <label class="form-check-label" for="progressPhotoReminder">
                      Weekly progress photo reminders
                    </label>
                  </div>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="measurementReminder">
                    <label class="form-check-label" for="measurementReminder">
                      Bi-weekly measurement reminders
                    </label>
                  </div>
                </div>

                <!-- Hydration & Nutrition -->
                <div class="mb-4">
                  <h6 class="text-light-enhanced mb-3">ü•ó Health & Wellness</h6>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="hydrationReminder">
                    <label class="form-check-label" for="hydrationReminder">
                      Hydration reminders
                    </label>
                  </div>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="mealPlanReminder">
                    <label class="form-check-label" for="mealPlanReminder">
                      Meal planning reminders
                    </label>
                  </div>
                </div>

                <div class="text-center">
                  <button class="btn btn-primary me-2" onclick="saveNotificationSettings()">
                    üíæ Save Notification Settings
                  </button>
                  <button class="btn btn-outline-info" onclick="testNotification()">
                    üß™ Test Notification
                  </button>
                </div>

                <!-- Active Notifications Display -->
                <div class="mt-4" id="activeNotifications">
                  <h6 class="text-light-enhanced mb-3">üîî Recent Notifications</h6>
                  <div id="notificationsList">
                    <p class="text-muted">No recent notifications</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Workout Modal -->
  <div class="modal fade" id="createWorkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üèãÔ∏è Create New Workout</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createWorkoutForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Workout Name</label>
                <input type="text" class="form-control" id="workoutName" placeholder="e.g., Push Day" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" id="workoutCategory" required>
                  <option value="">Select category</option>
                  <option value="push">Push (Chest, Shoulders, Triceps)</option>
                  <option value="pull">Pull (Back, Biceps)</option>
                  <option value="legs">Legs</option>
                  <option value="upper">Upper Body</option>
                  <option value="lower">Lower Body</option>
                  <option value="full">Full Body</option>
                  <option value="cardio">Cardio</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Description (Optional)</label>
              <textarea class="form-control" id="workoutDescription" rows="2" placeholder="Brief description of this workout"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Select Exercises</label>
              <div id="exerciseSelection" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                <!-- Exercise selection will be populated here -->
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveWorkoutBtn">üíæ Save Workout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Workout Session Modal -->
  <div class="modal fade" id="workoutSessionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üèãÔ∏è <span id="sessionWorkoutName">Workout Session</span></h5>
          <div class="d-flex align-items-center">
            <span class="badge bg-success me-2">‚è±Ô∏è <span id="sessionTimer">00:00</span></span>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
        </div>
        <div class="modal-body">
          <!-- Enhanced Workout Timer -->
          <div class="text-center mb-4" id="workoutTimerSection">
            <!-- Circular Progress Timer -->
            <div class="position-relative d-inline-block mb-3">
              <svg width="150" height="150" class="timer-circle">
                <circle cx="75" cy="75" r="65" fill="none" stroke="#333" stroke-width="10"/>
                <circle cx="75" cy="75" r="65" fill="none" stroke="#007bff" stroke-width="10" 
                        stroke-linecap="round" id="timerProgress" 
                        style="stroke-dasharray: 408; stroke-dashoffset: 408; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 1s linear;"/>
              </svg>
              <div class="position-absolute top-50 start-50 translate-middle text-center">
                <div class="h2 text-light mb-0 fw-bold" id="timerDisplay">0:00</div>
                <small class="text-muted fw-bold" id="timerLabel">Ready</small>
                <div class="small text-info" id="currentExerciseTimer" style="display: none;">Push-ups</div>
              </div>
            </div>
            
            <!-- Timer Controls -->
            <div class="btn-group mb-3" role="group">
              <button class="btn btn-success btn-sm" id="startTimerBtn" onclick="startExerciseTimer()">
                ‚ñ∂Ô∏è Start Timer
              </button>
              <button class="btn btn-warning btn-sm" id="pauseTimerBtn" onclick="pauseExerciseTimer()" style="display: none;">
                ‚è∏Ô∏è Pause
              </button>
              <button class="btn btn-danger btn-sm" onclick="stopExerciseTimer()">
                ‚èπÔ∏è Stop
              </button>
              <button class="btn btn-info btn-sm" onclick="skipExerciseTimer()">
                ‚è≠Ô∏è Skip
              </button>
            </div>
            
            <!-- Timer Settings -->
            <div class="row mb-3">
              <div class="col-4">
                <label class="form-label small">Exercise (sec)</label>
                <input type="number" class="form-control form-control-sm" id="exerciseTime" value="45" min="10" max="300">
              </div>
              <div class="col-4">
                <label class="form-label small">Rest (sec)</label>
                <input type="number" class="form-control form-control-sm" id="restTime" value="90" min="10" max="300">
              </div>
              <div class="col-4">
                <label class="form-label small">Sets</label>
                <input type="number" class="form-control form-control-sm" id="currentSets" value="3" min="1" max="10">
              </div>
            </div>

            <!-- Current Set Info -->
            <div class="alert alert-info mb-3" id="setInfo">
              <strong>Set 1 of 3</strong> | Next: Rest Period
            </div>
          </div>

          <div id="sessionExercises">
            <!-- Session exercises will be populated here -->
          </div>
          <div class="text-center mt-4">
            <button class="btn btn-success btn-lg" id="completeWorkoutBtn" onclick="completeCurrentSession()">
              ‚úÖ Complete Workout
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Body Measurements Modal -->
  <div class="modal fade progress-modal" id="bodyMeasurementModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üìè Add Body Measurement</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="bodyMeasurementForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Weight (lbs)</label>
                <input type="number" step="0.1" class="form-control" id="bodyWeight" placeholder="e.g., 150.5">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Body Fat %</label>
                <input type="number" step="0.1" class="form-control" id="bodyFat" placeholder="e.g., 15.2">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Muscle Mass (lbs)</label>
                <input type="number" step="0.1" class="form-control" id="muscleMass" placeholder="e.g., 130.0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="measurementDate" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Chest (inches)</label>
                <input type="number" step="0.1" class="form-control" id="chestMeasurement" placeholder="e.g., 40.0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Waist (inches)</label>
                <input type="number" step="0.1" class="form-control" id="waistMeasurement" placeholder="e.g., 32.0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Arms (inches)</label>
                <input type="number" step="0.1" class="form-control" id="armMeasurement" placeholder="e.g., 14.5">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveBodyMeasurement()">üíæ Save Measurement</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Personal Record Modal -->
  <div class="modal fade progress-modal" id="personalRecordModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üí™ Add Personal Record</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="personalRecordForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Exercise</label>
                <select class="form-select" id="prExercise" required>
                  <option value="">Select exercise</option>
                  <!-- Will be populated with exercises -->
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Weight (lbs)</label>
                <input type="number" step="0.5" class="form-control" id="prWeight" placeholder="e.g., 225" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Reps</label>
                <input type="number" class="form-control" id="prReps" placeholder="e.g., 5" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="prDate" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes (Optional)</label>
              <textarea class="form-control" id="prNotes" rows="2" placeholder="Any notes about this PR..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="savePersonalRecord()">üèÜ Save PR</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Photo Modal -->
  <div class="modal fade progress-modal" id="progressPhotoModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üì∏ Add Progress Photo</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="progressPhotoForm">
            <div class="mb-3">
              <label class="form-label">Photo</label>
              <div class="file-upload-area" onclick="document.getElementById('photoUpload').click()" 
                   ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <p class="mb-0">Click to upload or drag & drop</p>
                <small class="text-muted">Supports: JPG, PNG, GIF (Max 5MB)</small>
              </div>
              <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="previewPhoto(this)">
            </div>
            <div class="mb-3" id="photoPreview" style="display: none;">
              <img id="previewImage" class="img-fluid rounded" style="max-height: 200px;">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="photoDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" id="photoCategory" required>
                  <option value="">Select category</option>
                  <option value="front">Front View</option>
                  <option value="side">Side View</option>
                  <option value="back">Back View</option>
                  <option value="pose">Pose/Flex</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes (Optional)</label>
              <textarea class="form-control" id="photoNotes" rows="2" placeholder="Any notes about this photo..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveProgressPhoto()">üì∏ Save Photo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js for Analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ========================================
    // SERVICE WORKER REGISTRATION
    // ========================================
    
    // Register service worker for push notifications
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('‚úÖ Service Worker registered:', registration);
        })
        .catch(error => {
          console.error('‚ùå Service Worker registration failed:', error);
        });
    }

    // ========================================
    // SUPABASE CONFIGURATION
    // ========================================

    // Supabase configuration
    const SUPABASE_URL = 'https://stojhqobywrvkjaabcvq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0b2pocW9ieXdydmtqYWFiY3ZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyMDcwMDEsImV4cCI6MjA2NTc4MzAwMX0.JQeFsT3nUFMpQ1Tz9uYBnZ3IuE_gBK9P9Du0Igo7Hsg';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global variables
    let currentUser = null;
    let exerciseLibrary = [];
    let userWorkouts = [];
    let workoutHistory = [];
    let currentSession = null;
    let sessionTimer = null;
    let sessionStartTime = null;

    // Toast notification function
    function showToast(message, type = 'info') {
      // Create toast container if it doesn't exist
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
      }

      // Create toast element
      const toastId = 'toast-' + Date.now();
      const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'primary'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;

      toastContainer.insertAdjacentHTML('beforeend', toastHTML);

      // Show toast
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: type === 'error' ? 5000 : 3000
      });
      
      toast.show();

      // Remove toast element after it's hidden
      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    }

    // Initialize exercise library immediately with fallback data
    exerciseLibrary = [
      // Chest
      { id: 1, name: "Push-ups", category: "chest", description: "Classic bodyweight chest exercise", equipment: "None", difficulty: "Beginner" },
      { id: 2, name: "Bench Press", category: "chest", description: "Barbell chest press", equipment: "Barbell", difficulty: "Intermediate" },
      { id: 3, name: "Dumbbell Flyes", category: "chest", description: "Chest isolation exercise", equipment: "Dumbbells", difficulty: "Intermediate" },
      
      // Back
      { id: 4, name: "Pull-ups", category: "back", description: "Upper body pulling exercise", equipment: "Pull-up Bar", difficulty: "Intermediate" },
      { id: 5, name: "Deadlifts", category: "back", description: "Compound pulling movement", equipment: "Barbell", difficulty: "Advanced" },
      { id: 6, name: "Bent-over Rows", category: "back", description: "Horizontal pulling exercise", equipment: "Barbell", difficulty: "Intermediate" },
      
      // Shoulders
      { id: 7, name: "Overhead Press", category: "shoulders", description: "Vertical pressing movement", equipment: "Barbell", difficulty: "Intermediate" },
      { id: 8, name: "Lateral Raises", category: "shoulders", description: "Side deltoid isolation", equipment: "Dumbbells", difficulty: "Beginner" },
      { id: 9, name: "Face Pulls", category: "shoulders", description: "Rear deltoid exercise", equipment: "Cable", difficulty: "Beginner" },
      
      // Arms
      { id: 10, name: "Bicep Curls", category: "arms", description: "Bicep isolation exercise", equipment: "Dumbbells", difficulty: "Beginner" },
      { id: 11, name: "Tricep Dips", category: "arms", description: "Tricep bodyweight exercise", equipment: "Bench", difficulty: "Intermediate" },
      { id: 12, name: "Hammer Curls", category: "arms", description: "Neutral grip bicep curls", equipment: "Dumbbells", difficulty: "Beginner" },
      
      // Legs
      { id: 13, name: "Squats", category: "legs", description: "Fundamental leg exercise", equipment: "Bodyweight/Barbell", difficulty: "Beginner" },
      { id: 14, name: "Lunges", category: "legs", description: "Unilateral leg exercise", equipment: "Bodyweight/Dumbbells", difficulty: "Beginner" },
      { id: 15, name: "Romanian Deadlifts", category: "legs", description: "Hip hinge movement", equipment: "Barbell", difficulty: "Intermediate" },
      
      // Core
      { id: 16, name: "Plank", category: "core", description: "Isometric core exercise", equipment: "None", difficulty: "Beginner" },
      { id: 17, name: "Russian Twists", category: "core", description: "Rotational core exercise", equipment: "Medicine Ball", difficulty: "Beginner" },
      { id: 18, name: "Mountain Climbers", category: "core", description: "Dynamic core exercise", equipment: "None", difficulty: "Intermediate" },
      
      // Cardio
      { id: 19, name: "Burpees", category: "cardio", description: "Full body cardio exercise", equipment: "None", difficulty: "Intermediate" },
      { id: 20, name: "Jumping Jacks", category: "cardio", description: "Basic cardio movement", equipment: "None", difficulty: "Beginner" },
      { id: 21, name: "High Knees", category: "cardio", description: "Running in place variation", equipment: "None", difficulty: "Beginner" }
    ];

    console.log('üìö Exercise library initialized with', exerciseLibrary.length, 'exercises');

    // Pre-built workout templates (moved to top for immediate availability)
    const workoutTemplates = [
      // BEGINNER TEMPLATES
      {
        id: 'template_beginner_full_body',
        name: 'Full Body Starter',
        level: 'beginner',
        category: 'full_body',
        duration: '30-45 min',
        exercises: 6,
        description: 'Perfect introduction to strength training. Covers all major muscle groups with basic movements.',
        exerciseIds: [1, 13, 16, 4, 7, 20], // Push-ups, Squats, Plank, Pull-ups, Overhead Press, Jumping Jacks
        exerciseDetails: [
          { sets: 2, reps: '8-12', rest: 60 },
          { sets: 2, reps: '10-15', rest: 60 },
          { sets: 2, reps: '20-30 sec', rest: 60 },
          { sets: 2, reps: '8-12', rest: 60 },
          { sets: 2, reps: '8-10', rest: 60 },
          { sets: 1, reps: '10 min', rest: 0 }
        ]
      },
      {
        id: 'template_beginner_upper',
        name: 'Upper Body Basics',
        level: 'beginner',
        category: 'upper_body',
        duration: '25-35 min',
        exercises: 5,
        description: 'Build upper body strength with fundamental pushing and pulling movements.',
        exerciseIds: [1, 4, 7, 11, 2], // Push-ups, Pull-ups, Overhead Press, Tricep Dips, Bench Press
        exerciseDetails: [
          { sets: 2, reps: '5-10', rest: 60 },
          { sets: 2, reps: '8-12', rest: 60 },
          { sets: 2, reps: '6-10', rest: 60 },
          { sets: 2, reps: '5-8', rest: 60 },
          { sets: 2, reps: '10-15', rest: 60 }
        ]
      },

      // INTERMEDIATE TEMPLATES
      {
        id: 'template_intermediate_push_pull',
        name: 'Push/Pull Split',
        level: 'intermediate',
        category: 'upper_body',
        duration: '45-60 min',
        exercises: 8,
        description: 'Classic push/pull workout focusing on upper body strength and muscle development.',
        exerciseIds: [2, 1, 7, 10, 4, 6, 11, 16], // Bench Press, Push-ups, Overhead Press, Bicep Curls, Pull-ups, Bent-over Row, Tricep Dips, Plank
        exerciseDetails: [
          { sets: 3, reps: '8-12', rest: 90 },
          { sets: 3, reps: '10-15', rest: 60 },
          { sets: 3, reps: '8-12', rest: 90 },
          { sets: 3, reps: '10-15', rest: 60 },
          { sets: 3, reps: '8-12', rest: 90 },
          { sets: 3, reps: '8-12', rest: 90 },
          { sets: 3, reps: '8-15', rest: 60 },
          { sets: 3, reps: '30-60 sec', rest: 60 }
        ]
      },
      {
        id: 'template_intermediate_legs',
        name: 'Leg Power Builder',
        level: 'intermediate',
        category: 'legs',
        duration: '40-55 min',
        exercises: 6,
        description: 'Comprehensive lower body workout for strength and muscle development.',
        exerciseIds: [13, 5, 14, 21, 17, 15], // Squats, Deadlifts, Lunges, High Knees, Russian Twists, Romanian Deadlifts
        exerciseDetails: [
          { sets: 4, reps: '8-12', rest: 120 },
          { sets: 4, reps: '6-10', rest: 120 },
          { sets: 3, reps: '10-12 each leg', rest: 90 },
          { sets: 3, reps: '12-20', rest: 60 },
          { sets: 3, reps: '15-25', rest: 60 },
          { sets: 3, reps: '10-15', rest: 90 }
        ]
      },

      // ADVANCED TEMPLATES
      {
        id: 'template_advanced_strength',
        name: 'Strength & Power',
        level: 'advanced',
        category: 'strength',
        duration: '60-75 min',
        exercises: 7,
        description: 'High-intensity workout focusing on maximum strength and power development.',
        exerciseIds: [2, 5, 7, 4, 13, 16, 19], // Bench Press, Deadlifts, Overhead Press, Pull-ups, Squats, Plank, Burpees
        exerciseDetails: [
          { sets: 5, reps: '3-6', rest: 180 },
          { sets: 5, reps: '3-6', rest: 180 },
          { sets: 4, reps: '6-8', rest: 120 },
          { sets: 4, reps: '6-10', rest: 120 },
          { sets: 4, reps: '6-10', rest: 120 },
          { sets: 3, reps: '45-90 sec', rest: 90 },
          { sets: 1, reps: '15 min', rest: 0 }
        ]
      },
      {
        id: 'template_advanced_hiit',
        name: 'HIIT Circuit Blast',
        level: 'advanced',
        category: 'cardio',
        duration: '30-45 min',
        exercises: 8,
        description: 'High-intensity interval circuit combining strength and cardio for maximum results.',
        exerciseIds: [1, 13, 19, 16, 18, 17, 14, 20], // Push-ups, Squats, Burpees, Plank, Mountain Climbers, Russian Twists, Lunges, Jumping Jacks
        exerciseDetails: [
          { sets: 4, reps: '30 sec on/15 sec off', rest: 0 },
          { sets: 4, reps: '30 sec on/15 sec off', rest: 0 },
          { sets: 4, reps: '30 sec on/15 sec off', rest: 0 },
          { sets: 4, reps: '30 sec on/15 sec off', rest: 0 },
          { sets: 4, reps: '30 sec on/15 sec off', rest: 0 },
          { sets: 4, reps: '30 sec on/15 sec off', rest: 0 },
          { sets: 4, reps: '30 sec on/15 sec off', rest: 0 },
          { sets: 1, reps: '5 min cooldown', rest: 0 }
        ]
      }
    ];

    console.log('üìã Workout templates initialized:', workoutTemplates.length, 'templates');

    // ==============================================
    // PROGRESS TRACKING DATA & VARIABLES
    // ==============================================

    let bodyMeasurements = [];
    let personalRecords = [];
    let progressPhotos = [];
    let workoutFrequencyChart = null;
    let bodyMeasurementsChart = null;
    let strengthProgressChart = null;

    // Achievement system
    const achievements = [
      { id: 'first_workout', name: 'üèÅ First Step', description: 'Complete your first workout', condition: (data) => data.totalWorkouts >= 1 },
      { id: 'week_streak', name: 'üî• Week Warrior', description: 'Workout for 7 days straight', condition: (data) => data.currentStreak >= 7 },
      { id: 'month_consistent', name: 'üìÖ Monthly Master', description: 'Workout 20+ times in a month', condition: (data) => data.monthlyWorkouts >= 20 },
      { id: 'hundred_club', name: 'üíØ Century Club', description: 'Complete 100 workouts', condition: (data) => data.totalWorkouts >= 100 },
      { id: 'pr_setter', name: 'üí™ PR Crusher', description: 'Set 10 personal records', condition: (data) => data.totalPRs >= 10 },
      { id: 'photo_tracker', name: 'üì∏ Progress Photographer', description: 'Upload 5 progress photos', condition: (data) => data.totalPhotos >= 5 },
      { id: 'weight_warrior', name: '‚öñÔ∏è Weight Tracker', description: 'Log weight for 30 days', condition: (data) => data.weightEntries >= 30 }
    ];

    let unlockedAchievements = [];

    // Immediate test function to verify JavaScript is working
    function testContentLoading() {
      console.log('üß™ Testing content loading...');
      
      // Test template container
      const templateContainer = document.getElementById('workoutTemplates');
      if (templateContainer) {
        console.log('‚úÖ Template container found');
        templateContainer.innerHTML = `
          <div class="col-12 text-center">
            <h3 class="text-light-enhanced">üß™ Templates Test - JavaScript is Working!</h3>
            <p class="text-soft-white">Templates: ${workoutTemplates.length} available</p>
          </div>
        `;
      } else {
        console.error('‚ùå Template container not found');
      }
      
      // Test exercise container
      const exerciseContainer = document.getElementById('exerciseLibrary');
      if (exerciseContainer) {
        console.log('‚úÖ Exercise container found');
        exerciseContainer.innerHTML = `
          <div class="col-12 text-center">
            <h3 class="text-light-enhanced">üß™ Exercise Library Test - JavaScript is Working!</h3>
            <p class="text-soft-white">Exercises: ${exerciseLibrary.length} loaded</p>
          </div>
        `;
      } else {
        console.error('‚ùå Exercise container not found');
      }
    }

    // Run test immediately when script loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', testContentLoading);
    } else {
      testContentLoading();
    }

    // Force load templates after a brief delay
    setTimeout(() => {
      console.log('‚è∞ Force loading templates after delay...');
      if (typeof loadWorkoutTemplates === 'function') {
        loadWorkoutTemplates();
      }
      if (typeof populateExerciseLibrary === 'function') {
        populateExerciseLibrary();
      }
    }, 500);

    // Initialize the page
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Initializing workout page...');
      
      try {
        // First, populate UI with existing data immediately
        console.log('üìã Loading templates immediately...');
        loadWorkoutTemplates();
        setupTemplateFilters();
        
        console.log('üèãÔ∏è Loading exercise library immediately...');
        populateExerciseLibrary();
        setupEventListeners();
        
        // Then handle authentication and data loading
        await checkAuthStatus();
        await loadExerciseLibrary();
        await loadUserWorkouts();
        await loadWorkoutHistory();
        
        // Refresh UI with any updated data
        populateExerciseLibrary();
        populateExerciseSelection();
        loadWorkoutTemplates();
        
        console.log('‚úÖ Workout page initialization complete');
        
        // Initialize progress tracking
        await initializeProgressTracking();
        
        // Initialize smart features
        initializeSmartFeatures();
        
        // Initialize push notifications
        await initializePushNotifications();
        
        // Initialize achievement system
        initializeAchievementSystem();
        
        // Update progress stats after everything is loaded
        await updateProgressStats();
      } catch (error) {
        console.error('‚ùå Error during initialization:', error);
        // Still load basic content even if there are errors
        loadWorkoutTemplates();
        populateExerciseLibrary();
        setupEventListeners();
        setupTemplateFilters();
      }
    });

    // Check if user is authenticated
    async function checkAuthStatus() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session || !session.user) {
          console.log('‚ùå No authentication session found, redirecting to home');
          // Delay redirect to allow content to load first
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
          return;
        }
      } catch (error) {
        console.error('Error checking auth status:', error);
        // Continue anyway to show content
        return;
      }

      console.log('‚úÖ User authenticated:', session.user.email);

      try {
        // Try to get user profile
        const { data: profile, error } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', session.user.id)
          .single();

        if (profile) {
          currentUser = profile;
          document.getElementById('user-name').textContent = profile.name || session.user.email.split('@')[0];
          console.log('‚úÖ User profile loaded:', profile.name);
        } else {
          // Profile doesn't exist or failed to load, but user is authenticated
          currentUser = {
            id: session.user.id,
            email: session.user.email,
            name: session.user.email.split('@')[0]
          };
          document.getElementById('user-name').textContent = currentUser.name;
          console.log('‚ö†Ô∏è No user profile found, using session data');
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
        
        // Use session data as fallback
        currentUser = {
          id: session.user.id,
          email: session.user.email,
          name: session.user.email.split('@')[0]
        };
        document.getElementById('user-name').textContent = currentUser.name;
      }
    }

    // Fallback exercise library (in case database isn't set up yet)
    const fallbackExercises = [
      // Chest
      { id: 1, name: "Push-ups", category: "chest", description: "Classic bodyweight chest exercise", equipment: "None", difficulty: "Beginner" },
      { id: 2, name: "Bench Press", category: "chest", description: "Barbell chest press", equipment: "Barbell", difficulty: "Intermediate" },
      { id: 3, name: "Dumbbell Flyes", category: "chest", description: "Chest isolation exercise", equipment: "Dumbbells", difficulty: "Intermediate" },
      
      // Back
      { id: 4, name: "Pull-ups", category: "back", description: "Upper body pulling exercise", equipment: "Pull-up Bar", difficulty: "Intermediate" },
      { id: 5, name: "Deadlifts", category: "back", description: "Compound pulling movement", equipment: "Barbell", difficulty: "Advanced" },
      { id: 6, name: "Bent-over Rows", category: "back", description: "Horizontal pulling exercise", equipment: "Barbell", difficulty: "Intermediate" },
      
      // Shoulders
      { id: 7, name: "Overhead Press", category: "shoulders", description: "Vertical pressing movement", equipment: "Barbell", difficulty: "Intermediate" },
      { id: 8, name: "Lateral Raises", category: "shoulders", description: "Side deltoid isolation", equipment: "Dumbbells", difficulty: "Beginner" },
      { id: 9, name: "Face Pulls", category: "shoulders", description: "Rear deltoid exercise", equipment: "Cable", difficulty: "Beginner" },
      
      // Arms
      { id: 10, name: "Bicep Curls", category: "arms", description: "Bicep isolation exercise", equipment: "Dumbbells", difficulty: "Beginner" },
      { id: 11, name: "Tricep Dips", category: "arms", description: "Tricep bodyweight exercise", equipment: "Bench", difficulty: "Intermediate" },
      { id: 12, name: "Hammer Curls", category: "arms", description: "Neutral grip bicep curls", equipment: "Dumbbells", difficulty: "Beginner" },
      
      // Legs
      { id: 13, name: "Squats", category: "legs", description: "Fundamental leg exercise", equipment: "Bodyweight/Barbell", difficulty: "Beginner" },
      { id: 14, name: "Lunges", category: "legs", description: "Unilateral leg exercise", equipment: "Bodyweight/Dumbbells", difficulty: "Beginner" },
      { id: 15, name: "Romanian Deadlifts", category: "legs", description: "Hip hinge movement", equipment: "Barbell", difficulty: "Intermediate" },
      
      // Core
      { id: 16, name: "Plank", category: "core", description: "Isometric core exercise", equipment: "None", difficulty: "Beginner" },
      { id: 17, name: "Russian Twists", category: "core", description: "Rotational core exercise", equipment: "Medicine Ball", difficulty: "Beginner" },
      { id: 18, name: "Mountain Climbers", category: "core", description: "Dynamic core exercise", equipment: "None", difficulty: "Intermediate" },
      
      // Cardio
      { id: 19, name: "Burpees", category: "cardio", description: "Full body cardio exercise", equipment: "None", difficulty: "Intermediate" },
      { id: 20, name: "Jumping Jacks", category: "cardio", description: "Basic cardio movement", equipment: "None", difficulty: "Beginner" },
      { id: 21, name: "High Knees", category: "cardio", description: "Running in place variation", equipment: "None", difficulty: "Beginner" }
    ];

    // Load exercise library from database
    async function loadExerciseLibrary() {
      try {
        const { data, error } = await supabase
          .from('exercises')
          .select('*')
          .order('category, name');
        
        if (error) {
          console.warn('Database not set up yet, using fallback exercises:', error.message);
          exerciseLibrary = fallbackExercises;
          showToast('Using offline exercise library. Run the SQL schema to enable full database features.', 'info');
          return;
        }
        
        if (data && data.length > 0) {
          exerciseLibrary = data;
          console.log('üìö Loaded exercise library from database:', exerciseLibrary.length, 'exercises');
        } else {
          console.warn('No exercises found in database, using fallback');
          exerciseLibrary = fallbackExercises;
          showToast('Exercise library empty. Using default exercises.', 'info');
        }
        
      } catch (error) {
        console.error('Error loading exercises, using fallback:', error);
        exerciseLibrary = fallbackExercises;
        showToast('Using offline exercise library. Check your database connection.', 'warning');
      }
    }

    // Load user's workouts from database
    async function loadUserWorkouts() {
      // Check authentication first
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        console.warn('No user session found when loading workouts');
        userWorkouts = [];
        populateMyWorkouts();
        return;
      }

      const userId = session.user.id;
      console.log('üìö Loading workouts for user:', userId);
      
      try {
        // Try to load from workout_details view first (includes exercise data)
        const { data: detailedWorkouts, error: detailsError } = await supabase
          .from('workout_details')
          .select('*')
          .eq('user_id', userId)
          .eq('is_active', true)
          .order('created_at', { ascending: false });
        
        if (!detailsError && detailedWorkouts) {
          userWorkouts = detailedWorkouts;
          console.log('‚úÖ Loaded workouts from workout_details view:', userWorkouts.length, 'workouts');
        } else {
          // Fallback: load basic workout data and exercise count separately
          const { data: basicWorkouts, error: basicError } = await supabase
            .from('workouts')
            .select(`
              *,
              workout_exercises(count)
            `)
            .eq('user_id', userId)
            .eq('is_active', true)
            .order('created_at', { ascending: false });

          if (basicError) throw basicError;

          userWorkouts = basicWorkouts.map(workout => ({
            ...workout,
            exercise_count: workout.workout_exercises?.[0]?.count || 0,
            exercises: [] // Will be loaded when needed
          }));
          
          console.log('‚úÖ Loaded basic workouts from workouts table:', userWorkouts.length, 'workouts');
        }
        
        populateMyWorkouts();
        
      } catch (error) {
        console.error('Error loading workouts from database:', error);
        
        if (error.message && error.message.includes && 
            error.message.includes('relation') && error.message.includes('does not exist')) {
          showToast('Database tables not found. Please apply the SQL schema first.', 'error');
          userWorkouts = [];
        } else if (error.message && error.message.includes && 
                   (error.message.includes('permission denied') || error.message.includes('RLS'))) {
          showToast('Permission denied loading workouts. Please log in again.', 'error');
          userWorkouts = [];
        } else {
          showToast('Failed to load workouts from database.', 'error');
          userWorkouts = [];
        }
        
        populateMyWorkouts();
      }
    }

    // Load workout history from database
    async function loadWorkoutHistory() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        console.warn('No user session found when loading workout history');
        workoutHistory = [];
        populateWorkoutHistory();
        return;
      }
      
      const userId = session.user.id;
      console.log('üìà Loading workout history for user:', userId);
      
      try {
        // Load completed workout sessions
        const { data, error } = await supabase
          .from('workout_sessions')
          .select('*')
          .eq('user_id', userId)
          .eq('completed', true)
          .order('start_time', { ascending: false })
          .limit(50);
        
        if (error) {
          console.warn('Could not load workout history from database:', error);
          workoutHistory = [];
        } else {
          workoutHistory = data || [];
          console.log('üìà Loaded workout history:', workoutHistory.length, 'completed sessions');
        }
        
        populateWorkoutHistory();
        
        // Update current user for other functions
        if (!currentUser) {
          currentUser = session.user;
        }
        
      } catch (error) {
        console.error('Error loading workout history:', error);
        workoutHistory = [];
        populateWorkoutHistory();
      }
    }

    // Populate exercise library
    function populateExerciseLibrary(filter = 'all') {
      console.log('üèãÔ∏è Populating exercise library with filter:', filter);
      const container = document.getElementById('exerciseLibrary');
      
      if (!container) {
        console.error('‚ùå Exercise library container not found!');
        return;
      }

      if (!exerciseLibrary || exerciseLibrary.length === 0) {
        console.warn('‚ö†Ô∏è Exercise library is empty, using fallback exercises');
        exerciseLibrary = fallbackExercises;
      }

      const filteredExercises = filter === 'all' 
        ? exerciseLibrary 
        : exerciseLibrary.filter(ex => ex.category === filter);

      console.log('üìä Filtered exercises:', filteredExercises.length);

      if (filteredExercises.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-soft-white">No exercises found for this category.</p></div>';
        return;
      }

      container.innerHTML = filteredExercises.map(exercise => `
        <div class="col-md-6 col-lg-4 mb-4 fade-in-up">
          <div class="card exercise-card h-100">
            <div class="card-body">
              <h6 class="card-title fw-bold">${exercise.name}</h6>
              <p class="card-text small text-elegant">${exercise.description}</p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-primary">${exercise.category}</span>
                <small class="text-premium-gray">${exercise.difficulty}</small>
              </div>
              <div class="mb-3">
                <small class="text-info">Equipment: ${exercise.equipment}</small>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-info btn-sm flex-fill" onclick="showVideoTutorial('${exercise.name}')" title="Watch Tutorial">
                  <i class="fas fa-play"></i> Video
                </button>
                <button class="btn btn-outline-light btn-sm flex-fill" onclick="showExerciseDetails(${exercise.id})">
                  üìã Details
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      
      console.log('‚úÖ Exercise library populated');
    }

    // Populate my workouts tab
    function populateMyWorkouts() {
      const container = document.getElementById('myWorkouts');
      
      if (userWorkouts.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-soft-white">No workouts created yet. Click "Create Workout" to get started!</p></div>';
        return;
      }

      container.innerHTML = userWorkouts.map(workout => `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title fw-bold">${workout.name}</h6>
              <p class="card-text small text-elegant">${workout.description || 'No description'}</p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-secondary">${workout.category}</span>
                <small class="text-premium-gray">${workout.exercise_count} exercises</small>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm flex-fill" onclick="startWorkout('${workout.id}')">
                  üöÄ Start Workout
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="editWorkout('${workout.id}')">
                  ‚úèÔ∏è
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteWorkout('${workout.id}')">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Populate workout history tab
    function populateWorkoutHistory() {
      const container = document.getElementById('workoutHistory');
      
      if (!container) {
        console.warn('Workout history container not found');
        return;
      }
      
      if (workoutHistory.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-soft-white">No workout history yet. Complete some workouts to see your progress!</p></div>';
        return;
      }

      console.log('üìã Populating workout history with', workoutHistory.length, 'sessions');

      container.innerHTML = workoutHistory.map(session => `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title fw-bold">${session.workout_name || 'Workout Session'}</h6>
              <p class="card-text small text-elegant">
                ${new Date(session.start_time).toLocaleDateString()} at ${new Date(session.start_time).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' })}
              </p>
              <div class="row text-center">
                <div class="col-6">
                  <small class="text-premium-gray">Duration</small>
                  <div class="fw-bold">${session.duration_minutes || 0} min</div>
                </div>
                <div class="col-6">
                  <small class="text-premium-gray">Rating</small>
                  <div class="fw-bold">${'‚≠ê'.repeat(session.rating || 0)}</div>
                </div>
              </div>
              <div class="mt-2">
                <div class="progress" style="height: 6px;">
                  <div class="progress-bar bg-success" style="width: ${session.completed ? 100 : ((session.exercises_finished || 0) / Math.max(session.exercises_completed || 1, 1)) * 100}%"></div>
                </div>
                <small class="text-premium-gray">${session.exercises_finished || session.exercises_completed || 0}/${session.exercises_completed || 0} exercises completed</small>
              </div>
              ${session.completed ? '<div class="mt-2"><span class="badge bg-success">‚úÖ Completed</span></div>' : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    // Populate exercise selection for workout creation
    function populateExerciseSelection() {
      const container = document.getElementById('exerciseSelection');
      
      console.log('üèãÔ∏è Populating exercise selection...');
      console.log('üìö Exercise library length:', exerciseLibrary.length);
      console.log('üìö Exercise library:', exerciseLibrary);
      
      if (!exerciseLibrary || exerciseLibrary.length === 0) {
        console.warn('‚ö†Ô∏è Exercise library is empty, using fallback');
        exerciseLibrary = fallbackExercises;
      }
      
      if (!container) {
        console.error('‚ùå Exercise selection container not found!');
        return;
      }
      
      container.innerHTML = exerciseLibrary.map(exercise => `
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" value="${exercise.id}" id="exercise-${exercise.id}">
          <label class="form-check-label" for="exercise-${exercise.id}">
            <strong>${exercise.name}</strong> - ${exercise.category}
            <small class="text-elegant d-block">${exercise.description}</small>
          </label>
        </div>
      `).join('');
      
      console.log('‚úÖ Exercise selection populated with', exerciseLibrary.length, 'exercises');
    }

    // Setup event listeners
    function setupEventListeners() {
      // Exercise Library Category filter (different from template filters)
      document.querySelectorAll('#categoryFilter .category-badge').forEach(badge => {
        badge.addEventListener('click', (e) => {
          // Remove active from exercise library filters only
          document.querySelectorAll('#categoryFilter .category-badge').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          populateExerciseLibrary(e.target.dataset.category);
        });
      });

      // Save workout button
      const saveBtn = document.getElementById('saveWorkoutBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', saveWorkout);
      }

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          await supabase.auth.signOut();
          window.location.href = '/';
        });
      }

      // Re-populate exercises when modal is opened
      const createWorkoutModal = document.getElementById('createWorkoutModal');
      if (createWorkoutModal) {
        createWorkoutModal.addEventListener('show.bs.modal', () => {
          console.log('üîÑ Modal opening, re-populating exercises...');
          populateExerciseSelection();
        });
      }

      // Update progress stats when Progress Tracking tab is clicked
      const progressTab = document.getElementById('progress-tab');
      if (progressTab) {
        progressTab.addEventListener('click', async () => {
          console.log('üìä Progress tab clicked, refreshing data...');
          await loadWorkoutHistory();
          await updateProgressStats();
          
          // Initialize charts and display achievements
          setTimeout(() => {
            initializeAnalyticsCharts();
            displayAchievementBadges();
          }, 500);
        });
      }
    }

    // Show exercise details
    function showExerciseDetails(exerciseId) {
      const exercise = exerciseLibrary.find(ex => ex.id === exerciseId);
      if (exercise) {
        alert(`${exercise.name}\n\nCategory: ${exercise.category}\nDifficulty: ${exercise.difficulty}\nEquipment: ${exercise.equipment}\n\nDescription: ${exercise.description}`);
      }
    }

    // Video tutorial database - mapping exercises to tutorial videos
    // Updated with verified working YouTube video IDs from reliable fitness channels
    const videoTutorials = {
      'Push-ups': 'IODxDxX7oi4',
      'Bench Press': '4Y2ZdHCOXok', 
      'Squats': 'YaXPRqUwItQ',
      'Deadlifts': 'ytGaGIn3SjE',
      'Pull-ups': 'aAggnLH3SL4',
      'Plank': 'pSHjTRCQxIw',
      'Lunges': 'QOVaHwm-Q6U',
      'Bicep Curls': 'ykJmrZ5v0Oo',
      'Tricep Dips': '6kALZikXxLc',
      'Burpees': 'dZgVxmf6jkA',
      'Mountain Climbers': 'kLh-uczlPLg',
      'Jumping Jacks': 'c4DAnQ6DtF8',
      'Lateral Raises': '3VcKaXpzqRo',
      'Overhead Press': 'xkdAaLqhNKQ',
      'Bent-over Rows': 'k4q9QW9KJIk',
      'Russian Twists': 'uRjQ3IhbdOk',
      'Romanian Deadlifts': 'cUJJ8bJhbOQ',
      'Hammer Curls': 'ykJmrZ5v0Oo',
      'Dumbbell Flyes': 'MwEZGVWJTpw',
      'Face Pulls': 'rJgwXHZLuSY',
      'High Knees': 'MlHbVtYKK8M'
    };

    // Alternative video IDs as fallback - using Athlean-X and other reliable channels
    const alternativeVideoTutorials = {
      'Push-ups': 'IODxDxX7oi4',      // Athlean-X
      'Bench Press': '4Y2ZdHCOXok',   // AthleanX
      'Squats': 'YaXPRqUwItQ',       // Athlean-X  
      'Deadlifts': 'ytGaGIn3SjE',    // AthleanX
      'Pull-ups': 'aAggnLH3SL4',     // Athlean-X
      'Plank': 'pSHjTRCQxIw',        // FitnessBlender
      'Lunges': 'QOVaHwm-Q6U',       // Athlean-X
      'Bicep Curls': 'ykJmrZ5v0Oo',  // Athlean-X
      'Tricep Dips': '6kALZikXxLc',  // Calisthenic Movement
      'Burpees': 'dZgVxmf6jkA',      // FitnessBlender
      'Mountain Climbers': 'kLh-uczlPLg', // HIIT Workouts
      'Jumping Jacks': 'c4DAnQ6DtF8', // FitnessBlender
      'Lateral Raises': '3VcKaXpzqRo', // Athlean-X
      'Overhead Press': 'xkdAaLqhNKQ', // StrongLifts
      'Bent-over Rows': 'k4q9QW9KJIk', // Athlean-X
      'Russian Twists': 'uRjQ3IhbdOk', // FitnessBlender
      'Romanian Deadlifts': 'cUJJ8bJhbOQ', // Athlean-X
      'Hammer Curls': 'ykJmrZ5v0Oo',  // Athlean-X
      'Dumbbell Flyes': 'MwEZGVWJTpw', // Bodybuilding.com
      'Face Pulls': 'rJgwXHZLuSY',    // Athlean-X
      'High Knees': 'MlHbVtYKK8M'     // FitnessBlender
    };

    // Show video tutorial modal
    function showVideoTutorial(exerciseName) {
      const videoId = videoTutorials[exerciseName];
      
      if (!videoId) {
        showToast(`Video tutorial not available for ${exerciseName} yet. Check back soon!`, 'info');
        return;
      }

      // Validate video ID
      if (!validateVideoId(videoId)) {
        console.error(`Invalid video ID for ${exerciseName}: ${videoId}`);
        showToast(`Video tutorial error for ${exerciseName}. Try again later.`, 'warning');
        return;
      }

      const modalHtml = `
        <div class="modal fade" id="videoTutorialModal" tabindex="-1" aria-labelledby="videoTutorialModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="videoTutorialModalLabel">
                  <i class="fas fa-play-circle text-primary"></i> ${exerciseName} Tutorial
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="ratio ratio-16x9">
                  <iframe id="videoFrame" 
                          src="https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&modestbranding=1" 
                          title="${exerciseName} Tutorial" 
                          frameborder="0" 
                          allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                          allowfullscreen
                          onerror="handleVideoError('${exerciseName}')"
                          onload="videoLoadSuccess('${exerciseName}')">
                  </iframe>
                  <div id="videoLoadingIndicator" class="d-none">
                    <div class="text-center text-light p-4">
                      <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                      <p>Loading video tutorial...</p>
                      <small>If this takes too long, try the alternative options below.</small>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <h6>üí° Key Points for ${exerciseName}:</h6>
                  <ul class="text-soft-white small">
                    ${getExerciseSpecificTips(exerciseName)}
                  </ul>
                </div>
                <div class="mt-3">
                  <div class="alert alert-info" role="alert">
                    <small><i class="fas fa-info-circle"></i> Video not loading? 
                    <a href="#" onclick="tryAlternativeVideo('${exerciseName}')" class="alert-link">Try alternative video</a>, 
                    <a href="#" onclick="openVideoInNewTab('${videoId}', '${exerciseName}')" class="alert-link">watch on YouTube</a>, or 
                    <a href="#" onclick="searchYouTubeForExercise('${exerciseName}')" class="alert-link">search for ${exerciseName} tutorials</a>.</small>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-secondary" onclick="openVideoInNewTab('${videoId}', '${exerciseName}')">
                  <i class="fab fa-youtube"></i> Watch on YouTube
                </button>
                <button type="button" class="btn btn-outline-info" onclick="debugVideoInfo('${exerciseName}', '${videoId}')">
                  <i class="fas fa-info"></i> Debug
                </button>
                <button type="button" class="btn btn-primary" onclick="addExerciseToWorkout('${exerciseName}')">
                  <i class="fas fa-plus"></i> Add to Workout
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if present
      const existingModal = document.getElementById('videoTutorialModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('videoTutorialModal'));
      modal.show();

      // Show loading indicator initially
      const indicator = document.getElementById('videoLoadingIndicator');
      if (indicator) {
        indicator.classList.remove('d-none');
      }

      // Setup video timeout
      setupVideoTimeout(exerciseName);

      // Clean up when modal is hidden
      document.getElementById('videoTutorialModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
      });
    }

    // Get exercise-specific tips
    function getExerciseSpecificTips(exerciseName) {
      const tips = {
        'Push-ups': `
          <li>Keep your body in a straight line from head to toe</li>
          <li>Lower your chest to about 2 inches from the floor</li>
          <li>Push through your palms, not your fingers</li>
          <li>Keep your core engaged throughout the movement</li>
        `,
        'Squats': `
          <li>Keep your chest up and knees in line with your toes</li>
          <li>Lower until your thighs are parallel to the floor</li>
          <li>Drive through your heels when standing up</li>
          <li>Keep your weight on your heels, not your toes</li>
        `,
        'Lunges': `
          <li>Step forward with a large stride</li>
          <li>Lower your hips until both knees are at 90 degrees</li>
          <li>Keep your front knee over your ankle</li>
          <li>Push back to starting position through your front heel</li>
        `,
        'Deadlifts': `
          <li>Keep the bar close to your body throughout the lift</li>
          <li>Drive through your heels and squeeze your glutes</li>
          <li>Keep your back straight and chest up</li>
          <li>Start with lighter weights to master the form</li>
        `,
        'Pull-ups': `
          <li>Hang with arms fully extended</li>
          <li>Pull your chest toward the bar</li>
          <li>Lower yourself with control</li>
          <li>Avoid swinging or using momentum</li>
        `,
        'Plank': `
          <li>Keep your body in a straight line</li>
          <li>Don't let your hips sag or pike up</li>
          <li>Breathe normally, don't hold your breath</li>
          <li>Engage your core and glutes</li>
        `
      };
      
      return tips[exerciseName] || `
        <li>Focus on proper form over speed</li>
        <li>Control the movement throughout the full range of motion</li>
        <li>Breathe properly during the exercise</li>
        <li>Start with lighter weights to master the technique</li>
      `;
    }

    // Open video in new tab
    function openVideoInNewTab(videoId, exerciseName) {
      const url = `https://www.youtube.com/watch?v=${videoId}`;
      window.open(url, '_blank');
      showToast(`Opening ${exerciseName} tutorial in YouTube`, 'info');
    }

    // Handle video errors
    function handleVideoError(exerciseName) {
      console.error(`Video error for ${exerciseName}`);
      showToast(`Video temporarily unavailable. Try the alternative options below.`, 'warning');
    }

    // Search YouTube for exercise tutorials
    function searchYouTubeForExercise(exerciseName) {
      const searchQuery = `${exerciseName} exercise tutorial proper form`;
      const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}`;
      window.open(searchUrl, '_blank');
      showToast(`Searching YouTube for ${exerciseName} tutorials...`, 'info');
    }

    // Video loading success
    function videoLoadSuccess(exerciseName) {
      console.log(`Video loaded successfully for ${exerciseName}`);
      const indicator = document.getElementById('videoLoadingIndicator');
      if (indicator) {
        indicator.classList.add('d-none');
      }
    }

    // Auto-try alternative video after timeout
    function setupVideoTimeout(exerciseName) {
      setTimeout(() => {
        const videoFrame = document.getElementById('videoFrame');
        const indicator = document.getElementById('videoLoadingIndicator');
        
        // Check if video is still loading (indicator visible)
        if (indicator && !indicator.classList.contains('d-none')) {
          console.log(`Video timeout for ${exerciseName}, trying alternative...`);
          tryAlternativeVideo(exerciseName);
        }
      }, 8000); // 8 second timeout
    }

    // Try alternative video
    function tryAlternativeVideo(exerciseName) {
      const altVideoId = alternativeVideoTutorials[exerciseName];
      const videoFrame = document.getElementById('videoFrame');
      const indicator = document.getElementById('videoLoadingIndicator');
      
      if (altVideoId && videoFrame) {
        // Show loading indicator again
        if (indicator) {
          indicator.classList.remove('d-none');
        }
        
        videoFrame.src = `https://www.youtube.com/embed/${altVideoId}?autoplay=0&rel=0&modestbranding=1`;
        showToast(`Loading alternative video for ${exerciseName}...`, 'info');
        
        // Setup timeout for alternative video too
        setupVideoTimeout(exerciseName);
      } else {
        // Hide loading indicator if no alternative
        if (indicator) {
          indicator.classList.add('d-none');
        }
        showToast(`No alternative video available. Try the YouTube search option.`, 'warning');
      }
    }

    // Validate video ID before loading
    function validateVideoId(videoId) {
      // Basic YouTube video ID validation (11 characters, alphanumeric + _ -)
      const youtubeIdRegex = /^[a-zA-Z0-9_-]{11}$/;
      return youtubeIdRegex.test(videoId);
    }

    // Debug video information
    function debugVideoInfo(exerciseName, videoId) {
      const altVideoId = alternativeVideoTutorials[exerciseName];
      const debugInfo = `
üîç Video Debug Info for ${exerciseName}:

üìπ Primary Video ID: ${videoId}
‚úÖ Valid Format: ${validateVideoId(videoId) ? 'Yes' : 'No'}
üîó YouTube URL: https://www.youtube.com/watch?v=${videoId}

üîÑ Alternative Video ID: ${altVideoId || 'None'}
${altVideoId ? `‚úÖ Alt Valid Format: ${validateVideoId(altVideoId) ? 'Yes' : 'No'}` : ''}
${altVideoId ? `üîó Alt YouTube URL: https://www.youtube.com/watch?v=${altVideoId}` : ''}

üí° If videos don't load, the YouTube links above should work in a new tab.
      `;
      
      alert(debugInfo);
      console.log('Video Debug Info:', {
        exercise: exerciseName,
        primaryVideoId: videoId,
        primaryValid: validateVideoId(videoId),
        alternativeVideoId: altVideoId,
        alternativeValid: altVideoId ? validateVideoId(altVideoId) : false
      });
    }

    // Add exercise to workout from video modal
    function addExerciseToWorkout(exerciseName) {
      // Find the exercise in the library
      const exercise = exerciseLibrary.find(ex => ex.name === exerciseName);
      if (!exercise) {
        showToast(`Exercise "${exerciseName}" not found in library.`, 'error');
        return;
      }

      // Check if Create Workout modal is open
      const createWorkoutModal = document.getElementById('createWorkoutModal');
      if (!createWorkoutModal.classList.contains('show')) {
        // Open create workout modal
        const modal = new bootstrap.Modal(createWorkoutModal);
        modal.show();
        
        // Wait for modal to open, then select the exercise
        setTimeout(() => {
          const exerciseCheckbox = document.getElementById(`exercise-${exercise.id}`);
          if (exerciseCheckbox) {
            exerciseCheckbox.checked = true;
            showToast(`${exerciseName} added to workout!`, 'success');
          }
        }, 500);
      } else {
        // Modal is already open, just check the exercise
        const exerciseCheckbox = document.getElementById(`exercise-${exercise.id}`);
        if (exerciseCheckbox) {
          exerciseCheckbox.checked = true;
          showToast(`${exerciseName} added to workout!`, 'success');
        }
      }

      // Close video tutorial modal
      const videoModal = document.getElementById('videoTutorialModal');
      if (videoModal) {
        bootstrap.Modal.getInstance(videoModal).hide();
      }
    }

    // Save workout to database
    async function saveWorkout() {
      const name = document.getElementById('workoutName').value.trim();
      const category = document.getElementById('workoutCategory').value;
      const description = document.getElementById('workoutDescription').value.trim();
      
      const selectedCheckboxes = document.querySelectorAll('#exerciseSelection input:checked');
      const exerciseIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
      
      // Validation
      if (!name || !category || exerciseIds.length === 0) {
        showToast('Please fill in all required fields and select at least one exercise.', 'error');
        return;
      }

      // Check authentication
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        showToast('Please log in to save workouts.', 'error');
        window.location.href = '/';
        return;
      }

      const userId = session.user.id;
      console.log('üíæ Saving workout for user:', userId, 'Workout:', name, 'Exercises:', exerciseIds);

      try {
        // First, create the workout
        const { data: workout, error: workoutError } = await supabase
          .from('workouts')
          .insert({
            user_id: userId,
            name: name,
            category: category,
            description: description || null,
            is_active: true
          })
          .select()
          .single();

        if (workoutError) {
          console.error('Error creating workout:', workoutError);
          
          // Check if it's a schema issue
          if (workoutError.message && workoutError.message.includes && 
              workoutError.message.includes('relation') && workoutError.message.includes('does not exist')) {
            showToast('Database not set up! Please run the SQL schema in Supabase first.', 'error');
            return;
          }
          
          throw workoutError;
        }

        console.log('‚úÖ Workout created:', workout);

        // Then, add the exercises to the workout
        const workoutExercises = exerciseIds.map((exerciseId, index) => ({
          workout_id: workout.id,
          exercise_id: exerciseId,
          exercise_order: index + 1,
          sets: 3, // Default values - can be customized later
          reps: '10', // Default reps
          weight_kg: null, // Will be set during workout
          rest_seconds: 60, // Default rest time
          notes: null
        }));

        const { error: exercisesError } = await supabase
          .from('workout_exercises')
          .insert(workoutExercises);

        if (exercisesError) {
          console.error('Error adding exercises to workout:', exercisesError);
          
          // Cleanup: delete the workout if exercises failed to save
          await supabase.from('workouts').delete().eq('id', workout.id);
          
          throw exercisesError;
        }

        console.log('‚úÖ Workout exercises added:', workoutExercises.length, 'exercises');

        showToast(`Workout "${name}" created successfully! üéâ`, 'success');
        
        // Reload user workouts to show the new one
        await loadUserWorkouts();

        // Success! Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('createWorkoutModal'));
        modal.hide();
        document.getElementById('createWorkoutForm').reset();
        selectedCheckboxes.forEach(cb => cb.checked = false);
        
      } catch (error) {
        console.error('Error saving workout:', error);
        
        if (error.message && error.message.includes && 
            (error.message.includes('permission denied') || error.message.includes('RLS'))) {
          showToast('Permission denied. Please make sure you are logged in.', 'error');
        } else if (error.message && error.message.includes && 
                   error.message.includes('relation') && error.message.includes('does not exist')) {
          showToast('Database tables not found. Please apply the SQL schema first.', 'error');
        } else {
          showToast(`Error saving workout: ${error.message || error}`, 'error');
        }
      }
    }

    // Start a workout session
    async function startWorkout(workoutId) {
      try {
        console.log('üöÄ Starting workout with ID:', workoutId);
        
        // Make sure user is authenticated
        const { data: { session } } = await supabase.auth.getSession();
        if (!session || !session.user) {
          showToast('Please log in to start workouts', 'error');
          window.location.href = '/';
          return;
        }
        
        currentUser = session.user;
        
        const workout = userWorkouts.find(w => w.id === workoutId);
        if (!workout) {
          showToast('Workout not found', 'error');
          return;
        }

        console.log('üìã Found workout:', workout.name);

        // Get workout exercises from database
        let workoutExercises = [];
        try {
          const { data: exerciseData, error: exerciseError } = await supabase
            .from('workout_exercises')
            .select('*')
            .eq('workout_id', workoutId)
            .order('exercise_order');

          if (exerciseError) {
            console.warn('Could not load exercises from database:', exerciseError);
            // Use fallback exercises if database query fails
            workoutExercises = [
              { exercise_id: 1, exercise_name: 'Push-ups', sets: 3, reps: '10', rest_seconds: 60 },
              { exercise_id: 13, exercise_name: 'Squats', sets: 3, reps: '12', rest_seconds: 60 },
              { exercise_id: 16, exercise_name: 'Plank', sets: 2, reps: '30 sec', rest_seconds: 60 }
            ];
          } else {
            // Map exercise IDs to exercise names from exerciseLibrary
            workoutExercises = exerciseData.map(we => {
              const exercise = exerciseLibrary.find(ex => ex.id === we.exercise_id);
              return {
                ...we,
                exercise_name: exercise ? exercise.name : `Exercise ${we.exercise_id}`,
                category: exercise ? exercise.category : 'unknown'
              };
            });
          }
        } catch (dbError) {
          console.warn('Database error loading exercises:', dbError);
          // Use fallback exercises
          workoutExercises = [
            { exercise_id: 1, exercise_name: 'Push-ups', sets: 3, reps: '10', rest_seconds: 60 },
            { exercise_id: 13, exercise_name: 'Squats', sets: 3, reps: '12', rest_seconds: 60 },
            { exercise_id: 16, exercise_name: 'Plank', sets: 2, reps: '30 sec', rest_seconds: 60 }
          ];
        }

        console.log('üí™ Workout exercises:', workoutExercises);

        // Create workout session
        currentSession = {
          workout: workout,
          exercises: workoutExercises,
          isLocal: true // We'll start with local sessions for now
        };

        // Try to create session in database but don't fail if it doesn't work
        try {
          const { data: sessionData, error: sessionError } = await supabase
            .from('workout_sessions')
            .insert({
              user_id: currentUser.id,
              workout_id: workoutId,
              workout_name: workout.name,
              start_time: new Date().toISOString()
            })
            .select()
            .single();

          if (!sessionError && sessionData) {
            currentSession.id = sessionData.id;
            currentSession.isLocal = false;
            console.log('‚úÖ Database session created:', sessionData.id);
          }
        } catch (sessionErr) {
          console.warn('Could not create database session, using local session:', sessionErr);
        }

        // Start the session UI
        startSessionTimer();
        showSessionModal();
        showToast(`Started "${workout.name}" workout! üí™`, 'success');

      } catch (error) {
        console.error('Error starting workout:', error);
        showToast(`Error starting workout: ${error.message || error}`, 'error');
      }
    }

    // Show session modal with exercises
    function showSessionModal() {
      if (!currentSession) return;

      document.getElementById('sessionWorkoutName').textContent = currentSession.workout.name;
      
      const container = document.getElementById('sessionExercises');
      container.innerHTML = currentSession.exercises.map((exercise, index) => `
        <div class="card mb-3">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-4">
                <h6 class="mb-1">${exercise.exercise_name || exercise.name}</h6>
                <small class="text-premium-gray">${exercise.category || ''}</small>
              </div>
              <div class="col-md-8">
                <div class="row">
                  <div class="col-4">
                    <label class="form-label small">Sets</label>
                    <input type="number" class="form-control form-control-sm" value="${exercise.sets || 3}" id="sets-${index}">
                  </div>
                  <div class="col-4">
                    <label class="form-label small">Reps</label>
                    <input type="text" class="form-control form-control-sm" value="${exercise.reps || '10'}" id="reps-${index}">
                  </div>
                  <div class="col-4">
                    <label class="form-label small">Weight (kg)</label>
                    <input type="number" class="form-control form-control-sm" step="0.5" value="${exercise.weight_kg || ''}" id="weight-${index}">
                  </div>
                </div>
                <div class="mt-2">
                  <button class="btn btn-sm btn-primary me-2" onclick="startTimerForExercise('${exercise.exercise_name || exercise.name}', ${exercise.sets || 3})">
                    ‚è±Ô∏è Start Timer
                  </button>
                  <button class="btn btn-sm btn-outline-success" onclick="markExerciseComplete(${index})">
                    ‚úÖ Complete
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      const modal = new bootstrap.Modal(document.getElementById('workoutSessionModal'));
      modal.show();
    }

    // Start session timer
    function startSessionTimer() {
      sessionStartTime = new Date();
      sessionTimer = setInterval(() => {
        const elapsed = Math.floor((new Date() - sessionStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('sessionTimer').textContent = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // Mark exercise as complete
    function markExerciseComplete(exerciseIndex) {
      const exerciseCard = document.querySelector(`#sessionExercises .card:nth-child(${exerciseIndex + 1})`);
      exerciseCard.style.opacity = '0.6';
      exerciseCard.style.border = '2px solid #28a745';
      
      const completeBtn = exerciseCard.querySelector('button');
      completeBtn.textContent = '‚úÖ Completed';
      completeBtn.disabled = true;
      completeBtn.classList.remove('btn-outline-success');
      completeBtn.classList.add('btn-success');
      
      showToast('Exercise completed! üí™', 'success');
    }

    // Complete current session
    async function completeCurrentSession() {
      if (!currentSession) return;

      try {
        const endTime = new Date();
        const durationMinutes = Math.floor((endTime - sessionStartTime) / 60000);

        console.log('üèÅ Completing workout session...', {
          session: currentSession,
          duration: durationMinutes,
          isLocal: currentSession.isLocal
        });

        // Get current user
        const { data: { session: authSession } } = await supabase.auth.getSession();
        if (!authSession || !authSession.user) {
          showToast('Please log in to save workout progress', 'error');
          return;
        }

        const userId = authSession.user.id;

        if (!currentSession.isLocal && currentSession.id) {
          // Update existing session in database
          const { error } = await supabase
            .from('workout_sessions')
            .update({
              end_time: endTime.toISOString(),
              duration_minutes: durationMinutes,
              completed: true,
              rating: 4,
              exercises_completed: currentSession.exercises.length,
              exercises_finished: currentSession.exercises.length
            })
            .eq('id', currentSession.id);

          if (error) {
            console.error('Error updating workout session:', error);
            throw error;
          }
          
          console.log('‚úÖ Updated existing workout session:', currentSession.id);
        } else {
          // Create new completed session record
          const { data: newSession, error: sessionError } = await supabase
            .from('workout_sessions')
            .insert({
              user_id: userId,
              workout_id: currentSession.workout.id || null,
              workout_name: currentSession.workout.name,
              start_time: sessionStartTime.toISOString(),
              end_time: endTime.toISOString(),
              duration_minutes: durationMinutes,
              completed: true,
              rating: 4,
              exercises_completed: currentSession.exercises.length,
              exercises_finished: currentSession.exercises.length
            })
            .select()
            .single();

          if (sessionError) {
            console.warn('Could not save to database, workout completed locally:', sessionError);
          } else {
            console.log('‚úÖ Created new workout session:', newSession.id);
          }
        }

        // Stop timer
        if (sessionTimer) {
          clearInterval(sessionTimer);
          sessionTimer = null;
        }

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('workoutSessionModal'));
        modal.hide();

        // Reset session
        currentSession = null;
        sessionStartTime = null;

        showToast(`Workout completed! Duration: ${durationMinutes} minutes üéâ`, 'success');
        
        // Send workout completion notification
        const workoutName = currentSession?.workout?.name || 'Workout';
        const exerciseCount = currentSession?.exercises?.length || 0;
        sendWorkoutCompletionNotification(workoutName, durationMinutes, exerciseCount);
        
        // Update achievement stats
        updateAchievementStats('totalWorkouts', 1, { workoutTime: new Date() });
        updateAchievementStats('totalExercises', exerciseCount);
        updateAchievementStats('totalTimeExercised', durationMinutes);
        
        // Reload workout history and update progress stats
        await loadWorkoutHistory();
        await updateProgressStats();
        
        // Refresh analytics charts
        refreshAnalyticsCharts();

      } catch (error) {
        console.error('Error completing workout:', error);
        showToast('Error completing workout', 'error');
      }
    }

    // Complete a workout session
    async function completeWorkout(sessionId, workoutName) {
      try {
        const endTime = new Date();
        const { error } = await supabase
          .from('workout_sessions')
          .update({
            end_time: endTime.toISOString(),
            duration_minutes: 5, // Simulated duration
            completed: true,
            rating: 4 // Simulated rating
          })
          .eq('id', sessionId);

        if (error) throw error;

        showToast(`Completed "${workoutName}"! Great job! üéâ`, 'success');
        
        // Send workout completion notification
        sendWorkoutCompletionNotification(workoutName, 5, 0); // Default values for this function
        
        // Reload workout history
        await loadWorkoutHistory();

      } catch (error) {
        console.error('Error completing workout:', error);
        showToast('Error completing workout', 'error');
      }
    }

    // Edit workout (placeholder)
    function editWorkout(workoutId) {
      showToast('Edit workout feature coming soon!', 'info');
    }

    // Delete workout
    async function deleteWorkout(workoutId) {
      if (!confirm('Are you sure you want to delete this workout?')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('workouts')
          .update({ is_active: false })
          .eq('id', workoutId);

        if (error) throw error;

        showToast('Workout deleted successfully', 'success');
        await loadUserWorkouts();

      } catch (error) {
        console.error('Error deleting workout:', error);
        showToast('Error deleting workout', 'error');
      }
    }

    // Show stats
    async function showStats() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabase.rpc('get_user_workout_stats', { 
          user_uuid: currentUser.id 
        });
        
        if (error) throw error;
        
        const stats = data || {};
        alert(`Workout Stats:\n\nüìä Total Workouts: ${stats.total_workouts || 0}\nüî• This Week: ${stats.this_week_workouts || 0}\nüèÜ Total Sessions: ${stats.total_sessions || 0}\n‚≠ê Average Rating: ${(stats.avg_rating || 0).toFixed(1)}/5\nüí™ Favorite Category: ${stats.favorite_category || 'none'}\n\nKeep working out to see your progress!`);
        
      } catch (error) {
        console.error('Error loading stats:', error);
        alert('Workout Stats:\n\nüìä Total Workouts: 0\nüî• This Week: 0\nüí™ Favorite Exercise: Coming Soon!\n\nKeep working out to see your progress!');
      }
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
      toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
      toast.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span>${message}</span>
          <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      // Auto-remove after 4 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 4000);
    }

    // ==============================================
    // WORKOUT TEMPLATES FUNCTIONALITY
    // ==============================================

    // Load and display workout templates
    function loadWorkoutTemplates() {
      console.log('üìã Loading workout templates...');
      const container = document.getElementById('workoutTemplates');
      if (!container) {
        console.error('‚ùå Templates container not found!');
        return;
      }

      const activeLevel = document.querySelector('#templateLevelFilter .category-badge.active')?.dataset.level || 'all';
      console.log('üéØ Active level filter:', activeLevel);
      
      const filteredTemplates = activeLevel === 'all' 
        ? workoutTemplates 
        : workoutTemplates.filter(template => template.level === activeLevel);

      console.log('üìä Filtered templates:', filteredTemplates.length);

      if (filteredTemplates.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-soft-white">No templates found for this level.</p></div>';
        return;
      }

      container.innerHTML = filteredTemplates.map(template => {
        // Safely get exercise names with fallback
        let exerciseNames = 'Loading exercises...';
        if (exerciseLibrary && exerciseLibrary.length > 0) {
          exerciseNames = template.exerciseIds
            .map(id => {
              const exercise = exerciseLibrary.find(ex => ex.id === id);
              return exercise ? exercise.name : `Exercise ${id}`;
            })
            .slice(0, 3)
            .join(', ') + (template.exerciseIds.length > 3 ? '...' : '');
        }

        return `
          <div class="col-lg-4 col-md-6 mb-4">
            <div class="card template-card ${template.level}" onclick="showTemplateDetails('${template.id}')">
              <span class="template-level-badge ${template.level}">${template.level}</span>
              <div class="template-header">
                <h5 class="card-title mb-2">${template.name}</h5>
                <div class="template-stats">
                  <span class="template-stat">‚è±Ô∏è ${template.duration}</span>
                  <span class="template-stat">üí™ ${template.exercises} exercises</span>
                </div>
              </div>
              <div class="card-body">
                <p class="card-text mb-2">${template.description}</p>
                <div class="exercise-preview">
                  <strong>Exercises:</strong> ${exerciseNames}
                </div>
                <div class="template-actions">
                  <button class="btn btn-template-start flex-fill" onclick="event.stopPropagation(); startTemplateWorkout('${template.id}')">
                    üöÄ Start Now
                  </button>
                  <button class="btn btn-template-copy" onclick="event.stopPropagation(); copyTemplateToWorkouts('${template.id}')">
                    üìã Copy
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      console.log('‚úÖ Templates loaded successfully');
    }

    // Show template details in modal
    function showTemplateDetails(templateId) {
      const template = workoutTemplates.find(t => t.id === templateId);
      if (!template) return;

      const exerciseDetails = template.exerciseIds.map((exerciseId, index) => {
        const exercise = exerciseLibrary.find(ex => ex.id === exerciseId);
        const detail = template.exerciseDetails[index];
        return {
          ...exercise,
          ...detail
        };
      });

      const modalContent = `
        <div class="modal fade" id="templateDetailsModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  ${template.name} 
                  <span class="template-level-badge ${template.level} ms-2">${template.level}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p class="text-light-enhanced mb-3">${template.description}</p>
                
                <div class="row mb-4">
                  <div class="col-6">
                    <div class="template-stat">‚è±Ô∏è Duration: ${template.duration}</div>
                  </div>
                  <div class="col-6">
                    <div class="template-stat">üí™ ${template.exercises} exercises</div>
                  </div>
                </div>

                <h6 class="mb-3">Exercise Details:</h6>
                <div class="exercise-list">
                  ${exerciseDetails.map(exercise => `
                    <div class="card mb-2">
                      <div class="card-body py-2">
                        <div class="row align-items-center">
                          <div class="col-md-4">
                            <strong>${exercise.name}</strong>
                            <br><small class="text-muted">${exercise.category}</small>
                          </div>
                          <div class="col-md-8">
                            <div class="row text-center">
                              <div class="col-4">
                                <small class="text-muted">Sets</small>
                                <div><strong>${exercise.sets}</strong></div>
                              </div>
                              <div class="col-4">
                                <small class="text-muted">Reps</small>
                                <div><strong>${exercise.reps}</strong></div>
                              </div>
                              <div class="col-4">
                                <small class="text-muted">Rest</small>
                                <div><strong>${exercise.rest}s</strong></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-template-start me-2" onclick="startTemplateWorkout('${template.id}'); bootstrap.Modal.getInstance(document.getElementById('templateDetailsModal')).hide();">
                  üöÄ Start Workout
                </button>
                <button class="btn btn-template-copy" onclick="copyTemplateToWorkouts('${template.id}'); bootstrap.Modal.getInstance(document.getElementById('templateDetailsModal')).hide();">
                  üìã Copy to My Workouts
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('templateDetailsModal');
      if (existingModal) existingModal.remove();

      // Add new modal to body
      document.body.insertAdjacentHTML('beforeend', modalContent);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('templateDetailsModal'));
      modal.show();
    }

    // Start a template workout immediately
    function startTemplateWorkout(templateId) {
      const template = workoutTemplates.find(t => t.id === templateId);
      if (!template) return;

      // Create a mock workout session from template
      const templateExercises = template.exerciseIds.map((exerciseId, index) => {
        const exercise = exerciseLibrary.find(ex => ex.id === exerciseId);
        const detail = template.exerciseDetails[index];
        return {
          ...exercise,
          exercise_name: exercise.name,
          ...detail
        };
      });

      currentSession = {
        workout: { name: template.name, id: templateId },
        exercises: templateExercises,
        isTemplate: true
      };

      startSessionTimer();
      showSessionModal();
      showToast(`Started "${template.name}" template! üí™`, 'success');
    }

    // Copy template to user's workouts
    async function copyTemplateToWorkouts(templateId) {
      const template = workoutTemplates.find(t => t.id === templateId);
      if (!template) return;

      // Check authentication
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        showToast('Please log in to save workouts.', 'error');
        return;
      }

      try {
        const userId = session.user.id;
        
        // Create the workout
        const { data: workout, error: workoutError } = await supabase
          .from('workouts')
          .insert({
            user_id: userId,
            name: `${template.name} (Copy)`,
            category: template.category,
            description: `${template.description} (Copied from template)`,
            is_active: true
          })
          .select()
          .single();

        if (workoutError) throw workoutError;

        // Add exercises to the workout
        const workoutExercises = template.exerciseIds.map((exerciseId, index) => {
          const detail = template.exerciseDetails[index];
          return {
            workout_id: workout.id,
            exercise_id: exerciseId,
            exercise_order: index + 1,
            sets: detail.sets,
            reps: detail.reps,
            rest_seconds: detail.rest,
            weight_kg: null,
            notes: null
          };
        });

        const { error: exercisesError } = await supabase
          .from('workout_exercises')
          .insert(workoutExercises);

        if (exercisesError) {
          // Cleanup on failure
          await supabase.from('workouts').delete().eq('id', workout.id);
          throw exercisesError;
        }

        showToast(`Template "${template.name}" copied to your workouts! üìã`, 'success');
        
        // Reload user workouts
        await loadUserWorkouts();

      } catch (error) {
        console.error('Error copying template:', error);
        showToast('Error copying template to workouts', 'error');
      }
    }

    // Setup template level filter
    function setupTemplateFilters() {
      console.log('üîß Setting up template filters...');
      const filterBadges = document.querySelectorAll('#templateLevelFilter .category-badge');
      console.log('üéØ Found filter badges:', filterBadges.length);
      
      filterBadges.forEach(badge => {
        badge.addEventListener('click', (e) => {
          console.log('üéØ Template filter clicked:', e.target.dataset.level);
          // Remove active class from template filter badges only
          filterBadges.forEach(b => b.classList.remove('active'));
          // Add active class to clicked badge
          e.target.classList.add('active');
          // Reload templates with new filter
          loadWorkoutTemplates();
        });
      });
    }

    console.log('üí™ Workout page loaded successfully!');

    // ==============================================
    // PROGRESS TRACKING FUNCTIONS
    // ==============================================

    // Initialize progress tracking
    async function initializeProgressTracking() {
      console.log('üìä Initializing progress tracking...');
      
      // Test database connectivity for progress features
      const dbTest = await testProgressPhotosDatabase();
      if (!dbTest.success) {
        console.warn('‚ö†Ô∏è Database not ready:', dbTest.error);
        if (dbTest.solution) {
          showToast(`Database setup needed: ${dbTest.solution}`, 'warning');
        }
      }
      
      // Set default dates for modals
      document.getElementById('measurementDate').valueAsDate = new Date();
      document.getElementById('prDate').valueAsDate = new Date();
      document.getElementById('photoDate').valueAsDate = new Date();
      
      // Populate exercise dropdown for PR modal
      populatePRExerciseDropdown();
      
      // Load progress data from database
      await loadProgressData();
      
      // Initialize charts with delay to ensure DOM is ready
      setTimeout(() => {
        initializeCharts();
      }, 500);
      
      // Update progress stats
      await updateProgressStats();
      
      // Load achievement badges
      updateAchievementBadges();
      
      // Update progress photos display
      updateProgressPhotos();
      
      console.log('‚úÖ Progress tracking initialized');
    }

    // Test database connectivity for progress photos
    async function testProgressPhotosDatabase() {
      console.log('üîç Testing progress photos database connection...');
      
      if (typeof supabase === 'undefined') {
        console.error('‚ùå Supabase not available');
        return { success: false, error: 'Supabase not initialized' };
      }

      try {
        // Test auth
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          console.error('‚ùå No authenticated user');
          return { success: false, error: 'Not authenticated' };
        }

        // Test progress_photos table exists
        const { data, error } = await supabase
          .from('progress_photos')
          .select('count', { count: 'exact' })
          .limit(1);

        if (error) {
          console.error('‚ùå Progress photos table test failed:', error.message);
          
          if (error.message.includes('relation') && error.message.includes('does not exist')) {
            return { 
              success: false, 
              error: 'progress_photos table not found',
              solution: 'Apply supabase-progress-tracking-schema.sql in Supabase Dashboard'
            };
          }
          
          return { success: false, error: error.message };
        }

        console.log('‚úÖ Progress photos database connection successful');
        return { success: true };
        
      } catch (error) {
        console.error('‚ùå Database test error:', error);
        return { success: false, error: error.message };
      }
    }

    // Load progress data from Supabase and localStorage
    async function loadProgressData() {
      console.log('üìä Loading progress data...');
      
      // Always load from localStorage first (immediate data)
      try {
        const localBodyMeasurements = localStorage.getItem('bodyMeasurements');
        const localPersonalRecords = localStorage.getItem('personalRecords');
        const localProgressPhotos = localStorage.getItem('progressPhotos');
        const localAchievements = localStorage.getItem('unlockedAchievements');

        bodyMeasurements = localBodyMeasurements ? JSON.parse(localBodyMeasurements) : [];
        personalRecords = localPersonalRecords ? JSON.parse(localPersonalRecords) : [];
        progressPhotos = localProgressPhotos ? JSON.parse(localProgressPhotos) : [];
        unlockedAchievements = localAchievements ? JSON.parse(localAchievements) : [];

        console.log('üìä Loaded from localStorage:', {
          measurements: bodyMeasurements.length,
          prs: personalRecords.length,
          photos: progressPhotos.length,
          achievements: unlockedAchievements.length
        });
      } catch (error) {
        console.warn('Error loading from localStorage:', error);
        bodyMeasurements = [];
        personalRecords = [];
        progressPhotos = [];
        unlockedAchievements = [];
      }

      // Try to sync with database if available
      if (typeof supabase !== 'undefined') {
        try {
          const { data: { session } } = await supabase.auth.getSession();
          
          if (session && session.user) {
            const userId = session.user.id;
            console.log('üìä Syncing with database...');

            // Load body measurements
            try {
              const { data: measurements, error: measurementsError } = await supabase
                .from('body_measurements')
                .select('*')
                .eq('user_id', userId)
                .order('date', { ascending: true });

              if (!measurementsError && measurements) {
                bodyMeasurements = measurements;
                localStorage.setItem('bodyMeasurements', JSON.stringify(bodyMeasurements));
              }
            } catch (e) {
              console.warn('Could not load body measurements from database');
            }

            // Load personal records
            try {
              const { data: records, error: recordsError } = await supabase
                .from('personal_records')
                .select('*')
                .eq('user_id', userId)
                .order('date', { ascending: false });

              if (!recordsError && records) {
                personalRecords = records;
                localStorage.setItem('personalRecords', JSON.stringify(personalRecords));
              }
            } catch (e) {
              console.warn('Could not load personal records from database');
            }

            // Load progress photos
            try {
              const { data: photos, error: photosError } = await supabase
                .from('progress_photos')
                .select('*')
                .eq('user_id', userId)
                .order('date', { ascending: false });

              if (!photosError && photos) {
                // Merge database photos with local photos (database takes precedence)
                const dbPhotoIds = new Set(photos.map(p => p.id));
                const localOnlyPhotos = progressPhotos.filter(p => !dbPhotoIds.has(p.id));
                
                progressPhotos = [...photos, ...localOnlyPhotos];
                localStorage.setItem('progressPhotos', JSON.stringify(progressPhotos));
              }
            } catch (e) {
              console.warn('Could not load progress photos from database');
            }

            // Load achievements
            try {
              const { data: achievements, error: achievementsError } = await supabase
                .from('user_achievements')
                .select('*')
                .eq('user_id', userId);

              if (!achievementsError && achievements) {
                unlockedAchievements = achievements?.map(a => a.achievement_id) || [];
                localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedAchievements));
              }
            } catch (e) {
              console.warn('Could not load achievements from database');
            }
            
            console.log('üìä Final data after database sync:', {
              measurements: bodyMeasurements.length,
              prs: personalRecords.length,
              photos: progressPhotos.length,
              achievements: unlockedAchievements.length
            });
          }
        } catch (error) {
          console.warn('Database sync failed, using localStorage data:', error);
        }
      } else {
        console.log('üìä Using localStorage only (Supabase not available)');
      }
    }

    // Initialize charts
    function initializeCharts() {
      console.log('üìà Initializing charts...');
      
      // Workout Frequency Chart
      const ctx1 = document.getElementById('workoutFrequencyChart');
      if (ctx1) {
        workoutFrequencyChart = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
              label: 'Workouts This Week',
              data: [2, 1, 3, 2, 4, 1, 2], // Sample data
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                labels: { color: 'rgba(255, 255, 255, 0.8)' }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: 'rgba(255, 255, 255, 0.7)' }
              },
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: 'rgba(255, 255, 255, 0.7)' }
              }
            }
          }
        });
        console.log('‚úÖ Workout frequency chart initialized');
      }

      // Body Measurements Chart
      const ctx2 = document.getElementById('bodyMeasurementsChart');
      if (ctx2) {
        bodyMeasurementsChart = new Chart(ctx2, {
          type: 'line',
          data: {
            labels: bodyMeasurements.map(m => new Date(m.date).toLocaleDateString()),
            datasets: [
              {
                label: 'Weight (lbs)',
                data: bodyMeasurements.map(m => m.weight_lbs || 0),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
              },
              {
                label: 'Body Fat %',
                data: bodyMeasurements.map(m => m.body_fat_percentage || 0),
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                labels: { color: 'rgba(255, 255, 255, 0.8)' }
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: 'rgba(255, 255, 255, 0.7)' }
              },
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: 'rgba(255, 255, 255, 0.7)' }
              }
            }
          }
        });
        console.log('‚úÖ Body measurements chart initialized');
      }

      // Strength Progress Chart
      const ctx3 = document.getElementById('strengthProgressChart');
      if (ctx3) {
        const exerciseData = getTopPRs();
        strengthProgressChart = new Chart(ctx3, {
          type: 'bar',
          data: {
            labels: exerciseData.map(pr => pr.exercise),
            datasets: [{
              label: 'Max Weight (lbs)',
              data: exerciseData.map(pr => pr.weight),
              backgroundColor: 'rgba(220, 53, 69, 0.3)',
              borderColor: '#dc3545',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                labels: { color: 'rgba(255, 255, 255, 0.8)' }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: 'rgba(255, 255, 255, 0.7)' }
              },
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: 'rgba(255, 255, 255, 0.7)' }
              }
            }
          }
        });
        console.log('‚úÖ Strength progress chart initialized');
      }
    }

    // Get top PRs for chart
    function getTopPRs() {
      const prsByExercise = {};
      personalRecords.forEach(pr => {
        if (!prsByExercise[pr.exercise_name] || pr.weight_lbs > prsByExercise[pr.exercise_name]) {
          prsByExercise[pr.exercise_name] = pr.weight_lbs;
        }
      });
      
      return Object.entries(prsByExercise)
        .map(([exercise, weight]) => ({ exercise, weight }))
        .sort((a, b) => b.weight - a.weight)
        .slice(0, 8); // Top 8 exercises
    }

    // Populate exercise dropdown for PR modal
    function populatePRExerciseDropdown() {
      const select = document.getElementById('prExercise');
      if (select && exerciseLibrary.length > 0) {
        select.innerHTML = '<option value="">Select exercise</option>';
        
        const strengthExercises = exerciseLibrary.filter(ex => 
          ['chest', 'back', 'shoulders', 'arms', 'legs'].includes(ex.category)
        );
        
        strengthExercises.forEach(exercise => {
          const option = document.createElement('option');
          option.value = exercise.name;
          option.textContent = exercise.name;
          select.appendChild(option);
        });
      }
    }

    // Modal functions
    function addBodyMeasurement() {
      new bootstrap.Modal(document.getElementById('bodyMeasurementModal')).show();
    }

    function addPersonalRecord() {
      populatePRExerciseDropdown();
      new bootstrap.Modal(document.getElementById('personalRecordModal')).show();
    }

    function addProgressPhoto() {
      // Reset the modal form
      document.getElementById('progressPhotoForm').reset();
      document.getElementById('photoPreview').style.display = 'none';
      
      // Reset upload area
      const uploadArea = document.querySelector('.file-upload-area');
      uploadArea.style.borderColor = '';
      uploadArea.innerHTML = `
        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
        <p class="mb-0">Click to upload or drag & drop</p>
        <small class="text-muted">Supports: JPG, PNG, GIF (Max 5MB)</small>
      `;
      
      // Set default date to today
      document.getElementById('photoDate').valueAsDate = new Date();
      
      new bootstrap.Modal(document.getElementById('progressPhotoModal')).show();
    }

    // Save functions
    async function saveBodyMeasurement() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        showToast('Please log in to save measurements', 'error');
        return;
      }

      const measurement = {
        user_id: session.user.id,
        date: document.getElementById('measurementDate').value,
        weight_lbs: parseFloat(document.getElementById('bodyWeight').value) || null,
        body_fat_percentage: parseFloat(document.getElementById('bodyFat').value) || null,
        muscle_mass_lbs: parseFloat(document.getElementById('muscleMass').value) || null,
        chest_inches: parseFloat(document.getElementById('chestMeasurement').value) || null,
        waist_inches: parseFloat(document.getElementById('waistMeasurement').value) || null,
        arms_inches: parseFloat(document.getElementById('armMeasurement').value) || null
      };

      if (!measurement.date) {
        showToast('Please select a date', 'error');
        return;
      }

      try {
        // Use upsert to handle duplicate dates
        const { data, error } = await supabase
          .from('body_measurements')
          .upsert(measurement, { 
            onConflict: 'user_id,date',
            ignoreDuplicates: false 
          })
          .select()
          .single();

        if (error) {
          console.error('Error saving body measurement:', error);
          showToast('Error saving measurement. Please try again.', 'error');
          return;
        }

        // Update local data
        const existingIndex = bodyMeasurements.findIndex(m => 
          m.user_id === measurement.user_id && m.date === measurement.date
        );
        
        if (existingIndex >= 0) {
          bodyMeasurements[existingIndex] = data;
        } else {
          bodyMeasurements.push(data);
          bodyMeasurements.sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        updateProgressStats();
        updateBodyMeasurementsChart();
        
        bootstrap.Modal.getInstance(document.getElementById('bodyMeasurementModal')).hide();
        document.getElementById('bodyMeasurementForm').reset();
        
        showToast('Body measurement saved successfully!', 'success');

      } catch (error) {
        console.error('Error saving body measurement:', error);
        showToast('Error saving measurement. Please try again.', 'error');
      }
    }

    async function savePersonalRecord() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        showToast('Please log in to save personal records', 'error');
        return;
      }

      const pr = {
        user_id: session.user.id,
        exercise_name: document.getElementById('prExercise').value,
        weight_lbs: parseFloat(document.getElementById('prWeight').value),
        reps: parseInt(document.getElementById('prReps').value),
        date: document.getElementById('prDate').value,
        notes: document.getElementById('prNotes').value || null
      };

      if (!pr.exercise_name || !pr.weight_lbs || !pr.reps || !pr.date) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('personal_records')
          .insert(pr)
          .select()
          .single();

        if (error) {
          console.error('Error saving personal record:', error);
          showToast('Error saving personal record. Please try again.', 'error');
          return;
        }

        // Update local data
        personalRecords.unshift(data);
        
        updateProgressStats();
        updateStrengthProgressChart();
        
        bootstrap.Modal.getInstance(document.getElementById('personalRecordModal')).hide();
        document.getElementById('personalRecordForm').reset();
        
        showToast('Personal record saved! üèÜ', 'success');

      } catch (error) {
        console.error('Error saving personal record:', error);
        showToast('Error saving personal record. Please try again.', 'error');
      }
    }

    async function saveProgressPhoto() {
      const photoFile = document.getElementById('photoUpload').files[0];
      if (!photoFile) {
        showToast('Please select a photo', 'error');
        return;
      }

      // Quick database connectivity test for better user feedback
      const dbTest = await testProgressPhotosDatabase();
      if (!dbTest.success && dbTest.solution) {
        console.warn('‚ö†Ô∏è Database not ready:', dbTest.error);
        showToast(`Setup needed: ${dbTest.solution}`, 'info');
      }

      const date = document.getElementById('photoDate').value;
      const category = document.getElementById('photoCategory').value;
      const notes = document.getElementById('photoNotes').value;

      if (!date || !category) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      // Validate file size (max 5MB)
      if (photoFile.size > 5 * 1024 * 1024) {
        showToast('Photo size must be less than 5MB', 'error');
        return;
      }

      // Validate file type
      if (!photoFile.type.startsWith('image/')) {
        showToast('Please select a valid image file', 'error');
        return;
      }

      // Show loading state
      const saveButton = document.querySelector('#progressPhotoModal .btn-primary');
      const originalText = saveButton.innerHTML;
      saveButton.innerHTML = '‚è≥ Uploading...';
      saveButton.disabled = true;

      try {
        console.log('üì∏ Starting photo upload...');
        
        // Convert file to base64 for storage (with compression)
        const base64 = await convertImageToBase64(photoFile);
        
        const photoData = {
          id: Date.now(),
          image_url: base64,
          date: date,
          category: category,
          notes: notes || '',
          created_at: new Date().toISOString(),
          file_name: photoFile.name,
          file_size: photoFile.size
        };

        console.log('üì∏ Photo data prepared:', {
          size: Math.round(photoFile.size / 1024) + 'KB',
          category,
          date
        });

        // Save to local storage first (always works)
        progressPhotos.unshift(photoData);
        localStorage.setItem('progressPhotos', JSON.stringify(progressPhotos));
        console.log('üì∏ Photo saved to localStorage');

        // Try to save to Supabase database if available
        let databaseSaved = false;
        if (typeof supabase !== 'undefined') {
          try {
            // Check if user is authenticated
            const { data: { session } } = await supabase.auth.getSession();
            
                          if (session && session.user) {
                // Try database-first approach with Supabase Storage
                const userId = session.user.id;
                const timestamp = Date.now();
                const fileExt = photoFile.name.split('.').pop();
                const fileName = `${userId}/${timestamp}_${category}.${fileExt}`;

                // Try uploading to Supabase Storage first
                try {
                const { data: uploadData, error: uploadError } = await supabase.storage
                  .from('progress-photos')
                  .upload(fileName, photoFile, {
                    cacheControl: '3600',
                    upsert: false
                  });

                if (!uploadError) {
                  // Get public URL
                  const { data: { publicUrl } } = supabase.storage
                    .from('progress-photos')
                    .getPublicUrl(fileName);

                  // Save metadata to database with storage URL
                  const dbPhotoData = {
                    user_id: userId,
                    image_url: publicUrl,
                    storage_path: fileName,
                    date: date,
                    category: category,
                    notes: notes || null
                  };

                  const { data, error } = await supabase
                    .from('progress_photos')
                    .insert(dbPhotoData)
                    .select()
                    .single();

                  if (!error) {
                    // Update local data with database version
                    progressPhotos[0] = { ...data, id: data.id };
                    localStorage.setItem('progressPhotos', JSON.stringify(progressPhotos));
                    databaseSaved = true;
                    console.log('‚úÖ Photo saved to Supabase Storage and database');
                  } else {
                    // Clean up uploaded file if database insert fails
                    await supabase.storage.from('progress-photos').remove([fileName]);
                    throw error;
                  }
                } else {
                  throw uploadError;
                }
              } catch (storageError) {
                console.warn('‚ö†Ô∏è Supabase Storage not available, trying database with base64...');
                
                // Fallback: try saving base64 to database directly
                const dbPhotoData = {
                  user_id: userId,
                  image_url: base64,
                  storage_path: null,
                  date: date,
                  category: category,
                  notes: notes || null
                };

                const { data, error } = await supabase
                  .from('progress_photos')
                  .insert(dbPhotoData)
                  .select()
                  .single();

                if (!error) {
                  // Update local data with database version
                  progressPhotos[0] = { ...data, id: data.id };
                  localStorage.setItem('progressPhotos', JSON.stringify(progressPhotos));
                  databaseSaved = true;
                  console.log('‚úÖ Photo saved to database with base64');
                } else {
                  throw error;
                }
              }
            } else {
              console.warn('‚ö†Ô∏è No authenticated user for database save');
            }
          } catch (dbError) {
            console.warn('‚ö†Ô∏è Database save failed:', dbError.message);
          }
        } else {
          console.warn('‚ö†Ô∏è Supabase not available, using localStorage only');
        }

        // Close modal and refresh display
        const modal = bootstrap.Modal.getInstance(document.getElementById('progressPhotoModal'));
        modal.hide();
        document.getElementById('progressPhotoForm').reset();
        document.getElementById('photoPreview').style.display = 'none';
        
        // Update the photos display
        updateProgressPhotos();
        
        // Show success message
        const message = databaseSaved ? 
          'Progress photo saved successfully! üì∏' : 
          'Photo saved locally! üì∏ (Will sync to database when available)';
        showToast(message, 'success');

        console.log('‚úÖ Photo upload completed successfully');

      } catch (error) {
        console.error('‚ùå Error saving progress photo:', error);
        showToast('Error uploading photo. Please try again.', 'error');
      } finally {
        // Reset button state
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
      }
    }

    // Convert image to base64 with compression
    function convertImageToBase64(file) {
      return new Promise((resolve, reject) => {
        // For large images, compress them first
        if (file.size > 1024 * 1024) { // 1MB
          compressAndConvertImage(file, 0.7)
            .then(resolve)
            .catch(reject);
        } else {
          // Small images, convert directly
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        }
      });
    }

    // Compress and convert image
    function compressAndConvertImage(file, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
          // Calculate new dimensions (max 1200px width/height)
          const maxSize = 1200;
          let { width, height } = img;
          
          if (width > maxSize || height > maxSize) {
            const ratio = Math.min(maxSize / width, maxSize / height);
            width *= ratio;
            height *= ratio;
          }
          
          canvas.width = width;
          canvas.height = height;
          
          // Draw and compress
          ctx.drawImage(img, 0, 0, width, height);
          
          // Convert to base64
          const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(compressedDataUrl);
        };
        
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    // Photo preview function with validation
    function previewPhoto(input) {
      const previewContainer = document.getElementById('photoPreview');
      const previewImage = document.getElementById('previewImage');
      
      if (!input.files || !input.files[0]) {
        previewContainer.style.display = 'none';
        return;
      }

      const file = input.files[0];
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showToast('Please select a valid image file (JPG, PNG, GIF)', 'error');
        input.value = '';
        previewContainer.style.display = 'none';
        return;
      }
      
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showToast('Image too large. Please select a file smaller than 5MB', 'error');
        input.value = '';
        previewContainer.style.display = 'none';
        return;
      }

      // Show file info
      const fileInfo = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
      let fileInfoElement = document.getElementById('fileInfo');
      if (!fileInfoElement) {
        fileInfoElement = document.createElement('small');
        fileInfoElement.id = 'fileInfo';
        fileInfoElement.className = 'text-muted d-block mt-1';
        previewContainer.appendChild(fileInfoElement);
      }
      fileInfoElement.textContent = fileInfo;

      // Preview the image
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        previewContainer.style.display = 'block';
        
        // Update upload area to show success
        const uploadArea = document.querySelector('.file-upload-area');
        uploadArea.style.borderColor = '#28a745';
        uploadArea.innerHTML = `
          <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
          <p class="mb-0 text-success">Photo selected successfully!</p>
          <small class="text-muted">Click to change photo</small>
        `;
      };
      reader.onerror = function() {
        showToast('Error reading file. Please try again.', 'error');
        input.value = '';
        previewContainer.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    // Update chart functions
    function updateBodyMeasurementsChart() {
      if (bodyMeasurementsChart && bodyMeasurements.length > 0) {
        bodyMeasurementsChart.data.labels = bodyMeasurements.map(m => new Date(m.date).toLocaleDateString());
        bodyMeasurementsChart.data.datasets[0].data = bodyMeasurements.map(m => m.weight_lbs || 0);
        bodyMeasurementsChart.data.datasets[1].data = bodyMeasurements.map(m => m.body_fat_percentage || 0);
        bodyMeasurementsChart.update();
      }
    }

    function updateStrengthProgressChart() {
      if (strengthProgressChart) {
        const exerciseData = getTopPRs();
        strengthProgressChart.data.labels = exerciseData.map(pr => pr.exercise);
        strengthProgressChart.data.datasets[0].data = exerciseData.map(pr => pr.weight);
        strengthProgressChart.update();
      }
    }

    function updateProgressPhotos() {
      const container = document.getElementById('progressPhotos');
      if (!container) {
        console.warn('Progress photos container not found');
        return;
      }
      
      console.log('üì∏ Updating progress photos display:', progressPhotos.length, 'photos');
      
      if (progressPhotos.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-4">
            <div class="empty-state">
              <i class="fas fa-camera fa-3x text-muted mb-3"></i>
              <h5 class="text-soft-white">No Progress Photos Yet</h5>
              <p class="text-muted">Start tracking your transformation by adding your first progress photo!</p>
              <button class="btn btn-primary btn-sm" onclick="addProgressPhoto()">
                <i class="fas fa-plus"></i> Add First Photo
              </button>
            </div>
          </div>
        `;
        return;
      }

      // Sort photos by date (newest first)
      const sortedPhotos = [...progressPhotos].sort((a, b) => new Date(b.date) - new Date(a.date));

      container.innerHTML = sortedPhotos.map(photo => {
        const photoDate = new Date(photo.date);
        const formattedDate = photoDate.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: photoDate.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
        });
        
        return `
          <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-3">
            <div class="progress-photo" onclick="viewPhotoFullSize('${photo.image_url}', '${photo.category}', '${photo.date}', '${photo.notes || ''}')">
              <div class="photo-container">
                <img src="${photo.image_url}" alt="Progress photo - ${photo.category}" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiPkltYWdlIE5vdCBGb3VuZDwvdGV4dD4KPC9zdmc+'">
                <div class="photo-overlay">
                  <div class="photo-info">
                    <span class="photo-date">${formattedDate}</span>
                    <span class="photo-category">${photo.category}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      console.log('‚úÖ Progress photos display updated');
    }

    // View photo in full size modal
    function viewPhotoFullSize(imageUrl, category, date, notes = '') {
      const formattedDate = new Date(date).toLocaleDateString('en-US', { 
        weekday: 'long',
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const modalHtml = `
        <div class="modal fade" id="photoViewModal" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content progress-modal">
              <div class="modal-header">
                <h5 class="modal-title">üì∏ ${category.charAt(0).toUpperCase() + category.slice(1)} View</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body text-center">
                <div class="photo-viewer">
                  <img src="${imageUrl}" class="img-fluid rounded shadow" alt="Progress photo" style="max-height: 70vh; max-width: 100%;">
                </div>
                <div class="photo-details mt-4">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="text-soft-white mb-1">üìÖ Date</h6>
                      <p class="text-muted">${formattedDate}</p>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-soft-white mb-1">üìÇ Category</h6>
                      <p class="text-muted">${category.charAt(0).toUpperCase() + category.slice(1)} View</p>
                    </div>
                  </div>
                  ${notes ? `
                    <div class="mt-3">
                      <h6 class="text-soft-white mb-1">üìù Notes</h6>
                      <p class="text-muted">${notes}</p>
                    </div>
                  ` : ''}
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="deleteProgressPhoto('${imageUrl}', '${date}')">
                  <i class="fas fa-trash"></i> Delete Photo
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('photoViewModal');
      if (existingModal) existingModal.remove();
      
      // Add new modal
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('photoViewModal'));
      modal.show();
      
      // Auto-cleanup when modal is hidden
      document.getElementById('photoViewModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
      }, { once: true });
    }

    // Delete progress photo
    function deleteProgressPhoto(imageUrl, date) {
      if (!confirm('Are you sure you want to delete this progress photo? This action cannot be undone.')) {
        return;
      }

      // Find and remove the photo
      const photoIndex = progressPhotos.findIndex(photo => 
        photo.image_url === imageUrl && photo.date === date
      );

      if (photoIndex !== -1) {
        const photo = progressPhotos[photoIndex];
        
        // Remove from local storage
        progressPhotos.splice(photoIndex, 1);
        localStorage.setItem('progressPhotos', JSON.stringify(progressPhotos));
        
        // Try to remove from database if it has an ID
        if (typeof supabase !== 'undefined' && photo.id && typeof photo.id === 'string') {
          supabase.from('progress_photos')
            .delete()
            .eq('id', photo.id)
            .then(({ error }) => {
              if (error) {
                console.warn('Could not delete photo from database:', error);
              } else {
                console.log('‚úÖ Photo deleted from database');
              }
            });

          // If there's a storage path, try to delete from storage too
          if (photo.storage_path) {
            supabase.storage
              .from('progress-photos')
              .remove([photo.storage_path])
              .then(({ error }) => {
                if (error) {
                  console.warn('Could not delete photo from storage:', error);
                } else {
                  console.log('‚úÖ Photo deleted from storage');
                }
              });
          }
        }

        // Update display
        updateProgressPhotos();
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('photoViewModal'));
        if (modal) modal.hide();
        
        showToast('Progress photo deleted', 'success');
      }
    }

    // Drag and drop handlers for photo upload
    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const photoInput = document.getElementById('photoUpload');
        photoInput.files = files;
        previewPhoto(photoInput);
      }
    }

        // Update progress statistics
    async function updateProgressStats() {
      console.log('üìä Updating progress stats...', {
        workoutHistory: workoutHistory.length,
        personalRecords: personalRecords.length
      });

      const totalWorkouts = workoutHistory.length;
      const totalTime = workoutHistory.reduce((sum, session) => sum + (session.duration_minutes || 0), 0);
      const totalPRs = personalRecords.length;
      const currentStreak = calculateWorkoutStreak();

      console.log('üìä Calculated stats:', {
        totalWorkouts,
        totalTime,
        totalPRs,
        currentStreak
      });

      // Update the UI elements
      const totalWorkoutsEl = document.getElementById('totalWorkoutsCount');
      const totalTimeEl = document.getElementById('totalTimeSpent');
      const personalRecordsEl = document.getElementById('personalRecords');
      const currentStreakEl = document.getElementById('currentStreak');

      if (totalWorkoutsEl) totalWorkoutsEl.textContent = totalWorkouts;
      if (totalTimeEl) totalTimeEl.textContent = `${Math.round(totalTime / 60)}h`;
      if (personalRecordsEl) personalRecordsEl.textContent = totalPRs;
      if (currentStreakEl) currentStreakEl.textContent = currentStreak;

      await checkAchievements({
        totalWorkouts,
        totalPRs,
        totalPhotos: progressPhotos.length,
        currentStreak,
        monthlyWorkouts: getMonthlyWorkouts(),
        weightEntries: bodyMeasurements.filter(m => m.weight_lbs).length
      });

      console.log('‚úÖ Progress stats updated');
    }

    // Calculate workout streak
    function calculateWorkoutStreak() {
      if (workoutHistory.length === 0) return 0;
      
      const sortedHistory = workoutHistory
        .filter(session => session.end_time && session.completed)
        .sort((a, b) => new Date(b.end_time) - new Date(a.end_time));
      
      let streak = 0;
      let currentDate = new Date();
      currentDate.setHours(0, 0, 0, 0);
      
      for (const session of sortedHistory) {
        const sessionDate = new Date(session.end_time);
        sessionDate.setHours(0, 0, 0, 0);
        
        const daysDiff = (currentDate - sessionDate) / (1000 * 60 * 60 * 24);
        
        if (daysDiff <= 1) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }
      
      return streak;
    }

    function getMonthlyWorkouts() {
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      
      return workoutHistory.filter(session => 
        session.end_time && session.completed && new Date(session.end_time) >= startOfMonth
      ).length;
    }

    // Achievement system
    async function checkAchievements(data) {
      let newAchievements = [];
      
      achievements.forEach(achievement => {
        if (!unlockedAchievements.includes(achievement.id) && achievement.condition(data)) {
          unlockedAchievements.push(achievement.id);
          newAchievements.push(achievement);
        }
      });
      
      if (newAchievements.length > 0) {
        await saveAchievements(newAchievements);
        updateAchievementBadges();
        
        newAchievements.forEach(achievement => {
          showToast(`üèÜ Achievement Unlocked: ${achievement.name}!`, 'success');
        });
      }
    }

    // Save achievements to database
    async function saveAchievements(newAchievements) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session || !session.user) return;

        const achievementData = newAchievements.map(achievement => ({
          user_id: session.user.id,
          achievement_id: achievement.id,
          achievement_name: achievement.name
        }));

        const { error } = await supabase
          .from('user_achievements')
          .insert(achievementData);

        if (error) {
          console.error('Error saving achievements:', error);
        } else {
          console.log('‚úÖ Achievements saved to database');
        }
      } catch (error) {
        console.error('Error saving achievements:', error);
      }
    }

    function updateAchievementBadges() {
      const container = document.getElementById('achievementBadges');
      if (!container) return;

      container.innerHTML = achievements.map(achievement => {
        const isUnlocked = unlockedAchievements.includes(achievement.id);
        return `
          <div class="achievement-badge ${isUnlocked ? '' : 'locked'}" title="${achievement.description}">
            ${achievement.name}
          </div>
        `;
      }).join('');
    }

    // =============================================
    // SMART FEATURES FUNCTIONALITY
    // =============================================

    // AI Workout Suggestions
    async function generateAIWorkoutSuggestion() {
      const goal = document.getElementById('fitnessGoal').value;
      const level = document.getElementById('experienceLevel').value;
      const time = document.getElementById('timeAvailable').value;

      if (!goal || !level || !time) {
        showToast('Please fill in all fields for accurate suggestions', 'warning');
        return;
      }

      const container = document.getElementById('aiWorkoutSuggestion');
      
      // Show loading
      container.style.display = 'block';
      container.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Generating AI workout...</span>
          </div>
          <p class="mt-2">AI is analyzing your preferences...</p>
        </div>
      `;

      // Simulate AI processing
      setTimeout(() => {
        const suggestions = generateWorkoutByGoal(goal, level, time);
        displayAIWorkoutSuggestion(suggestions);
      }, 2000);
    }

    function generateWorkoutByGoal(goal, level, time) {
      const workoutDatabase = {
        'muscle-gain': {
          beginner: {
            30: ['Push-ups', 'Squats', 'Plank', 'Dumbbell Rows'],
            45: ['Bench Press', 'Squats', 'Rows', 'Shoulder Press', 'Plank'],
            60: ['Bench Press', 'Squats', 'Deadlifts', 'Rows', 'Shoulder Press', 'Bicep Curls'],
            90: ['Bench Press', 'Incline Press', 'Squats', 'Deadlifts', 'Rows', 'Shoulder Press', 'Bicep Curls', 'Tricep Dips']
          },
          intermediate: {
            30: ['Bench Press', 'Squats', 'Pull-ups', 'Dips'],
            45: ['Bench Press', 'Incline Press', 'Squats', 'Romanian Deadlifts', 'Pull-ups'],
            60: ['Bench Press', 'Incline Press', 'Squats', 'Deadlifts', 'Pull-ups', 'Rows', 'Shoulder Press'],
            90: ['Bench Press', 'Incline Press', 'Decline Press', 'Squats', 'Deadlifts', 'Pull-ups', 'Rows', 'Shoulder Press', 'Bicep Curls', 'Tricep Extensions']
          },
          advanced: {
            30: ['Heavy Squats', 'Weighted Pull-ups', 'Dips', 'Plank'],
            45: ['Squats', 'Deadlifts', 'Bench Press', 'Pull-ups', 'Shoulder Press'],
            60: ['Squats', 'Deadlifts', 'Bench Press', 'Incline Press', 'Pull-ups', 'Rows', 'Overhead Press'],
            90: ['Squats', 'Deadlifts', 'Bench Press', 'Incline Press', 'Pull-ups', 'Rows', 'Overhead Press', 'Bulgarian Split Squats', 'Weighted Dips', 'Face Pulls']
          }
        },
        'weight-loss': {
          beginner: {
            30: ['Jumping Jacks', 'Bodyweight Squats', 'Mountain Climbers', 'Burpees'],
            45: ['Treadmill Walk', 'Squats', 'Push-ups', 'Mountain Climbers', 'Plank'],
            60: ['Cardio Circuit', 'Squats', 'Push-ups', 'Lunges', 'Mountain Climbers', 'Burpees'],
            90: ['Cardio Warm-up', 'Full Body Circuit', 'Squats', 'Push-ups', 'Lunges', 'Burpees', 'Planks', 'Cool-down Stretch']
          },
          intermediate: {
            30: ['HIIT Circuit', 'Burpees', 'Mountain Climbers', 'Jump Squats'],
            45: ['HIIT Training', 'Kettlebell Swings', 'Burpees', 'Mountain Climbers', 'Battle Ropes'],
            60: ['Cardio Circuit', 'Strength Training', 'HIIT', 'Kettlebell Swings', 'Burpees', 'Core Work'],
            90: ['Extended Cardio', 'Strength Circuit', 'HIIT Session', 'Functional Training', 'Core Workout', 'Flexibility']
          },
          advanced: {
            30: ['HIIT Sprints', 'Plyometric Circuit', 'Tabata Training'],
            45: ['Advanced HIIT', 'Metabolic Circuit', 'Plyometrics', 'Core Blaster'],
            60: ['Compound HIIT', 'Strength Superset', 'Cardio Finisher', 'Advanced Core'],
            90: ['Extended HIIT', 'Strength Training', 'Cardio Intervals', 'Plyometric Work', 'Core & Flexibility']
          }
        },
        'strength': {
          beginner: {
            30: ['Squats', 'Push-ups', 'Rows', 'Plank'],
            45: ['Squats', 'Bench Press', 'Rows', 'Overhead Press', 'Plank'],
            60: ['Squats', 'Deadlifts', 'Bench Press', 'Rows', 'Overhead Press', 'Core Work'],
            90: ['Squats', 'Deadlifts', 'Bench Press', 'Rows', 'Overhead Press', 'Accessory Work', 'Core Training']
          },
          intermediate: {
            30: ['Heavy Squats', 'Bench Press', 'Rows', 'Core'],
            45: ['Squats', 'Deadlifts', 'Bench Press', 'Pull-ups', 'Overhead Press'],
            60: ['Big 3 Focus', 'Squats', 'Deadlifts', 'Bench Press', 'Accessory Work'],
            90: ['Powerlifting Focus', 'Squats', 'Deadlifts', 'Bench Press', 'Overhead Press', 'Accessory Movements']
          },
          advanced: {
            30: ['Max Effort Squats', 'Heavy Bench', 'Power Cleans'],
            45: ['Powerlifting Session', 'Heavy Compounds', 'Technical Work'],
            60: ['Strength Focus', 'Heavy Squats', 'Deadlifts', 'Bench Press', 'Speed Work'],
            90: ['Competition Prep', 'Max Effort Training', 'Speed Work', 'Accessory Volume', 'Recovery Work']
          }
        },
        'endurance': {
          beginner: {
            30: ['Light Cardio', 'Bodyweight Circuit', 'Stretching'],
            45: ['Steady Cardio', 'Bodyweight Exercises', 'Core Work'],
            60: ['Cardio Base', 'Circuit Training', 'Flexibility Work'],
            90: ['Extended Cardio', 'Full Body Circuit', 'Yoga/Stretching']
          },
          intermediate: {
            30: ['Interval Training', 'Circuit Work', 'Active Recovery'],
            45: ['Cardio Intervals', 'Functional Training', 'Core Stability'],
            60: ['Endurance Training', 'Cross Training', 'Strength Endurance'],
            90: ['Long Cardio Session', 'Strength Circuit', 'Recovery Activities']
          },
          advanced: {
            30: ['High Intensity Intervals', 'Speed Work'],
            45: ['Advanced Cardio', 'Sport-Specific Training'],
            60: ['Endurance Base', 'Lactate Threshold Work', 'Strength Endurance'],
            90: ['Extended Endurance', 'Multi-Modal Training', 'Recovery & Mobility']
          }
        },
        'general-fitness': {
          beginner: {
            30: ['Walking', 'Basic Bodyweight', 'Stretching'],
            45: ['Light Cardio', 'Bodyweight Exercises', 'Flexibility'],
            60: ['Balanced Workout', 'Cardio', 'Strength', 'Flexibility'],
            90: ['Full Fitness Session', 'Cardio', 'Strength Training', 'Flexibility', 'Fun Activities']
          },
          intermediate: {
            30: ['Quick Full Body', 'Cardio Burst', 'Core Work'],
            45: ['Balanced Training', 'Cardio', 'Strength', 'Flexibility'],
            60: ['Complete Workout', 'Cardio', 'Strength Training', 'Functional Movement'],
            90: ['Extended Session', 'Varied Training', 'Multiple Modalities', 'Recovery']
          },
          advanced: {
            30: ['Efficient Training', 'Compound Movements', 'Quick Cardio'],
            45: ['Advanced Full Body', 'Varied Intensity', 'Skill Work'],
            60: ['Complete Training', 'Strength', 'Cardio', 'Mobility', 'Skills'],
            90: ['Comprehensive Session', 'Multiple Training Styles', 'Recovery Work', 'Skill Development']
          }
        }
      };

      const exercises = workoutDatabase[goal]?.[level]?.[time] || ['General Exercise Selection'];
      const tips = getWorkoutTips(goal, level);
      
      return {
        exercises,
        tips,
        goal,
        level,
        time
      };
    }

    function getWorkoutTips(goal, level) {
      const tips = {
        'muscle-gain': {
          beginner: ['Focus on form over weight', 'Start with 3 sets of 8-12 reps', 'Rest 60-90 seconds between sets', 'Progressive overload is key'],
          intermediate: ['Aim for 3-4 sets of 6-10 reps', 'Focus on compound movements', 'Track your weights', 'Consider split routines'],
          advanced: ['Periodize your training', 'Focus on progressive overload', 'Use advanced techniques', 'Monitor recovery closely']
        },
        'weight-loss': {
          beginner: ['Start slow and build up', 'Focus on consistency', 'Combine with proper nutrition', 'Stay hydrated'],
          intermediate: ['Increase intensity gradually', 'Mix cardio and strength', 'Track your workouts', 'Monitor heart rate'],
          advanced: ['Use HIIT effectively', 'Periodize your cardio', 'Maintain muscle mass', 'Optimize recovery']
        },
        'strength': {
          beginner: ['Master basic movements', 'Focus on compound exercises', 'Start light and progress', 'Learn proper form'],
          intermediate: ['Follow a structured program', 'Track your lifts', 'Focus on big 3', 'Progressive overload'],
          advanced: ['Periodize training', 'Peak for competition', 'Address weak points', 'Technical refinement']
        },
        'endurance': {
          beginner: ['Build aerobic base', 'Start with low intensity', 'Focus on time, not speed', 'Listen to your body'],
          intermediate: ['Add interval training', 'Cross train regularly', 'Monitor training load', 'Periodize training'],
          advanced: ['Sport-specific training', 'High volume base', 'Lactate threshold work', 'Taper properly']
        },
        'general-fitness': {
          beginner: ['Start with basics', 'Focus on movement quality', 'Be consistent', 'Enjoy the process'],
          intermediate: ['Add variety', 'Challenge yourself', 'Set specific goals', 'Track progress'],
          advanced: ['Maintain balance', 'Prevent overuse', 'Stay motivated', 'Help others']
        }
      };
      
      return tips[goal]?.[level] || ['Focus on consistency and proper form'];
    }

    function displayAIWorkoutSuggestion(suggestions) {
      const container = document.getElementById('aiWorkoutSuggestion');
      
      container.innerHTML = `
        <div class="alert alert-info">
          <h6>üéØ AI Workout Suggestion for ${suggestions.goal.replace('-', ' ').toUpperCase()}</h6>
          <p><strong>Level:</strong> ${suggestions.level} | <strong>Duration:</strong> ${suggestions.time} minutes</p>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <h6>Recommended Exercises:</h6>
            <ul class="list-unstyled">
              ${suggestions.exercises.map(exercise => `<li>‚Ä¢ ${exercise}</li>`).join('')}
            </ul>
          </div>
          <div class="col-md-6">
            <h6>Pro Tips:</h6>
            <ul class="list-unstyled">
              ${suggestions.tips.map(tip => `<li>üí° ${tip}</li>`).join('')}
            </ul>
          </div>
        </div>
        
        <div class="text-center mt-3">
          <button class="btn btn-outline-primary" onclick="createWorkoutFromAI(${JSON.stringify(suggestions.exercises).replace(/"/g, '&quot;')})">
            ‚ú® Create Workout from AI Suggestion
          </button>
        </div>
      `;
    }

    function createWorkoutFromAI(exercises) {
      // Auto-fill workout creation form with AI suggestions
      document.getElementById('workoutName').value = `AI Generated Workout - ${new Date().toLocaleDateString()}`;
      document.getElementById('workoutCategory').value = 'custom';
      document.getElementById('workoutDescription').value = 'Generated by AI based on your fitness goals and preferences.';
      
      // Switch to templates tab and open create workout modal
      const templatesTab = document.getElementById('templates-tab');
      templatesTab.click();
      
      setTimeout(() => {
        const createWorkoutModal = new bootstrap.Modal(document.getElementById('createWorkoutModal'));
        createWorkoutModal.show();
        
        // Pre-select exercises that match AI suggestions
        setTimeout(() => {
          populateExerciseSelection();
          // Auto-select matching exercises
          exercises.forEach(exerciseName => {
            const exerciseElements = document.querySelectorAll('.exercise-selection-item');
            exerciseElements.forEach(element => {
              if (element.textContent.toLowerCase().includes(exerciseName.toLowerCase())) {
                element.click();
              }
            });
          });
        }, 500);
      }, 100);
      
      showToast('AI workout loaded! Review and save when ready.', 'success');
    }

    // Form Checker
    async function getFormTips() {
      const exerciseName = document.getElementById('formExercise').value;
      if (!exerciseName) {
        showToast('Please select an exercise first', 'warning');
        return;
      }

      const container = document.getElementById('formTips');
      container.style.display = 'block';
      container.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading form tips...</span>
          </div>
          <p class="mt-2">Analyzing exercise form...</p>
        </div>
      `;

      // Simulate loading
      setTimeout(() => {
        const tips = getExerciseFormTips(exerciseName);
        displayFormTips(tips, exerciseName);
      }, 1500);
    }

    function getExerciseFormTips(exerciseName) {
      const formTipsDatabase = {
        'bench-press': {
          setup: ['Lie flat on bench with eyes under the bar', 'Grip bar slightly wider than shoulder width', 'Retract shoulder blades and arch back slightly'],
          execution: ['Unrack with straight arms', 'Lower bar to chest with control', 'Press bar straight up', 'Keep core tight throughout'],
          warnings: ['Never bounce bar off chest', 'Don\'t let wrists bend back', 'Avoid lifting head off bench', 'Use spotter for heavy weights'],
          breathing: ['Take deep breath before lowering', 'Hold breath during lift', 'Exhale at top of movement']
        },
        'squats': {
          setup: ['Stand with feet shoulder-width apart', 'Point toes slightly outward', 'Bar should rest on traps, not neck', 'Keep chest up and core tight'],
          execution: ['Initiate with hips moving back', 'Keep knees in line with toes', 'Descend until thighs parallel', 'Drive through heels to stand'],
          warnings: ['Don\'t let knees cave inward', 'Avoid forward lean', 'Don\'t rise on toes', 'Maintain neutral spine'],
          breathing: ['Breathe deep at top', 'Hold breath during descent', 'Exhale on way up']
        },
        'deadlifts': {
          setup: ['Stand with bar over mid-foot', 'Feet hip-width apart', 'Grip bar just outside legs', 'Keep back straight'],
          execution: ['Lift by extending hips and knees', 'Keep bar close to body', 'Stand tall at top', 'Reverse the movement to lower'],
          warnings: ['Never round your back', 'Don\'t let bar drift away', 'Avoid jerky movements', 'Use proper grip'],
          breathing: ['Big breath before lift', 'Hold breath during lift', 'Exhale at top']
        },
        'push-ups': {
          setup: ['Start in plank position', 'Hands under shoulders', 'Body in straight line', 'Engage core'],
          execution: ['Lower chest to floor', 'Keep elbows at 45 degrees', 'Push back to start', 'Maintain straight line'],
          warnings: ['Don\'t let hips sag', 'Avoid flaring elbows wide', 'Don\'t rush the movement', 'Keep head neutral'],
          breathing: ['Inhale on the way down', 'Exhale on the way up', 'Breathe rhythmically']
        },
        'pull-ups': {
          setup: ['Hang from bar with arms extended', 'Grip slightly wider than shoulders', 'Engage core and squeeze glutes', 'Start from dead hang'],
          execution: ['Pull up leading with chest', 'Get chin over bar', 'Lower with control', 'Return to dead hang'],
          warnings: ['Don\'t swing or kip', 'Avoid partial reps', 'Don\'t let shoulders roll forward', 'Control the descent'],
          breathing: ['Breathe out pulling up', 'Breathe in going down', 'Don\'t hold breath']
        }
      };

      const exerciseKey = exerciseName.toLowerCase().replace(/\s+/g, '-');
      return formTipsDatabase[exerciseKey] || {
        setup: ['Maintain proper posture', 'Start with appropriate weight', 'Focus on the target muscles'],
        execution: ['Move through full range of motion', 'Control both lifting and lowering phases', 'Maintain good form throughout'],
        warnings: ['Don\'t use momentum', 'Avoid jerky movements', 'Listen to your body', 'Use spotter when needed'],
        breathing: ['Coordinate breathing with movement', 'Don\'t hold breath unnecessarily', 'Exhale on exertion']
      };
    }

    function displayFormTips(tips, exerciseName) {
      const container = document.getElementById('formTips');
      
      container.innerHTML = `
        <div class="alert alert-success">
          <h6>üìã Form Tips for ${exerciseName}</h6>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <h6 class="text-success">‚úÖ Setup</h6>
            <ul class="list-unstyled">
              ${tips.setup.map(tip => `<li>‚Ä¢ ${tip}</li>`).join('')}
            </ul>
          </div>
          <div class="col-md-6 mb-3">
            <h6 class="text-info">üîÑ Execution</h6>
            <ul class="list-unstyled">
              ${tips.execution.map(tip => `<li>‚Ä¢ ${tip}</li>`).join('')}
            </ul>
          </div>
          <div class="col-md-6 mb-3">
            <h6 class="text-warning">‚ö†Ô∏è Common Mistakes</h6>
            <ul class="list-unstyled">
              ${tips.warnings.map(tip => `<li>‚Ä¢ ${tip}</li>`).join('')}
            </ul>
          </div>
          <div class="col-md-6 mb-3">
            <h6 class="text-primary">ü´Å Breathing</h6>
            <ul class="list-unstyled">
              ${tips.breathing.map(tip => `<li>‚Ä¢ ${tip}</li>`).join('')}
            </ul>
          </div>
        </div>
      `;
    }

    // Recovery Recommendations
    async function generateRecoveryPlan() {
      const container = document.getElementById('recoveryRecommendations');
      
      container.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Analyzing your training...</span>
          </div>
          <p class="mt-2">Analyzing your recent workouts...</p>
        </div>
      `;

      // Analyze recent workouts
      setTimeout(() => {
        const recovery = analyzeRecoveryNeeds();
        displayRecoveryRecommendations(recovery);
      }, 2000);
    }

    function analyzeRecoveryNeeds() {
      const recentWorkouts = workoutHistory.slice(0, 7); // Last 7 workouts
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      const recentSessions = recentWorkouts.filter(workout => 
        workout.completed_at && new Date(workout.completed_at) >= weekAgo
      );

      const workoutFrequency = recentSessions.length;
      const avgDuration = recentSessions.reduce((sum, session) => sum + (session.duration || 0), 0) / (recentSessions.length || 1);
      const daysSinceLastWorkout = recentSessions.length > 0 ? 
        Math.floor((today - new Date(recentSessions[0].completed_at)) / (1000 * 60 * 60 * 24)) : 7;

      let recoveryLevel = 'optimal';
      let recommendations = [];

      // Determine recovery needs
      if (workoutFrequency >= 6) {
        recoveryLevel = 'high-stress';
        recommendations = [
          'Take 1-2 complete rest days this week',
          'Focus on gentle activities like walking or yoga',
          'Prioritize sleep (8+ hours per night)',
          'Consider a massage or foam rolling session',
          'Increase protein intake for muscle recovery'
        ];
      } else if (workoutFrequency >= 4) {
        recoveryLevel = 'moderate-stress';
        recommendations = [
          'Schedule at least 1 rest day',
          'Include active recovery activities',
          'Ensure adequate sleep (7-8 hours)',
          'Stay hydrated throughout the day',
          'Consider light stretching or yoga'
        ];
      } else if (workoutFrequency <= 2) {
        recoveryLevel = 'low-stress';
        recommendations = [
          'You can increase workout frequency if desired',
          'Focus on consistency over intensity',
          'Maintain regular sleep schedule',
          'Include mobility work in your routine',
          'Stay active on non-gym days'
        ];
      } else {
        recoveryLevel = 'optimal';
        recommendations = [
          'Great balance of work and recovery!',
          'Continue current routine',
          'Listen to your body for adjustment cues',
          'Maintain good sleep habits',
          'Include variety in your workouts'
        ];
      }

      return {
        level: recoveryLevel,
        recommendations,
        stats: {
          weeklyWorkouts: workoutFrequency,
          avgDuration: Math.round(avgDuration),
          daysSinceLastWorkout
        }
      };
    }

    function displayRecoveryRecommendations(recovery) {
      const container = document.getElementById('recoveryRecommendations');
      
      const levelColors = {
        'high-stress': 'danger',
        'moderate-stress': 'warning', 
        'low-stress': 'info',
        'optimal': 'success'
      };

      const levelIcons = {
        'high-stress': 'üî¥',
        'moderate-stress': 'üü°',
        'low-stress': 'üîµ', 
        'optimal': 'üü¢'
      };

      container.innerHTML = `
        <div class="alert alert-${levelColors[recovery.level]}">
          <h6>${levelIcons[recovery.level]} Recovery Status: ${recovery.level.replace('-', ' ').toUpperCase()}</h6>
          <small>Weekly workouts: ${recovery.stats.weeklyWorkouts} | Avg duration: ${recovery.stats.avgDuration}min | Days since last: ${recovery.stats.daysSinceLastWorkout}</small>
        </div>
        
        <h6>Recommendations:</h6>
        <ul class="list-unstyled">
          ${recovery.recommendations.map(rec => `<li>üí° ${rec}</li>`).join('')}
        </ul>
        
        <div class="mt-3">
          <button class="btn btn-outline-primary btn-sm me-2" onclick="scheduleRestDay()">
            üìÖ Schedule Rest Day
          </button>
          <button class="btn btn-outline-info btn-sm" onclick="showRecoveryActivities()">
            üßò Recovery Activities
          </button>
        </div>
      `;
    }

    function scheduleRestDay() {
      showToast('Rest day reminder set! üõå', 'success');
      // Add rest day to notification system
      addSmartNotification('rest-day', 'Take a well-deserved rest day today! Your body needs time to recover and grow stronger. üõåüí™', 'info');
    }

    function showRecoveryActivities() {
      const activities = [
        'üßò Gentle yoga or stretching (20-30 minutes)',
        'üö∂ Light walking in nature (30-45 minutes)', 
        'üõÅ Warm bath with Epsom salts',
        'üíÜ Self-massage or foam rolling',
        'üìö Relaxing activities like reading',
        'üéµ Meditation or breathing exercises',
        'üí§ Extra sleep (aim for 8+ hours)',
        'ü•ó Focus on nutritious, anti-inflammatory foods'
      ];

      showToast(`Recovery Activities:\n${activities.join('\n')}`, 'info');
    }

    // Sleep Tracking
    function logSleep() {
      const hours = prompt('How many hours did you sleep last night?');
      if (hours && !isNaN(hours) && hours > 0 && hours <= 24) {
        addSleepEntry(parseFloat(hours));
        showToast(`Sleep logged: ${hours} hours üò¥`, 'success');
      } else if (hours !== null) {
        showToast('Please enter a valid number of hours (0-24)', 'warning');
      }
    }

    function addSleepEntry(hours) {
      const sleepData = JSON.parse(localStorage.getItem('sleepData') || '[]');
      const today = new Date().toISOString().split('T')[0];
      
      // Remove existing entry for today if any
      const filtered = sleepData.filter(entry => entry.date !== today);
      
      // Add new entry
      filtered.push({ date: today, hours: hours });
      
      // Keep only last 30 days
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      const recent = filtered.filter(entry => new Date(entry.date) >= thirtyDaysAgo);
      
      localStorage.setItem('sleepData', JSON.stringify(recent));
      updateSleepStats();
    }

    function updateSleepStats() {
      const sleepData = JSON.parse(localStorage.getItem('sleepData') || '[]');
      const recent7Days = sleepData.slice(-7);
      
      if (recent7Days.length > 0) {
        const avgSleep = recent7Days.reduce((sum, entry) => sum + entry.hours, 0) / recent7Days.length;
        document.getElementById('avgSleepHours').textContent = `${avgSleep.toFixed(1)}h`;
      }
    }

    // Nutrition Functions
    function addMeal() {
      const meal = prompt('What did you eat? (e.g., "Chicken breast, rice, vegetables")');
      if (meal) {
        const calories = estimateCalories(meal);
        addNutritionEntry(meal, calories);
        showToast(`Meal logged: ${meal} (~${calories} calories) üçΩÔ∏è`, 'success');
      }
    }

    function estimateCalories(meal) {
      // Simple calorie estimation based on keywords
      const mealLower = meal.toLowerCase();
      let calories = 0;
      
      // Protein sources
      if (mealLower.includes('chicken')) calories += 300;
      if (mealLower.includes('beef')) calories += 400;
      if (mealLower.includes('fish')) calories += 250;
      if (mealLower.includes('egg')) calories += 150;
      
      // Carbs
      if (mealLower.includes('rice')) calories += 200;
      if (mealLower.includes('pasta')) calories += 250;
      if (mealLower.includes('bread')) calories += 150;
      if (mealLower.includes('potato')) calories += 150;
      
      // Vegetables
      if (mealLower.includes('vegetable') || mealLower.includes('salad')) calories += 50;
      
      // Default if no matches
      if (calories === 0) calories = 300;
      
      return calories;
    }

    function addNutritionEntry(meal, calories) {
      const nutritionData = JSON.parse(localStorage.getItem('nutritionData') || '[]');
      const today = new Date().toISOString().split('T')[0];
      
      nutritionData.push({
        date: today,
        meal: meal,
        calories: calories,
        protein: Math.round(calories * 0.25 / 4), // Rough estimate
        carbs: Math.round(calories * 0.45 / 4),
        fat: Math.round(calories * 0.30 / 9)
      });
      
      localStorage.setItem('nutritionData', JSON.stringify(nutritionData));
      updateNutritionStats();
    }

    function updateNutritionStats() {
      const nutritionData = JSON.parse(localStorage.getItem('nutritionData') || '[]');
      const today = new Date().toISOString().split('T')[0];
      const todayMeals = nutritionData.filter(entry => entry.date === today);
      
      const totalCalories = todayMeals.reduce((sum, meal) => sum + meal.calories, 0);
      const totalProtein = todayMeals.reduce((sum, meal) => sum + meal.protein, 0);
      const totalCarbs = todayMeals.reduce((sum, meal) => sum + meal.carbs, 0);
      const totalFat = todayMeals.reduce((sum, meal) => sum + meal.fat, 0);
      
      document.getElementById('caloriesConsumed').textContent = totalCalories;
      document.getElementById('proteinConsumed').textContent = `${totalProtein}g`;
      document.getElementById('carbsConsumed').textContent = `${totalCarbs}g`;
      document.getElementById('fatConsumed').textContent = `${totalFat}g`;
    }

    function generateMealPlan() {
      const container = document.getElementById('mealPlan');
      container.style.display = 'block';
      
      const mealPlans = {
        breakfast: ['Oatmeal with berries and protein powder', 'Greek yogurt with nuts and fruit', 'Eggs with whole grain toast', 'Protein smoothie with banana'],
        lunch: ['Grilled chicken with quinoa and vegetables', 'Salmon salad with mixed greens', 'Turkey wrap with hummus', 'Protein bowl with beans and rice'],
        dinner: ['Lean beef with sweet potato and broccoli', 'Baked fish with brown rice and asparagus', 'Chicken stir-fry with vegetables', 'Lentil curry with quinoa'],
        snacks: ['Apple with almond butter', 'Greek yogurt with berries', 'Handful of nuts', 'Protein bar']
      };
      
      const selectedMeals = {
        breakfast: mealPlans.breakfast[Math.floor(Math.random() * mealPlans.breakfast.length)],
        lunch: mealPlans.lunch[Math.floor(Math.random() * mealPlans.lunch.length)],
        dinner: mealPlans.dinner[Math.floor(Math.random() * mealPlans.dinner.length)],
        snack: mealPlans.snacks[Math.floor(Math.random() * mealPlans.snacks.length)]
      };
      
      container.innerHTML = `
        <div class="alert alert-info">
          <h6>üçΩÔ∏è Today's Meal Plan</h6>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <h6>üåÖ Breakfast</h6>
            <p>${selectedMeals.breakfast}</p>
          </div>
          <div class="col-md-6 mb-3">
            <h6>üåû Lunch</h6>
            <p>${selectedMeals.lunch}</p>
          </div>
          <div class="col-md-6 mb-3">
            <h6>üåô Dinner</h6>
            <p>${selectedMeals.dinner}</p>
          </div>
          <div class="col-md-6 mb-3">
            <h6>üçé Snack</h6>
            <p>${selectedMeals.snack}</p>
          </div>
        </div>
        <div class="text-center">
          <button class="btn btn-outline-primary btn-sm" onclick="generateMealPlan()">
            üîÑ Generate New Plan
          </button>
        </div>
      `;
    }

    // Hydration Tracking
    function addWater() {
      const currentIntake = parseInt(localStorage.getItem('dailyWaterIntake') || '0');
      const newIntake = currentIntake + 1;
      
      localStorage.setItem('dailyWaterIntake', newIntake.toString());
      updateHydrationDisplay();
      
      if (newIntake === 8) {
        showToast('Congratulations! You\'ve reached your daily hydration goal! üíß‚ú®', 'success');
      } else if (newIntake < 8) {
        showToast(`Great! ${8 - newIntake} more glasses to reach your goal üíß`, 'info');
      } else {
        showToast('Excellent hydration! Keep it up! üíß', 'success');
      }
    }

    function updateHydrationDisplay() {
      const intake = parseInt(localStorage.getItem('dailyWaterIntake') || '0');
      const goal = 8; // 8 glasses per day
      const percentage = Math.min((intake / goal) * 100, 100);
      
      document.getElementById('waterIntake').textContent = intake;
      document.getElementById('hydrationProgress').style.width = `${percentage}%`;
    }

    // Smart Notifications
    function saveNotificationSettings() {
      const settings = {
        dailyWorkoutReminder: document.getElementById('dailyWorkoutReminder').checked,
        restDayReminder: document.getElementById('restDayReminder').checked,
        motivationMessages: document.getElementById('motivationMessages').checked,
        streakReminders: document.getElementById('streakReminders').checked,
        prCelebrations: document.getElementById('prCelebrations').checked,
        progressPhotoReminder: document.getElementById('progressPhotoReminder').checked,
        measurementReminder: document.getElementById('measurementReminder').checked,
        hydrationReminder: document.getElementById('hydrationReminder').checked,
        mealPlanReminder: document.getElementById('mealPlanReminder').checked,
        workoutTime: document.getElementById('workoutTime').value
      };
      
      localStorage.setItem('notificationSettings', JSON.stringify(settings));
      showToast('Notification settings saved! üîî', 'success');
      
      // Setup notifications based on settings
      setupSmartNotifications(settings);
    }

    function loadNotificationSettings() {
      const settings = JSON.parse(localStorage.getItem('notificationSettings') || '{}');
      
      Object.keys(settings).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
          if (element.type === 'checkbox') {
            element.checked = settings[key];
          } else {
            element.value = settings[key];
          }
        }
      });
      
      if (Object.keys(settings).length > 0) {
        setupSmartNotifications(settings);
      }
    }

    function setupSmartNotifications(settings) {
      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
      
      // Setup daily notifications
      if (settings.dailyWorkoutReminder) {
        scheduleWorkoutReminder(settings.workoutTime);
      }
      
      if (settings.motivationMessages) {
        scheduleDailyMotivation();
      }
      
      if (settings.hydrationReminder) {
        scheduleHydrationReminders();
      }
    }

    function scheduleWorkoutReminder(time) {
      // This would typically use Service Workers for real notifications
      // For demo, we'll add to the notification display
      addSmartNotification('workout-reminder', `Time for your workout! üí™ Let's crush those goals!`, 'primary');
    }

    function scheduleDailyMotivation() {
      const motivationMessages = [
        "Every workout is progress! üí™",
        "You're stronger than yesterday! üî•",
        "Champions are made in the gym! üèÜ",
        "Push through, you've got this! üíØ",
        "Your only competition is yesterday's you! ‚≠ê"
      ];
      
      const randomMessage = motivationMessages[Math.floor(Math.random() * motivationMessages.length)];
      addSmartNotification('motivation', randomMessage, 'success');
    }

    function scheduleHydrationReminders() {
      addSmartNotification('hydration', 'Time to hydrate! Drink a glass of water üíß', 'info');
    }

    function addSmartNotification(type, message, alertType = 'info') {
      const notifications = JSON.parse(localStorage.getItem('smartNotifications') || '[]');
      const notification = {
        id: Date.now(),
        type: type,
        message: message,
        alertType: alertType,
        timestamp: new Date().toISOString(),
        read: false
      };
      
      notifications.unshift(notification);
      
      // Keep only last 10 notifications
      if (notifications.length > 10) {
        notifications.splice(10);
      }
      
      localStorage.setItem('smartNotifications', JSON.stringify(notifications));
      updateNotificationsList();
      
      // Show browser notification if permission granted
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Gymcyclopedia', {
          body: message,
          icon: '/favicon.ico'
        });
      }
    }

    function updateNotificationsList() {
      const notifications = JSON.parse(localStorage.getItem('smartNotifications') || '[]');
      const container = document.getElementById('notificationsList');
      
      if (notifications.length === 0) {
        container.innerHTML = '<p class="text-muted">No recent notifications</p>';
        return;
      }
      
      container.innerHTML = notifications.map(notification => `
        <div class="alert alert-${notification.alertType} py-2 mb-2">
          <small class="text-muted">${new Date(notification.timestamp).toLocaleString()}</small>
          <div>${notification.message}</div>
        </div>
      `).join('');
    }

    // Initialize smart features when page loads
    function initializeSmartFeatures() {
      // Populate form exercise dropdown
      const formExerciseSelect = document.getElementById('formExercise');
      if (formExerciseSelect && exerciseLibrary.length > 0) {
        formExerciseSelect.innerHTML = '<option value="">Choose exercise for form tips</option>' +
          exerciseLibrary.map(exercise => `<option value="${exercise.name}">${exercise.name}</option>`).join('');
      }
      
      // Load saved notification settings
      loadNotificationSettings();
      
      // Update various displays
      updateSleepStats();
      updateNutritionStats();
      updateHydrationDisplay();
      updateNotificationsList();
      
      // Reset daily data if new day
      resetDailyDataIfNewDay();
    }

    function resetDailyDataIfNewDay() {
      const today = new Date().toISOString().split('T')[0];
      const lastResetDate = localStorage.getItem('lastResetDate');
      
      if (lastResetDate !== today) {
        localStorage.setItem('dailyWaterIntake', '0');
        localStorage.setItem('lastResetDate', today);
        updateHydrationDisplay();
        updateNutritionStats();
      }
    }

    // ========================================
    // ENHANCED WORKOUT TIMER SYSTEM
    // ========================================

    let workoutTimer = {
      isRunning: false,
      isPaused: false,
      currentTime: 0,
      totalTime: 0,
      currentSet: 1,
      totalSets: 3,
      isRestPeriod: false,
      currentExercise: '',
      interval: null,
      audioContext: null
    };

    // Initialize audio context for timer sounds
    function initializeAudio() {
      try {
        workoutTimer.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        console.warn('Audio not supported for timer alerts');
      }
    }

    // Play timer sound
    function playTimerSound(frequency = 800, duration = 200) {
      if (!workoutTimer.audioContext) return;
      
      const oscillator = workoutTimer.audioContext.createOscillator();
      const gainNode = workoutTimer.audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(workoutTimer.audioContext.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, workoutTimer.audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, workoutTimer.audioContext.currentTime + duration / 1000);
      
      oscillator.start(workoutTimer.audioContext.currentTime);
      oscillator.stop(workoutTimer.audioContext.currentTime + duration / 1000);
    }

    // Start exercise timer
    function startExerciseTimer(exerciseName = null) {
      if (workoutTimer.isRunning && !workoutTimer.isPaused) {
        return; // Already running
      }

      // Initialize audio on first interaction
      if (!workoutTimer.audioContext) {
        initializeAudio();
      }

      if (workoutTimer.isPaused) {
        // Resume from pause
        workoutTimer.isPaused = false;
      } else {
        // Start new timer
        workoutTimer.currentTime = parseInt(document.getElementById('exerciseTime').value);
        workoutTimer.totalTime = workoutTimer.currentTime;
        workoutTimer.totalSets = parseInt(document.getElementById('currentSets').value);
        workoutTimer.isRestPeriod = false;
        workoutTimer.currentExercise = exerciseName || 'Current Exercise';
      }

      workoutTimer.isRunning = true;
      
      // Update UI
      document.getElementById('startTimerBtn').style.display = 'none';
      document.getElementById('pauseTimerBtn').style.display = 'inline-block';
      document.getElementById('timerLabel').textContent = workoutTimer.isRestPeriod ? 'Rest' : 'Exercise';
      
      if (exerciseName) {
        document.getElementById('currentExerciseTimer').style.display = 'block';
        document.getElementById('currentExerciseTimer').textContent = exerciseName;
      }

      updateSetInfo();
      
      // Start countdown
      workoutTimer.interval = setInterval(updateTimer, 1000);
      
      // Play start sound
      playTimerSound(600, 300);
      
      showToast(`Timer started! ${workoutTimer.isRestPeriod ? 'Rest' : 'Exercise'} time: ${Math.floor(workoutTimer.currentTime / 60)}:${(workoutTimer.currentTime % 60).toString().padStart(2, '0')}`, 'info');
    }

    // Pause exercise timer
    function pauseExerciseTimer() {
      if (!workoutTimer.isRunning) return;
      
      workoutTimer.isPaused = true;
      workoutTimer.isRunning = false;
      
      clearInterval(workoutTimer.interval);
      
      // Update UI
      document.getElementById('startTimerBtn').style.display = 'inline-block';
      document.getElementById('pauseTimerBtn').style.display = 'none';
      document.getElementById('startTimerBtn').innerHTML = '‚ñ∂Ô∏è Resume';
      
      playTimerSound(400, 200);
      showToast('Timer paused', 'warning');
    }

    // Stop exercise timer
    function stopExerciseTimer() {
      workoutTimer.isRunning = false;
      workoutTimer.isPaused = false;
      clearInterval(workoutTimer.interval);
      
      // Reset timer
      workoutTimer.currentTime = 0;
      workoutTimer.currentSet = 1;
      
      // Update UI
      document.getElementById('startTimerBtn').style.display = 'inline-block';
      document.getElementById('pauseTimerBtn').style.display = 'none';
      document.getElementById('startTimerBtn').innerHTML = '‚ñ∂Ô∏è Start Timer';
      document.getElementById('timerDisplay').textContent = '0:00';
      document.getElementById('timerLabel').textContent = 'Ready';
      document.getElementById('currentExerciseTimer').style.display = 'none';
      
      // Reset progress circle
      const progressCircle = document.getElementById('timerProgress');
      progressCircle.style.strokeDashoffset = '408';
      progressCircle.style.stroke = '#007bff';
      
      updateSetInfo();
      
      playTimerSound(300, 300);
      showToast('Timer stopped', 'info');
    }

    // Skip current timer phase
    function skipExerciseTimer() {
      if (!workoutTimer.isRunning && !workoutTimer.isPaused) {
        showToast('Timer not active', 'warning');
        return;
      }
      
      // Move to next phase
      completeCurrentTimerPhase();
      playTimerSound(700, 200);
      showToast('Skipped to next phase', 'info');
    }

    // Update timer display and progress
    function updateTimer() {
      if (workoutTimer.currentTime <= 0) {
        completeCurrentTimerPhase();
        return;
      }
      
      workoutTimer.currentTime--;
      
      // Update display
      const minutes = Math.floor(workoutTimer.currentTime / 60);
      const seconds = workoutTimer.currentTime % 60;
      document.getElementById('timerDisplay').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Update progress circle
      const progress = (workoutTimer.totalTime - workoutTimer.currentTime) / workoutTimer.totalTime;
      const offset = 408 - (408 * progress);
      document.getElementById('timerProgress').style.strokeDashoffset = offset;
      
      // Color changes based on time remaining
      const progressCircle = document.getElementById('timerProgress');
      if (workoutTimer.currentTime <= 5) {
        progressCircle.style.stroke = '#dc3545'; // Red for last 5 seconds
        if (workoutTimer.currentTime <= 3) {
          playTimerSound(800, 100); // Beep for last 3 seconds
        }
      } else if (workoutTimer.currentTime <= 10) {
        progressCircle.style.stroke = '#ffc107'; // Yellow for last 10 seconds
      } else {
        progressCircle.style.stroke = workoutTimer.isRestPeriod ? '#28a745' : '#007bff';
      }
    }

    // Complete current timer phase and move to next
    function completeCurrentTimerPhase() {
      playTimerSound(1000, 500); // Completion sound
      
      if (workoutTimer.isRestPeriod) {
        // Rest period complete, start next set
        workoutTimer.currentSet++;
        workoutTimer.isRestPeriod = false;
        
        if (workoutTimer.currentSet > workoutTimer.totalSets) {
          // All sets complete
          showToast('üéâ All sets completed! Great job!', 'success');
          stopExerciseTimer();
          return;
        }
        
        // Start next exercise set
        workoutTimer.currentTime = parseInt(document.getElementById('exerciseTime').value);
        workoutTimer.totalTime = workoutTimer.currentTime;
        document.getElementById('timerLabel').textContent = 'Exercise';
        
        showToast(`Set ${workoutTimer.currentSet} of ${workoutTimer.totalSets} - Let's go! üí™`, 'success');
        
      } else {
        // Exercise complete, start rest period
        workoutTimer.isRestPeriod = true;
        workoutTimer.currentTime = parseInt(document.getElementById('restTime').value);
        workoutTimer.totalTime = workoutTimer.currentTime;
        document.getElementById('timerLabel').textContent = 'Rest';
        
        showToast(`Set ${workoutTimer.currentSet} complete! Rest time üòå`, 'info');
      }
      
      updateSetInfo();
      
      // Reset progress circle color
      document.getElementById('timerProgress').style.stroke = workoutTimer.isRestPeriod ? '#28a745' : '#007bff';
    }

    // Update set information display
    function updateSetInfo() {
      const setInfo = document.getElementById('setInfo');
      if (workoutTimer.currentSet > workoutTimer.totalSets) {
        setInfo.innerHTML = '<strong>üéâ Workout Complete!</strong> | Amazing work!';
        setInfo.className = 'alert alert-success mb-3';
      } else {
        const nextPhase = workoutTimer.isRestPeriod ? 'Exercise' : 'Rest';
        setInfo.innerHTML = `<strong>Set ${workoutTimer.currentSet} of ${workoutTimer.totalSets}</strong> | Next: ${nextPhase}`;
        setInfo.className = `alert ${workoutTimer.isRestPeriod ? 'alert-warning' : 'alert-info'} mb-3`;
      }
    }

    // Auto-start timer for specific exercise
    function startTimerForExercise(exerciseName, sets = 3) {
      document.getElementById('currentSets').value = sets;
      workoutTimer.currentSet = 1;
      workoutTimer.totalSets = sets;
      startExerciseTimer(exerciseName);
    }

    // ========================================
    // ACHIEVEMENT/BADGE SYSTEM
    // ========================================

    let achievementSystem = {
      badges: [],
      unlockedBadges: [],
      stats: {
        totalWorkouts: 0,
        totalExercises: 0,
        longestStreak: 0,
        currentStreak: 0,
        personalRecords: 0,
        totalTimeExercised: 0
      }
    };

    // Define available badges
    const availableBadges = [
      {
        id: 'first_workout',
        name: 'First Steps',
        description: 'Complete your first workout',
        icon: 'üèÉ',
        requirement: 'Complete 1 workout',
        check: (stats) => stats.totalWorkouts >= 1
      },
      {
        id: 'workout_week',
        name: 'Week Warrior',
        description: 'Complete 7 workouts',
        icon: '‚ö°',
        requirement: 'Complete 7 workouts',
        check: (stats) => stats.totalWorkouts >= 7
      },
      {
        id: 'workout_month',
        name: 'Monthly Master',
        description: 'Complete 30 workouts',
        icon: 'üèÜ',
        requirement: 'Complete 30 workouts',
        check: (stats) => stats.totalWorkouts >= 30
      },
      {
        id: 'streak_3',
        name: 'Streak Starter',
        description: '3-day workout streak',
        icon: 'üî•',
        requirement: '3 consecutive workout days',
        check: (stats) => stats.currentStreak >= 3
      },
      {
        id: 'streak_7',
        name: 'Week Streak',
        description: '7-day workout streak',
        icon: 'üî•üî•',
        requirement: '7 consecutive workout days',
        check: (stats) => stats.currentStreak >= 7
      },
      {
        id: 'streak_30',
        name: 'Unstoppable',
        description: '30-day workout streak',
        icon: 'üî•üî•üî•',
        requirement: '30 consecutive workout days',
        check: (stats) => stats.currentStreak >= 30
      },
      {
        id: 'early_bird',
        name: 'Early Bird',
        description: 'Complete a workout before 7 AM',
        icon: 'üåÖ',
        requirement: 'Workout before 7 AM',
        check: (stats, context) => context && context.workoutTime && new Date(context.workoutTime).getHours() < 7
      },
      {
        id: 'night_owl',
        name: 'Night Owl',
        description: 'Complete a workout after 10 PM',
        icon: 'ü¶â',
        requirement: 'Workout after 10 PM',
        check: (stats, context) => context && context.workoutTime && new Date(context.workoutTime).getHours() >= 22
      },
      {
        id: 'hundred_exercises',
        name: 'Exercise Expert',
        description: 'Complete 100 exercises',
        icon: 'üí™',
        requirement: 'Complete 100 exercises',
        check: (stats) => stats.totalExercises >= 100
      },
      {
        id: 'personal_record',
        name: 'Record Breaker',
        description: 'Set your first personal record',
        icon: 'üìà',
        requirement: 'Set 1 personal record',
        check: (stats) => stats.personalRecords >= 1
      },
      {
        id: 'time_warrior',
        name: 'Time Warrior',
        description: 'Exercise for 10 hours total',
        icon: '‚è∞',
        requirement: '10 hours of exercise',
        check: (stats) => stats.totalTimeExercised >= 600 // 10 hours in minutes
      },
      {
        id: 'consistency_king',
        name: 'Consistency King',
        description: 'Work out 5 times in a week',
        icon: 'üëë',
        requirement: '5 workouts in one week',
        check: (stats, context) => {
          // This would need weekly workout tracking
          return false; // Placeholder for weekly consistency check
        }
      }
    ];

    // Initialize achievement system
    function initializeAchievementSystem() {
      // Load saved data
      const savedBadges = localStorage.getItem('unlockedBadges');
      const savedStats = localStorage.getItem('achievementStats');
      
      if (savedBadges) {
        achievementSystem.unlockedBadges = JSON.parse(savedBadges);
      }
      
      if (savedStats) {
        achievementSystem.stats = { ...achievementSystem.stats, ...JSON.parse(savedStats) };
      }
      
      console.log('üèÜ Achievement system initialized');
      console.log('üìä Current stats:', achievementSystem.stats);
      console.log('üéñÔ∏è Unlocked badges:', achievementSystem.unlockedBadges.length);
    }

    // Update achievement stats
    function updateAchievementStats(statType, value = 1, context = null) {
      achievementSystem.stats[statType] = (achievementSystem.stats[statType] || 0) + value;
      
      // Save updated stats
      localStorage.setItem('achievementStats', JSON.stringify(achievementSystem.stats));
      
      // Check for new achievements
      checkNewAchievements(context);
      
      console.log(`üìä Updated ${statType}: ${achievementSystem.stats[statType]}`);
    }

    // Check for new achievements
    function checkNewAchievements(context = null) {
      const newBadges = [];
      
      availableBadges.forEach(badge => {
        // Skip if already unlocked
        if (achievementSystem.unlockedBadges.find(b => b.id === badge.id)) {
          return;
        }
        
        // Check if requirements are met
        if (badge.check(achievementSystem.stats, context)) {
          newBadges.push(badge);
          achievementSystem.unlockedBadges.push(badge);
        }
      });
      
      // Save unlocked badges
      if (newBadges.length > 0) {
        localStorage.setItem('unlockedBadges', JSON.stringify(achievementSystem.unlockedBadges));
        
        // Show achievement notifications
        newBadges.forEach(badge => {
          showAchievementNotification(badge);
          
          // Send push notification if enabled
          if (Notification.permission === 'granted') {
            sendAchievementNotification(`${badge.icon} ${badge.name}`);
          }
        });
      }
      
      return newBadges;
    }

    // Show achievement notification
    function showAchievementNotification(badge) {
      showToast(`üéâ Achievement Unlocked: ${badge.icon} ${badge.name}!`, 'success');
      
      // Create a more prominent achievement modal for significant badges
      if (['workout_month', 'streak_30', 'time_warrior'].includes(badge.id)) {
        showAchievementModal(badge);
      }
    }

    // Show achievement modal for major accomplishments
    function showAchievementModal(badge) {
      const modalHtml = `
        <div class="modal fade" id="achievementModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-gradient">
              <div class="modal-body text-center p-5">
                <div class="achievement-celebration">
                  <div class="achievement-icon mb-3" style="font-size: 4rem;">${badge.icon}</div>
                  <h3 class="text-light mb-3">üéâ Achievement Unlocked! üéâ</h3>
                  <h4 class="text-warning mb-2">${badge.name}</h4>
                  <p class="text-light-enhanced mb-4">${badge.description}</p>
                  <div class="achievement-glow mb-4">
                    <small class="text-muted">${badge.requirement}</small>
                  </div>
                  <button class="btn btn-success" data-bs-dismiss="modal">
                    üí™ Keep Going!
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal
      const existingModal = document.getElementById('achievementModal');
      if (existingModal) existingModal.remove();
      
      // Add new modal
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('achievementModal'));
      modal.show();
      
      // Auto-close after 5 seconds
      setTimeout(() => {
        modal.hide();
      }, 5000);
    }

    // Display badges in progress tab
    function displayAchievementBadges() {
      const container = document.getElementById('achievementBadges');
      if (!container) return;
      
      // Show unlocked badges
      const unlockedHtml = achievementSystem.unlockedBadges.map(badge => `
        <div class="col-md-4 col-lg-3 mb-3">
          <div class="card achievement-card unlocked">
            <div class="card-body text-center">
              <div class="achievement-icon mb-2" style="font-size: 2.5rem;">${badge.icon}</div>
              <h6 class="card-title mb-1">${badge.name}</h6>
              <small class="text-muted">${badge.description}</small>
              <div class="mt-2">
                <span class="badge bg-success">‚úÖ Unlocked</span>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      
      // Show locked badges (next to unlock)
      const nextBadges = availableBadges.filter(badge => 
        !achievementSystem.unlockedBadges.find(b => b.id === badge.id)
      ).slice(0, 6); // Show next 6 achievements
      
      const lockedHtml = nextBadges.map(badge => `
        <div class="col-md-4 col-lg-3 mb-3">
          <div class="card achievement-card locked">
            <div class="card-body text-center">
              <div class="achievement-icon mb-2 opacity-50" style="font-size: 2.5rem;">üîí</div>
              <h6 class="card-title mb-1 text-muted">${badge.name}</h6>
              <small class="text-muted">${badge.description}</small>
              <div class="mt-2">
                <span class="badge bg-secondary">${badge.requirement}</span>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = `
        <div class="row">
          <div class="col-12 mb-4">
            <h6 class="text-light-enhanced">üèÜ Unlocked Achievements (${achievementSystem.unlockedBadges.length})</h6>
          </div>
          ${unlockedHtml || '<div class="col-12"><p class="text-muted">No achievements unlocked yet. Complete your first workout to get started!</p></div>'}
        </div>
        <div class="row">
          <div class="col-12 mb-4">
            <h6 class="text-light-enhanced">üéØ Next Achievements</h6>
          </div>
          ${lockedHtml}
        </div>
      `;
    }

    // ========================================
    // WORKOUT ANALYTICS CHARTS SYSTEM
    // ========================================

    let analyticsCharts = {
      workoutFrequency: null,
      exerciseCategory: null,
      progressChart: null
    };

    // Initialize all analytics charts
    function initializeAnalyticsCharts() {
      console.log('üìä Initializing analytics charts...');
      
      // Wait for data to be loaded
      setTimeout(() => {
        createWorkoutFrequencyChart();
        createExerciseCategoryChart();
        createProgressChart();
      }, 1000);
    }

    // Create workout frequency chart (last 30 days)
    function createWorkoutFrequencyChart() {
      const ctx = document.getElementById('workoutFrequencyChart');
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (analyticsCharts.workoutFrequency) {
        analyticsCharts.workoutFrequency.destroy();
      }

      // Generate last 30 days data
      const last30Days = [];
      const workoutCounts = [];
      const today = new Date();

      for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        
        // Count workouts for this day
        const dayWorkouts = workoutHistory.filter(session => {
          const sessionDate = new Date(session.start_time).toDateString();
          return sessionDate === date.toDateString();
        }).length;
        
        workoutCounts.push(dayWorkouts);
      }

      analyticsCharts.workoutFrequency = new Chart(ctx, {
        type: 'line',
        data: {
          labels: last30Days,
          datasets: [{
            label: 'Daily Workouts',
            data: workoutCounts,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#fff'
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#fff',
                maxTicksLimit: 8
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              ticks: {
                color: '#fff',
                stepSize: 1
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            }
          }
        }
      });

      console.log('üìà Workout frequency chart created');
    }

    // Create exercise category distribution chart
    function createExerciseCategoryChart() {
      const ctx = document.getElementById('exerciseCategoryChart');
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (analyticsCharts.exerciseCategory) {
        analyticsCharts.exerciseCategory.destroy();
      }

      // Count exercises by category from workout history
      const categoryCount = {};
      
      workoutHistory.forEach(session => {
        if (session.exercises_completed) {
          // For now, we'll simulate category distribution
          // In a real app, you'd track which exercises were completed
          const categories = ['chest', 'back', 'legs', 'shoulders', 'arms', 'core', 'cardio'];
          const randomCategory = categories[Math.floor(Math.random() * categories.length)];
          categoryCount[randomCategory] = (categoryCount[randomCategory] || 0) + session.exercises_completed;
        }
      });

      // If no data, show sample data
      if (Object.keys(categoryCount).length === 0) {
        categoryCount.chest = 15;
        categoryCount.back = 12;
        categoryCount.legs = 20;
        categoryCount.shoulders = 8;
        categoryCount.arms = 10;
        categoryCount.core = 14;
        categoryCount.cardio = 6;
      }

      const labels = Object.keys(categoryCount);
      const data = Object.values(categoryCount);
      const colors = [
        '#007bff', '#28a745', '#ffc107', '#dc3545', 
        '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
      ];

      analyticsCharts.exerciseCategory = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)),
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#000'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#fff',
                padding: 10,
                usePointStyle: true
              }
            }
          }
        }
      });

      console.log('üçï Exercise category chart created');
    }

    // Create progress over time chart
    function createProgressChart() {
      const ctx = document.getElementById('progressChart');
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (analyticsCharts.progressChart) {
        analyticsCharts.progressChart.destroy();
      }

      // Generate progress data over time
      const progressData = [];
      const weightData = [];
      const labels = [];

      // Get last 12 weeks of data
      for (let i = 11; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - (i * 7));
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

        // Count workouts in this week
        const weekStart = new Date(date);
        weekStart.setDate(weekStart.getDate() - 7);
        const weekWorkouts = workoutHistory.filter(session => {
          const sessionDate = new Date(session.start_time);
          return sessionDate >= weekStart && sessionDate <= date;
        }).length;

        progressData.push(weekWorkouts);

        // Simulate weight progression (if available)
        const baseWeight = 150 + (Math.random() - 0.5) * 10;
        weightData.push(baseWeight);
      }

      analyticsCharts.progressChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Weekly Workouts',
              data: progressData,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              yAxisID: 'y',
              tension: 0.3
            },
            {
              label: 'Body Weight (lbs)',
              data: bodyMeasurements.length > 0 ? 
                bodyMeasurements.slice(-12).map(m => m.weight_lbs) : 
                weightData,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              yAxisID: 'y1',
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#fff'
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#fff'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              ticks: {
                color: '#fff'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              title: {
                display: true,
                text: 'Weekly Workouts',
                color: '#007bff'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              ticks: {
                color: '#fff'
              },
              grid: {
                drawOnChartArea: false,
              },
              title: {
                display: true,
                text: 'Weight (lbs)',
                color: '#28a745'
              }
            }
          }
        }
      });

      console.log('üìä Progress chart created');
    }

    // Refresh all analytics charts
    function refreshAnalyticsCharts() {
      console.log('üîÑ Refreshing analytics charts...');
      createWorkoutFrequencyChart();
      createExerciseCategoryChart();
      createProgressChart();
      showToast('Analytics updated! üìä', 'success');
    }

    // ========================================
    // ENHANCED PUSH NOTIFICATION SYSTEM
    // ========================================

    let notificationPermission = 'default';
    let notificationSettings = {
      enabled: false,
      reminderTime: '18:00',
      reminderDays: [1, 2, 3, 4, 5], // Mon-Fri default
      types: {
        workoutReminder: true,
        progressPhoto: true,
        measurements: true,
        hydration: true,
        motivation: true,
        achievements: true,
        streaks: true
      }
    };

    // Initialize push notifications
    async function initializePushNotifications() {
      console.log('üîî Initializing push notifications...');
      
      // Check if browser supports notifications
      if (!('Notification' in window)) {
        console.warn('This browser does not support desktop notification');
        return;
      }

      // Load saved settings
      loadEnhancedNotificationSettings();
      
      // Check current permission
      notificationPermission = Notification.permission;
      
      // Setup notification scheduler
      setupNotificationScheduler();
      
      // Setup workout completion notifications
      setupWorkoutCompletionNotifications();
      
      console.log('‚úÖ Push notifications initialized');
    }

    // Load enhanced notification settings
    function loadEnhancedNotificationSettings() {
      const saved = localStorage.getItem('enhancedNotificationSettings');
      if (saved) {
        notificationSettings = { ...notificationSettings, ...JSON.parse(saved) };
      }
    }

    // Save enhanced notification settings
    function saveEnhancedNotificationSettings() {
      localStorage.setItem('enhancedNotificationSettings', JSON.stringify(notificationSettings));
      showToast('Enhanced notification settings saved!', 'success');
    }

    // Request notification permission
    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        return 'denied';
      }
      
      if (Notification.permission === 'granted') {
        return 'granted';
      }
      
      const permission = await Notification.requestPermission();
      notificationPermission = permission;
      return permission;
    }

    // Setup notification scheduler
    function setupNotificationScheduler() {
      if (!notificationSettings.enabled || notificationPermission !== 'granted') {
        return;
      }
      
      // Schedule daily workout reminders
      if (notificationSettings.types.workoutReminder) {
        scheduleDailyWorkoutReminder();
      }
      
      // Schedule weekly progress photo reminders
      if (notificationSettings.types.progressPhoto) {
        scheduleProgressPhotoReminder();
      }
      
      // Schedule bi-weekly measurement reminders
      if (notificationSettings.types.measurements) {
        scheduleMeasurementReminder();
      }
      
      // Schedule hydration reminders
      if (notificationSettings.types.hydration) {
        scheduleHydrationReminders();
      }
      
      // Schedule motivation messages
      if (notificationSettings.types.motivation) {
        scheduleMotivationMessages();
      }
    }

    // Schedule daily workout reminder
    function scheduleDailyWorkoutReminder() {
      const [hours, minutes] = notificationSettings.reminderTime.split(':');
      const now = new Date();
      
      // Calculate next reminder time
      const nextReminder = new Date();
      nextReminder.setHours(parseInt(hours), parseInt(minutes), 0, 0);
      
      // If time has passed today, schedule for tomorrow
      if (nextReminder <= now) {
        nextReminder.setDate(nextReminder.getDate() + 1);
      }
      
      const delay = nextReminder.getTime() - now.getTime();
      
      setTimeout(() => {
        sendWorkoutReminderNotification();
        // Schedule next day
        setTimeout(() => scheduleDailyWorkoutReminder(), 24 * 60 * 60 * 1000);
      }, delay);
    }

    // Send workout reminder notification
    function sendWorkoutReminderNotification() {
      if (Notification.permission !== 'granted') return;
      
      const motivationalMessages = [
        "üí™ Time to crush your workout!",
        "üî• Your body is waiting for that workout!",
        "‚ö° Let's build some strength today!",
        "üèãÔ∏è Ready to make some gains?",
        "üéØ Consistency is key - let's go!",
        "üíØ Every workout counts - start now!",
        "üöÄ Transform your body, one rep at a time!",
        "‚≠ê Your future self will thank you!"
      ];
      
      const message = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
      
      const notification = new Notification('üèãÔ∏è Gymcyclopedia Workout Reminder', {
        body: message,
        icon: '/favicon.ico',
        tag: 'workout-reminder',
        requireInteraction: false
      });
      
      notification.onclick = () => {
        window.focus();
        notification.close();
      };
      
      // Auto-close after 10 seconds
      setTimeout(() => {
        notification.close();
      }, 10000);
    }

    // Schedule progress photo reminder
    function scheduleProgressPhotoReminder() {
      const now = new Date();
      const nextSunday = new Date(now);
      nextSunday.setDate(now.getDate() + (7 - now.getDay())); // Next Sunday
      nextSunday.setHours(10, 0, 0, 0); // 10 AM
      
      const delay = nextSunday.getTime() - now.getTime();
      
      setTimeout(() => {
        sendProgressPhotoReminder();
        // Schedule next week
        setTimeout(() => scheduleProgressPhotoReminder(), 7 * 24 * 60 * 60 * 1000);
      }, delay);
    }

    // Send progress photo reminder
    function sendProgressPhotoReminder() {
      if (Notification.permission !== 'granted') return;
      
      const notification = new Notification('üì∏ Progress Photo Reminder', {
        body: 'Time to take your weekly progress photo! Track your amazing transformation!',
        icon: '/favicon.ico',
        tag: 'progress-photo'
      });
      
      notification.onclick = () => {
        window.focus();
        document.getElementById('progress-tab').click();
        notification.close();
      };
    }

    // Schedule measurement reminder
    function scheduleMeasurementReminder() {
      const now = new Date();
      const nextMeasurement = new Date(now);
      nextMeasurement.setDate(now.getDate() + 14); // Every 2 weeks
      nextMeasurement.setHours(9, 0, 0, 0); // 9 AM
      
      const delay = nextMeasurement.getTime() - now.getTime();
      
      setTimeout(() => {
        sendMeasurementReminder();
        // Schedule next measurement
        setTimeout(() => scheduleMeasurementReminder(), 14 * 24 * 60 * 60 * 1000);
      }, delay);
    }

    // Send measurement reminder
    function sendMeasurementReminder() {
      if (Notification.permission !== 'granted') return;
      
      const notification = new Notification('üìè Measurement Reminder', {
        body: 'Time to update your body measurements! Track your progress over time!',
        icon: '/favicon.ico',
        tag: 'measurement'
      });
      
      notification.onclick = () => {
        window.focus();
        document.getElementById('progress-tab').click();
        notification.close();
      };
    }

    // Schedule hydration reminders
    function scheduleHydrationReminders() {
      const hours = [9, 11, 13, 15, 17, 19]; // Every 2 hours during active day
      
      hours.forEach(hour => {
        const now = new Date();
        const reminderTime = new Date();
        reminderTime.setHours(hour, 0, 0, 0);
        
        if (reminderTime <= now) {
          reminderTime.setDate(reminderTime.getDate() + 1);
        }
        
        const delay = reminderTime.getTime() - now.getTime();
        
        setTimeout(() => {
          sendHydrationReminder();
          // Schedule for next day
          setTimeout(() => scheduleHydrationReminders(), 24 * 60 * 60 * 1000);
        }, delay);
      });
    }

    // Send hydration reminder
    function sendHydrationReminder() {
      if (Notification.permission !== 'granted') return;
      
      const hydrationMessages = [
        "üíß Time to hydrate! Drink a glass of water!",
        "üö∞ Your body needs water - drink up!",
        "üí¶ Stay hydrated, stay strong!",
        "üåä Water break time! Keep those muscles hydrated!",
        "üíß Hydration checkpoint - drink some water!"
      ];
      
      const message = hydrationMessages[Math.floor(Math.random() * hydrationMessages.length)];
      
      const notification = new Notification('üíß Hydration Reminder', {
        body: message,
        icon: '/favicon.ico',
        tag: 'hydration'
      });
      
      notification.onclick = () => {
        window.focus();
        document.getElementById('nutrition-recovery-tab').click();
        notification.close();
      };
    }

    // Schedule motivation messages
    function scheduleMotivationMessages() {
      const now = new Date();
      const morningMotivation = new Date(now);
      morningMotivation.setHours(8, 0, 0, 0); // 8 AM
      
      if (morningMotivation <= now) {
        morningMotivation.setDate(morningMotivation.getDate() + 1);
      }
      
      const delay = morningMotivation.getTime() - now.getTime();
      
      setTimeout(() => {
        sendMotivationMessage();
        // Schedule next day
        setTimeout(() => scheduleMotivationMessages(), 24 * 60 * 60 * 1000);
      }, delay);
    }

    // Send motivation message
    function sendMotivationMessage() {
      if (Notification.permission !== 'granted') return;
      
      const motivationMessages = [
        "üåü You're capable of amazing things!",
        "üí™ Every day is a chance to get stronger!",
        "üî• Your dedication will pay off!",
        "‚ö° Push through your limits today!",
        "üèÜ Champions are made through consistency!",
        "üíØ Believe in yourself - you've got this!",
        "üöÄ Transform your life, one day at a time!",
        "‚≠ê Your only competition is yesterday's you!"
      ];
      
      const message = motivationMessages[Math.floor(Math.random() * motivationMessages.length)];
      
      const notification = new Notification('üåü Daily Motivation', {
        body: message,
        icon: '/favicon.ico',
        tag: 'motivation'
      });
      
      notification.onclick = () => {
        window.focus();
        notification.close();
      };
    }

    // Setup workout completion notifications
    function setupWorkoutCompletionNotifications() {
      // This would be called when a workout is completed
      // For now, we'll add hooks to existing workout completion functions
    }

    // Enhanced notification for workout completion
    function sendWorkoutCompletionNotification(workoutName, duration, exercises) {
      if (Notification.permission !== 'granted') return;
      
      const notification = new Notification('üéâ Workout Completed!', {
        body: `Amazing! You completed "${workoutName}" in ${duration} minutes with ${exercises} exercises!`,
        icon: '/favicon.ico',
        tag: 'workout-complete'
      });
      
      notification.onclick = () => {
        window.focus();
        document.getElementById('progress-tab').click();
        notification.close();
      };
    }

    // Achievement notification
    function sendAchievementNotification(achievement) {
      if (Notification.permission !== 'granted') return;
      
      const notification = new Notification('üèÜ Achievement Unlocked!', {
        body: `Congratulations! You've earned: ${achievement}`,
        icon: '/favicon.ico',
        tag: 'achievement'
      });
      
      notification.onclick = () => {
        window.focus();
        document.getElementById('progress-tab').click();
        notification.close();
      };
    }

    // Streak notification
    function sendStreakNotification(streak) {
      if (Notification.permission !== 'granted') return;
      
      const notification = new Notification('üî• Streak Achievement!', {
        body: `You're on fire! ${streak} day workout streak!`,
        icon: '/favicon.ico',
        tag: 'streak'
      });
      
      notification.onclick = () => {
        window.focus();
        document.getElementById('progress-tab').click();
        notification.close();
      };
    }

    // PR notification
    function sendPRNotification(exercise, newRecord) {
      if (Notification.permission !== 'granted') return;
      
      const notification = new Notification('üöÄ New Personal Record!', {
        body: `${exercise}: ${newRecord} - You're getting stronger!`,
        icon: '/favicon.ico',
        tag: 'personal-record'
      });
      
      notification.onclick = () => {
        window.focus();
        document.getElementById('progress-tab').click();
        notification.close();
      };
    }

    // Test notification function
    function testNotification() {
      if (Notification.permission !== 'granted') {
        requestNotificationPermission().then(permission => {
          if (permission === 'granted') {
            sendTestNotification();
          } else {
            showToast('Please enable notifications in your browser settings', 'warning');
          }
        });
      } else {
        sendTestNotification();
      }
    }

    // Send test notification
    function sendTestNotification() {
      const notification = new Notification('üß™ Test Notification', {
        body: 'This is a test notification from Gymcyclopedia! Your notifications are working perfectly!',
        icon: '/favicon.ico',
        tag: 'test-notification'
      });
      
      notification.onclick = () => {
        window.focus();
        notification.close();
      };
      
      showToast('Test notification sent!', 'success');
    }

    // Clear all notifications
    function clearAllNotifications() {
      showToast('All notifications cleared!', 'info');
    }

    // Enhanced notification settings save
    function saveNotificationSettings() {
      const settings = {
        dailyWorkoutReminder: document.getElementById('dailyWorkoutReminder').checked,
        restDayReminder: document.getElementById('restDayReminder').checked,
        motivationMessages: document.getElementById('motivationMessages').checked,
        streakReminders: document.getElementById('streakReminders').checked,
        prCelebrations: document.getElementById('prCelebrations').checked,
        progressPhotoReminder: document.getElementById('progressPhotoReminder').checked,
        measurementReminder: document.getElementById('measurementReminder').checked,
        hydrationReminder: document.getElementById('hydrationReminder').checked,
        mealPlanReminder: document.getElementById('mealPlanReminder').checked,
        workoutTime: document.getElementById('workoutTime').value
      };
      
      localStorage.setItem('notificationSettings', JSON.stringify(settings));
      
      // Update enhanced settings
      notificationSettings.enabled = settings.dailyWorkoutReminder;
      notificationSettings.reminderTime = settings.workoutTime;
      notificationSettings.types = {
        workoutReminder: settings.dailyWorkoutReminder,
        progressPhoto: settings.progressPhotoReminder,
        measurements: settings.measurementReminder,
        hydration: settings.hydrationReminder,
        motivation: settings.motivationMessages,
        achievements: settings.prCelebrations,
        streaks: settings.streakReminders
      };
      
      saveEnhancedNotificationSettings();
      showToast('Notification settings saved! üîî', 'success');
      
      // Request permission if needed
      if (notificationSettings.enabled && Notification.permission !== 'granted') {
        requestNotificationPermission().then(permission => {
          if (permission === 'granted') {
            setupNotificationScheduler();
          }
        });
      } else if (notificationSettings.enabled) {
        setupNotificationScheduler();
      }
    }

  </script>
</body>
</html> 