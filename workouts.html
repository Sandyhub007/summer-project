<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Workouts | Gymcyclopedia</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts: Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JavaScript Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Base styles matching the main app */
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Poppins', 'Inter', sans-serif;
      font-weight: 400;
      letter-spacing: 0.3px;
      background-color: #000;
      color: #fff;
    }

    /* Navbar styling */
    .navbar-brand {
      font-size: 1.4rem;
      letter-spacing: 2px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .navbar-dark .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }
    .navbar-dark .navbar-nav .nav-link:hover,
    .navbar-dark .navbar-nav .nav-link.active {
      color: #fff;
    }

    /* Card styling */
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.1);
    }

    /* Button styling */
    .btn-primary {
      background: linear-gradient(45deg, #007bff, #00d4ff);
      border: none;
      font-weight: 600;
      letter-spacing: 0.5px;
      padding: 0.75rem 1.5rem;
    }

    .btn-outline-light {
      border: 2px solid rgba(255, 255, 255, 0.3);
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-light:hover {
      background-color: #fff;
      color: #000;
      transform: translateY(-2px);
    }

    /* Exercise cards */
    .exercise-card {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .exercise-card:hover {
      border-color: #007bff;
      box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
    }

    .exercise-card.selected {
      border-color: #007bff;
      background: rgba(0, 123, 255, 0.1);
    }

    /* Modal styling */
    .modal-content {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .form-control, .form-select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      border-radius: 8px;
    }

    .form-control:focus, .form-select:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      color: #fff;
    }

    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Tab styling */
    .nav-tabs {
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .nav-tabs .nav-link {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 600;
      padding: 1rem 1.5rem;
    }

    .nav-tabs .nav-link.active {
      background: rgba(0, 123, 255, 0.2);
      color: #fff;
      border-bottom: 3px solid #007bff;
    }

    /* Workout session styling */
    .workout-session {
      background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 212, 255, 0.1));
      border-left: 4px solid #007bff;
    }

    /* Exercise category badges */
    .category-badge {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .category-badge:hover,
    .category-badge.active {
      background: #007bff;
      border-color: #007bff;
      color: #fff;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

    /* Loading state */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Stats styling */
    .stat-card {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
      border-left: 4px solid #28a745;
    }

    .progress {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      height: 8px;
    }

    .progress-bar {
      background: linear-gradient(45deg, #28a745, #20c997);
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-transparent py-3 border-bottom border-secondary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">GYMCYCLOPEDIA</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
        <ul class="navbar-nav mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="/workouts.html">Workouts</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Blog</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Support</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
        </ul>
      </div>

      <div class="d-none d-lg-flex">
        <span class="navbar-text me-3">Welcome, <span id="user-name">User</span></span>
        <button id="logoutBtn" class="btn btn-outline-light">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-lg-8">
        <h1 class="display-5 fw-bold mb-2">üí™ Workout Central</h1>
        <p class="lead text-muted">Create, track, and conquer your fitness goals</p>
      </div>
      <div class="col-lg-4 text-lg-end">
        <button class="btn btn-primary btn-lg me-2" data-bs-toggle="modal" data-bs-target="#createWorkoutModal">
          ‚ûï Create Workout
        </button>
        <button class="btn btn-outline-light" onclick="showStats()">
          üìä Stats
        </button>
      </div>
    </div>

    <!-- Workout Tabs -->
    <ul class="nav nav-tabs mb-4" id="workoutTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="library-tab" data-bs-toggle="tab" data-bs-target="#library" type="button">
          üèãÔ∏è Exercise Library
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="workouts-tab" data-bs-toggle="tab" data-bs-target="#workouts" type="button">
          üìù My Workouts
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">
          üìà Workout History
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="workoutTabContent">
      <!-- Exercise Library Tab -->
      <div class="tab-pane fade show active" id="library" role="tabpanel">
        <!-- Category Filter -->
        <div class="row mb-4">
          <div class="col-12">
            <h5 class="mb-3">Filter by Category:</h5>
            <div class="d-flex flex-wrap gap-2" id="categoryFilter">
              <span class="category-badge active" data-category="all">All</span>
              <span class="category-badge" data-category="chest">Chest</span>
              <span class="category-badge" data-category="back">Back</span>
              <span class="category-badge" data-category="shoulders">Shoulders</span>
              <span class="category-badge" data-category="arms">Arms</span>
              <span class="category-badge" data-category="legs">Legs</span>
              <span class="category-badge" data-category="core">Core</span>
              <span class="category-badge" data-category="cardio">Cardio</span>
            </div>
          </div>
        </div>

        <!-- Exercise Cards -->
        <div class="row" id="exerciseLibrary">
          <!-- Exercises will be populated by JavaScript -->
        </div>
      </div>

      <!-- My Workouts Tab -->
      <div class="tab-pane fade" id="workouts" role="tabpanel">
        <div class="row" id="myWorkouts">
          <div class="col-12 text-center">
            <p class="text-muted">No workouts created yet. Click "Create Workout" to get started!</p>
          </div>
        </div>
      </div>

      <!-- Workout History Tab -->
      <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="row" id="workoutHistory">
          <div class="col-12 text-center">
            <p class="text-muted">No workout history yet. Complete some workouts to see your progress!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Workout Modal -->
  <div class="modal fade" id="createWorkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üèãÔ∏è Create New Workout</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createWorkoutForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Workout Name</label>
                <input type="text" class="form-control" id="workoutName" placeholder="e.g., Push Day" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" id="workoutCategory" required>
                  <option value="">Select category</option>
                  <option value="push">Push (Chest, Shoulders, Triceps)</option>
                  <option value="pull">Pull (Back, Biceps)</option>
                  <option value="legs">Legs</option>
                  <option value="upper">Upper Body</option>
                  <option value="lower">Lower Body</option>
                  <option value="full">Full Body</option>
                  <option value="cardio">Cardio</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Description (Optional)</label>
              <textarea class="form-control" id="workoutDescription" rows="2" placeholder="Brief description of this workout"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Select Exercises</label>
              <div id="exerciseSelection" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                <!-- Exercise selection will be populated here -->
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveWorkoutBtn">üíæ Save Workout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Workout Session Modal -->
  <div class="modal fade" id="workoutSessionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üèãÔ∏è <span id="sessionWorkoutName">Workout Session</span></h5>
          <div class="d-flex align-items-center">
            <span class="badge bg-success me-2">‚è±Ô∏è <span id="sessionTimer">00:00</span></span>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
        </div>
        <div class="modal-body">
          <div id="sessionExercises">
            <!-- Session exercises will be populated here -->
          </div>
          <div class="text-center mt-4">
            <button class="btn btn-success btn-lg" id="completeWorkoutBtn" onclick="completeCurrentSession()">
              ‚úÖ Complete Workout
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://stojhqobywrvkjaabcvq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0b2pocW9ieXdydmtqYWFiY3ZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyMDcwMDEsImV4cCI6MjA2NTc4MzAwMX0.JQeFsT3nUFMpQ1Tz9uYBnZ3IuE_gBK9P9Du0Igo7Hsg';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global variables
    let currentUser = null;
    let exerciseLibrary = [];
    let userWorkouts = [];
    let workoutHistory = [];
    let currentSession = null;
    let sessionTimer = null;
    let sessionStartTime = null;

    // Initialize the page
    window.addEventListener('DOMContentLoaded', async () => {
      await checkAuthStatus();
      await loadExerciseLibrary();
      await loadUserWorkouts();
      await loadWorkoutHistory();
      populateExerciseLibrary();
      populateExerciseSelection();
      setupEventListeners();
    });

    // Check if user is authenticated
    async function checkAuthStatus() {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session || !session.user) {
        console.log('‚ùå No authentication session found, redirecting to home');
        window.location.href = '/';
        return;
      }

      console.log('‚úÖ User authenticated:', session.user.email);

      try {
        // Try to get user profile
        const { data: profile, error } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', session.user.id)
          .single();

        if (profile) {
          currentUser = profile;
          document.getElementById('user-name').textContent = profile.name || session.user.email.split('@')[0];
          console.log('‚úÖ User profile loaded:', profile.name);
        } else {
          // Profile doesn't exist or failed to load, but user is authenticated
          currentUser = {
            id: session.user.id,
            email: session.user.email,
            name: session.user.email.split('@')[0]
          };
          document.getElementById('user-name').textContent = currentUser.name;
          console.log('‚ö†Ô∏è No user profile found, using session data');
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
        
        // Use session data as fallback
        currentUser = {
          id: session.user.id,
          email: session.user.email,
          name: session.user.email.split('@')[0]
        };
        document.getElementById('user-name').textContent = currentUser.name;
      }
    }

    // Fallback exercise library (in case database isn't set up yet)
    const fallbackExercises = [
      // Chest
      { id: 1, name: "Push-ups", category: "chest", description: "Classic bodyweight chest exercise", equipment: "None", difficulty: "Beginner" },
      { id: 2, name: "Bench Press", category: "chest", description: "Barbell chest press", equipment: "Barbell", difficulty: "Intermediate" },
      { id: 3, name: "Dumbbell Flyes", category: "chest", description: "Chest isolation exercise", equipment: "Dumbbells", difficulty: "Intermediate" },
      
      // Back
      { id: 4, name: "Pull-ups", category: "back", description: "Upper body pulling exercise", equipment: "Pull-up Bar", difficulty: "Intermediate" },
      { id: 5, name: "Deadlifts", category: "back", description: "Compound pulling movement", equipment: "Barbell", difficulty: "Advanced" },
      { id: 6, name: "Bent-over Rows", category: "back", description: "Horizontal pulling exercise", equipment: "Barbell", difficulty: "Intermediate" },
      
      // Shoulders
      { id: 7, name: "Overhead Press", category: "shoulders", description: "Vertical pressing movement", equipment: "Barbell", difficulty: "Intermediate" },
      { id: 8, name: "Lateral Raises", category: "shoulders", description: "Side deltoid isolation", equipment: "Dumbbells", difficulty: "Beginner" },
      { id: 9, name: "Face Pulls", category: "shoulders", description: "Rear deltoid exercise", equipment: "Cable", difficulty: "Beginner" },
      
      // Arms
      { id: 10, name: "Bicep Curls", category: "arms", description: "Bicep isolation exercise", equipment: "Dumbbells", difficulty: "Beginner" },
      { id: 11, name: "Tricep Dips", category: "arms", description: "Tricep bodyweight exercise", equipment: "Bench", difficulty: "Intermediate" },
      { id: 12, name: "Hammer Curls", category: "arms", description: "Neutral grip bicep curls", equipment: "Dumbbells", difficulty: "Beginner" },
      
      // Legs
      { id: 13, name: "Squats", category: "legs", description: "Fundamental leg exercise", equipment: "Bodyweight/Barbell", difficulty: "Beginner" },
      { id: 14, name: "Lunges", category: "legs", description: "Unilateral leg exercise", equipment: "Bodyweight/Dumbbells", difficulty: "Beginner" },
      { id: 15, name: "Romanian Deadlifts", category: "legs", description: "Hip hinge movement", equipment: "Barbell", difficulty: "Intermediate" },
      
      // Core
      { id: 16, name: "Plank", category: "core", description: "Isometric core exercise", equipment: "None", difficulty: "Beginner" },
      { id: 17, name: "Russian Twists", category: "core", description: "Rotational core exercise", equipment: "Medicine Ball", difficulty: "Beginner" },
      { id: 18, name: "Mountain Climbers", category: "core", description: "Dynamic core exercise", equipment: "None", difficulty: "Intermediate" },
      
      // Cardio
      { id: 19, name: "Burpees", category: "cardio", description: "Full body cardio exercise", equipment: "None", difficulty: "Intermediate" },
      { id: 20, name: "Jumping Jacks", category: "cardio", description: "Basic cardio movement", equipment: "None", difficulty: "Beginner" },
      { id: 21, name: "High Knees", category: "cardio", description: "Running in place variation", equipment: "None", difficulty: "Beginner" }
    ];

    // Load exercise library from database
    async function loadExerciseLibrary() {
      try {
        const { data, error } = await supabase
          .from('exercises')
          .select('*')
          .order('category, name');
        
        if (error) {
          console.warn('Database not set up yet, using fallback exercises:', error.message);
          exerciseLibrary = fallbackExercises;
          showToast('Using offline exercise library. Run the SQL schema to enable full database features.', 'info');
          return;
        }
        
        if (data && data.length > 0) {
          exerciseLibrary = data;
          console.log('üìö Loaded exercise library from database:', exerciseLibrary.length, 'exercises');
        } else {
          console.warn('No exercises found in database, using fallback');
          exerciseLibrary = fallbackExercises;
          showToast('Exercise library empty. Using default exercises.', 'info');
        }
        
      } catch (error) {
        console.error('Error loading exercises, using fallback:', error);
        exerciseLibrary = fallbackExercises;
        showToast('Using offline exercise library. Check your database connection.', 'warning');
      }
    }

    // Load user's workouts from database
    async function loadUserWorkouts() {
      // Check authentication first
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        console.warn('No user session found when loading workouts');
        userWorkouts = [];
        populateMyWorkouts();
        return;
      }

      const userId = session.user.id;
      console.log('üìö Loading workouts for user:', userId);
      
      try {
        // Try to load from workout_details view first (includes exercise data)
        const { data: detailedWorkouts, error: detailsError } = await supabase
          .from('workout_details')
          .select('*')
          .eq('user_id', userId)
          .eq('is_active', true)
          .order('created_at', { ascending: false });
        
        if (!detailsError && detailedWorkouts) {
          userWorkouts = detailedWorkouts;
          console.log('‚úÖ Loaded workouts from workout_details view:', userWorkouts.length, 'workouts');
        } else {
          // Fallback: load basic workout data and exercise count separately
          const { data: basicWorkouts, error: basicError } = await supabase
            .from('workouts')
            .select(`
              *,
              workout_exercises(count)
            `)
            .eq('user_id', userId)
            .eq('is_active', true)
            .order('created_at', { ascending: false });

          if (basicError) throw basicError;

          userWorkouts = basicWorkouts.map(workout => ({
            ...workout,
            exercise_count: workout.workout_exercises?.[0]?.count || 0,
            exercises: [] // Will be loaded when needed
          }));
          
          console.log('‚úÖ Loaded basic workouts from workouts table:', userWorkouts.length, 'workouts');
        }
        
        populateMyWorkouts();
        
      } catch (error) {
        console.error('Error loading workouts from database:', error);
        
        if (error.message.includes('relation') && error.message.includes('does not exist')) {
          showToast('Database tables not found. Please apply the SQL schema first.', 'error');
          userWorkouts = [];
        } else if (error.message.includes('permission denied') || error.message.includes('RLS')) {
          showToast('Permission denied loading workouts. Please log in again.', 'error');
          userWorkouts = [];
        } else {
          showToast('Failed to load workouts from database.', 'error');
          userWorkouts = [];
        }
        
        populateMyWorkouts();
      }
    }

    // Load workout history from database
    async function loadWorkoutHistory() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabase
          .from('workout_history')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('start_time', { ascending: false })
          .limit(20);
        
        if (error) throw error;
        
        workoutHistory = data || [];
        console.log('üìà Loaded workout history:', workoutHistory.length, 'sessions');
        populateWorkoutHistory();
      } catch (error) {
        console.error('Error loading workout history:', error);
        showToast('Failed to load workout history', 'error');
      }
    }

    // Populate exercise library
    function populateExerciseLibrary(filter = 'all') {
      const container = document.getElementById('exerciseLibrary');
      const filteredExercises = filter === 'all' 
        ? exerciseLibrary 
        : exerciseLibrary.filter(ex => ex.category === filter);

      if (filteredExercises.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-muted">No exercises found for this category.</p></div>';
        return;
      }

      container.innerHTML = filteredExercises.map(exercise => `
        <div class="col-md-6 col-lg-4 mb-4 fade-in-up">
          <div class="card exercise-card h-100">
            <div class="card-body">
              <h6 class="card-title fw-bold">${exercise.name}</h6>
              <p class="card-text small text-muted">${exercise.description}</p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-primary">${exercise.category}</span>
                <small class="text-muted">${exercise.difficulty}</small>
              </div>
              <div class="mb-3">
                <small class="text-info">Equipment: ${exercise.equipment}</small>
              </div>
              <button class="btn btn-outline-light btn-sm w-100" onclick="showExerciseDetails(${exercise.id})">
                üìã View Details
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Populate my workouts tab
    function populateMyWorkouts() {
      const container = document.getElementById('myWorkouts');
      
      if (userWorkouts.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-muted">No workouts created yet. Click "Create Workout" to get started!</p></div>';
        return;
      }

      container.innerHTML = userWorkouts.map(workout => `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title fw-bold">${workout.name}</h6>
              <p class="card-text small text-muted">${workout.description || 'No description'}</p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-secondary">${workout.category}</span>
                <small class="text-muted">${workout.exercise_count} exercises</small>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm flex-fill" onclick="startWorkout('${workout.id}')">
                  üöÄ Start Workout
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="editWorkout('${workout.id}')">
                  ‚úèÔ∏è
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteWorkout('${workout.id}')">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Populate workout history tab
    function populateWorkoutHistory() {
      const container = document.getElementById('workoutHistory');
      
      if (workoutHistory.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p class="text-muted">No workout history yet. Complete some workouts to see your progress!</p></div>';
        return;
      }

      container.innerHTML = workoutHistory.map(session => `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title fw-bold">${session.workout_name}</h6>
              <p class="card-text small text-muted">
                ${new Date(session.start_time).toLocaleDateString()} at ${new Date(session.start_time).toLocaleTimeString()}
              </p>
              <div class="row text-center">
                <div class="col-6">
                  <small class="text-muted">Duration</small>
                  <div class="fw-bold">${session.duration_minutes || 0} min</div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Rating</small>
                  <div class="fw-bold">${'‚≠ê'.repeat(session.rating || 0)}</div>
                </div>
              </div>
              <div class="mt-2">
                <div class="progress" style="height: 6px;">
                  <div class="progress-bar" style="width: ${(session.exercises_finished / Math.max(session.exercises_completed, 1)) * 100}%"></div>
                </div>
                <small class="text-muted">${session.exercises_finished}/${session.exercises_completed} exercises completed</small>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Populate exercise selection for workout creation
    function populateExerciseSelection() {
      const container = document.getElementById('exerciseSelection');
      container.innerHTML = exerciseLibrary.map(exercise => `
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" value="${exercise.id}" id="exercise-${exercise.id}">
          <label class="form-check-label" for="exercise-${exercise.id}">
            <strong>${exercise.name}</strong> - ${exercise.category}
            <small class="text-muted d-block">${exercise.description}</small>
          </label>
        </div>
      `).join('');
    }

    // Setup event listeners
    function setupEventListeners() {
      // Category filter
      document.querySelectorAll('.category-badge').forEach(badge => {
        badge.addEventListener('click', (e) => {
          document.querySelectorAll('.category-badge').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          populateExerciseLibrary(e.target.dataset.category);
        });
      });

      // Save workout button
      document.getElementById('saveWorkoutBtn').addEventListener('click', saveWorkout);

      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = '/';
      });
    }

    // Show exercise details
    function showExerciseDetails(exerciseId) {
      const exercise = exerciseLibrary.find(ex => ex.id === exerciseId);
      if (exercise) {
        alert(`${exercise.name}\n\nCategory: ${exercise.category}\nDifficulty: ${exercise.difficulty}\nEquipment: ${exercise.equipment}\n\nDescription: ${exercise.description}`);
      }
    }

    // Save workout to database
    async function saveWorkout() {
      const name = document.getElementById('workoutName').value.trim();
      const category = document.getElementById('workoutCategory').value;
      const description = document.getElementById('workoutDescription').value.trim();
      
      const selectedCheckboxes = document.querySelectorAll('#exerciseSelection input:checked');
      const exerciseIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
      
      // Validation
      if (!name || !category || exerciseIds.length === 0) {
        showToast('Please fill in all required fields and select at least one exercise.', 'error');
        return;
      }

      // Check authentication
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        showToast('Please log in to save workouts.', 'error');
        window.location.href = '/';
        return;
      }

      const userId = session.user.id;
      console.log('üíæ Saving workout for user:', userId, 'Workout:', name, 'Exercises:', exerciseIds);

      try {
        // First, create the workout
        const { data: workout, error: workoutError } = await supabase
          .from('workouts')
          .insert({
            user_id: userId,
            name: name,
            category: category,
            description: description || null,
            is_active: true
          })
          .select()
          .single();

        if (workoutError) {
          console.error('Error creating workout:', workoutError);
          
          // Check if it's a schema issue
          if (workoutError.message.includes('relation') && workoutError.message.includes('does not exist')) {
            showToast('Database not set up! Please run the SQL schema in Supabase first.', 'error');
            return;
          }
          
          throw workoutError;
        }

        console.log('‚úÖ Workout created:', workout);

        // Then, add the exercises to the workout
        const workoutExercises = exerciseIds.map((exerciseId, index) => ({
          workout_id: workout.id,
          exercise_id: exerciseId,
          exercise_order: index + 1,
          sets: 3, // Default values - can be customized later
          reps: '10', // Default reps
          weight_kg: null, // Will be set during workout
          rest_seconds: 60, // Default rest time
          notes: null
        }));

        const { error: exercisesError } = await supabase
          .from('workout_exercises')
          .insert(workoutExercises);

        if (exercisesError) {
          console.error('Error adding exercises to workout:', exercisesError);
          
          // Cleanup: delete the workout if exercises failed to save
          await supabase.from('workouts').delete().eq('id', workout.id);
          
          throw exercisesError;
        }

        console.log('‚úÖ Workout exercises added:', workoutExercises.length, 'exercises');

        showToast(`Workout "${name}" created successfully! üéâ`, 'success');
        
        // Reload user workouts to show the new one
        await loadUserWorkouts();

        // Success! Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('createWorkoutModal'));
        modal.hide();
        document.getElementById('createWorkoutForm').reset();
        selectedCheckboxes.forEach(cb => cb.checked = false);
        
      } catch (error) {
        console.error('Error saving workout:', error);
        
        if (error.message.includes('permission denied') || error.message.includes('RLS')) {
          showToast('Permission denied. Please make sure you are logged in.', 'error');
        } else if (error.message.includes('relation') && error.message.includes('does not exist')) {
          showToast('Database tables not found. Please apply the SQL schema first.', 'error');
        } else {
          showToast(`Error saving workout: ${error.message}`, 'error');
        }
      }
    }

    // Start a workout session
    async function startWorkout(workoutId) {
      try {
        const workout = userWorkouts.find(w => w.id === workoutId);
        if (!workout) {
          showToast('Workout not found', 'error');
          return;
        }

        // Get workout details with exercises
        const { data: workoutDetails, error: detailsError } = await supabase
          .from('workout_details')
          .select('*')
          .eq('id', workoutId)
          .single();

        if (detailsError) {
          // Fallback to local workout data
          const localWorkout = workout;
          currentSession = {
            workout: localWorkout,
            exercises: localWorkout.exercises || [],
            isLocal: true
          };
        } else {
          // Create a new workout session in database
          const { data: session, error } = await supabase
            .from('workout_sessions')
            .insert({
              user_id: currentUser.id,
              workout_id: workoutId,
              workout_name: workout.name,
              start_time: new Date().toISOString()
            })
            .select()
            .single();

          if (error) throw error;

          currentSession = {
            id: session.id,
            workout: workoutDetails,
            exercises: workoutDetails.exercises || [],
            isLocal: false
          };
        }

        // Start the session UI
        startSessionTimer();
        showSessionModal();
        showToast(`Started "${workout.name}" workout!`, 'success');

      } catch (error) {
        console.error('Error starting workout:', error);
        showToast('Error starting workout', 'error');
      }
    }

    // Show session modal with exercises
    function showSessionModal() {
      if (!currentSession) return;

      document.getElementById('sessionWorkoutName').textContent = currentSession.workout.name;
      
      const container = document.getElementById('sessionExercises');
      container.innerHTML = currentSession.exercises.map((exercise, index) => `
        <div class="card mb-3">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-4">
                <h6 class="mb-1">${exercise.exercise_name || exercise.name}</h6>
                <small class="text-muted">${exercise.category || ''}</small>
              </div>
              <div class="col-md-8">
                <div class="row">
                  <div class="col-4">
                    <label class="form-label small">Sets</label>
                    <input type="number" class="form-control form-control-sm" value="${exercise.sets || 3}" id="sets-${index}">
                  </div>
                  <div class="col-4">
                    <label class="form-label small">Reps</label>
                    <input type="text" class="form-control form-control-sm" value="${exercise.reps || '10'}" id="reps-${index}">
                  </div>
                  <div class="col-4">
                    <label class="form-label small">Weight (kg)</label>
                    <input type="number" class="form-control form-control-sm" step="0.5" value="${exercise.weight_kg || ''}" id="weight-${index}">
                  </div>
                </div>
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-success" onclick="markExerciseComplete(${index})">
                    ‚úÖ Complete
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      const modal = new bootstrap.Modal(document.getElementById('workoutSessionModal'));
      modal.show();
    }

    // Start session timer
    function startSessionTimer() {
      sessionStartTime = new Date();
      sessionTimer = setInterval(() => {
        const elapsed = Math.floor((new Date() - sessionStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('sessionTimer').textContent = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // Mark exercise as complete
    function markExerciseComplete(exerciseIndex) {
      const exerciseCard = document.querySelector(`#sessionExercises .card:nth-child(${exerciseIndex + 1})`);
      exerciseCard.style.opacity = '0.6';
      exerciseCard.style.border = '2px solid #28a745';
      
      const completeBtn = exerciseCard.querySelector('button');
      completeBtn.textContent = '‚úÖ Completed';
      completeBtn.disabled = true;
      completeBtn.classList.remove('btn-outline-success');
      completeBtn.classList.add('btn-success');
      
      showToast('Exercise completed! üí™', 'success');
    }

    // Complete current session
    async function completeCurrentSession() {
      if (!currentSession) return;

      try {
        const endTime = new Date();
        const durationMinutes = Math.floor((endTime - sessionStartTime) / 60000);

        if (!currentSession.isLocal && currentSession.id) {
          // Update session in database
          const { error } = await supabase
            .from('workout_sessions')
            .update({
              end_time: endTime.toISOString(),
              duration_minutes: durationMinutes,
              completed: true,
              rating: 4 // Default rating - could be made interactive
            })
            .eq('id', currentSession.id);

          if (error) throw error;
        }

        // Stop timer
        if (sessionTimer) {
          clearInterval(sessionTimer);
          sessionTimer = null;
        }

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('workoutSessionModal'));
        modal.hide();

        // Reset session
        currentSession = null;
        sessionStartTime = null;

        showToast(`Workout completed! Duration: ${durationMinutes} minutes üéâ`, 'success');
        
        // Reload workout history
        await loadWorkoutHistory();

      } catch (error) {
        console.error('Error completing workout:', error);
        showToast('Error completing workout', 'error');
      }
    }

    // Complete a workout session
    async function completeWorkout(sessionId, workoutName) {
      try {
        const endTime = new Date();
        const { error } = await supabase
          .from('workout_sessions')
          .update({
            end_time: endTime.toISOString(),
            duration_minutes: 5, // Simulated duration
            completed: true,
            rating: 4 // Simulated rating
          })
          .eq('id', sessionId);

        if (error) throw error;

        showToast(`Completed "${workoutName}"! Great job! üéâ`, 'success');
        
        // Reload workout history
        await loadWorkoutHistory();

      } catch (error) {
        console.error('Error completing workout:', error);
        showToast('Error completing workout', 'error');
      }
    }

    // Edit workout (placeholder)
    function editWorkout(workoutId) {
      showToast('Edit workout feature coming soon!', 'info');
    }

    // Delete workout
    async function deleteWorkout(workoutId) {
      if (!confirm('Are you sure you want to delete this workout?')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('workouts')
          .update({ is_active: false })
          .eq('id', workoutId);

        if (error) throw error;

        showToast('Workout deleted successfully', 'success');
        await loadUserWorkouts();

      } catch (error) {
        console.error('Error deleting workout:', error);
        showToast('Error deleting workout', 'error');
      }
    }

    // Show stats
    async function showStats() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabase.rpc('get_user_workout_stats', { 
          user_uuid: currentUser.id 
        });
        
        if (error) throw error;
        
        const stats = data || {};
        alert(`Workout Stats:\n\nüìä Total Workouts: ${stats.total_workouts || 0}\nüî• This Week: ${stats.this_week_workouts || 0}\nüèÜ Total Sessions: ${stats.total_sessions || 0}\n‚≠ê Average Rating: ${(stats.avg_rating || 0).toFixed(1)}/5\nüí™ Favorite Category: ${stats.favorite_category || 'none'}\n\nKeep working out to see your progress!`);
        
      } catch (error) {
        console.error('Error loading stats:', error);
        alert('Workout Stats:\n\nüìä Total Workouts: 0\nüî• This Week: 0\nüí™ Favorite Exercise: Coming Soon!\n\nKeep working out to see your progress!');
      }
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
      toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
      toast.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span>${message}</span>
          <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      // Auto-remove after 4 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 4000);
    }

    console.log('üí™ Workout page loaded successfully!');
  </script>
</body>
</html> 